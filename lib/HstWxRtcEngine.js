module.exports=function(e){var t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(i,r,function(t){return e[t]}.bind(null,r));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=6)}([function(e,t){e.exports=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}},function(e,t){function n(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}e.exports=function(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}},function(e,t){e.exports=function(e,t,n,i,r){var o={};return Object.keys(i).forEach((function(e){o[e]=i[e]})),o.enumerable=!!o.enumerable,o.configurable=!!o.configurable,("value"in o||o.initializer)&&(o.writable=!0),o=n.slice().reverse().reduce((function(n,i){return i(e,t,n)||n}),o),r&&void 0!==o.initializer&&(o.value=o.initializer?o.initializer.call(r):void 0,o.initializer=void 0),void 0===o.initializer&&(Object.defineProperty(e,t,o),o=null),o}},function(e,t){e.exports=function(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}},function(e,t,n){var i;i=function(){return function(e){var t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.i=function(e){return e},n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:i})},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=5)}([function(e,t,n){"use strict";e.exports=function(e,t){var n,i,r;for(n=1;n<arguments.length;n++)for(r in i=arguments[n])i.hasOwnProperty(r)&&(e[r]=i[r]);return e}},function(e,t,n){"use strict";var i=n(0);e.exports={build:function(e,t){var n,r,o,s=t.plugins;for(n=0,r=s.length;n<r;n++)(o=s[n]).methods&&i(e,o.methods),o.properties&&Object.defineProperties(e,o.properties)},hook:function(e,t,n){var i,r,o,s,a=e.config.plugins,u=[e.context];for(n&&(u=u.concat(n)),i=0,r=a.length;i<r;i++)s=a[i],(o=a[i][t])&&o.apply(s,u)}}},function(e,t,n){"use strict";function i(e){if(0===e.length)return e;var t,n,i=e.split(/[_-]/);if(1===i.length&&i[0][0].toLowerCase()===i[0][0])return e;for(n=i[0].toLowerCase(),t=1;t<i.length;t++)n=n+i[t].charAt(0).toUpperCase()+i[t].substring(1).toLowerCase();return n}i.prepended=function(e,t){return e+(t=i(t))[0].toUpperCase()+t.substring(1)},e.exports=i},function(e,t,n){"use strict";var i=n(0),r=n(2);function o(e,t){e=e||{},this.options=e,this.defaults=t.defaults,this.states=[],this.transitions=[],this.map={},this.lifecycle=this.configureLifecycle(),this.init=this.configureInitTransition(e.init),this.data=this.configureData(e.data),this.methods=this.configureMethods(e.methods),this.map[this.defaults.wildcard]={},this.configureTransitions(e.transitions||[]),this.plugins=this.configurePlugins(e.plugins,t.plugin)}i(o.prototype,{addState:function(e){this.map[e]||(this.states.push(e),this.addStateLifecycleNames(e),this.map[e]={})},addStateLifecycleNames:function(e){this.lifecycle.onEnter[e]=r.prepended("onEnter",e),this.lifecycle.onLeave[e]=r.prepended("onLeave",e),this.lifecycle.on[e]=r.prepended("on",e)},addTransition:function(e){this.transitions.indexOf(e)<0&&(this.transitions.push(e),this.addTransitionLifecycleNames(e))},addTransitionLifecycleNames:function(e){this.lifecycle.onBefore[e]=r.prepended("onBefore",e),this.lifecycle.onAfter[e]=r.prepended("onAfter",e),this.lifecycle.on[e]=r.prepended("on",e)},mapTransition:function(e){var t=e.name,n=e.from,i=e.to;return this.addState(n),"function"!=typeof i&&this.addState(i),this.addTransition(t),this.map[n][t]=e,e},configureLifecycle:function(){return{onBefore:{transition:"onBeforeTransition"},onAfter:{transition:"onAfterTransition"},onEnter:{state:"onEnterState"},onLeave:{state:"onLeaveState"},on:{transition:"onTransition"}}},configureInitTransition:function(e){return"string"==typeof e?this.mapTransition(i({},this.defaults.init,{to:e,active:!0})):"object"==typeof e?this.mapTransition(i({},this.defaults.init,e,{active:!0})):(this.addState(this.defaults.init.from),this.defaults.init)},configureData:function(e){return"function"==typeof e?e:"object"==typeof e?function(){return e}:function(){return{}}},configureMethods:function(e){return e||{}},configurePlugins:function(e,t){var n,i,r;for(n=0,i=(e=e||[]).length;n<i;n++)"function"==typeof(r=e[n])&&(e[n]=r=r()),r.configure&&r.configure(this);return e},configureTransitions:function(e){var t,n,i,r,o,s=this.defaults.wildcard;for(n=0;n<e.length;n++)for(i=e[n],r=Array.isArray(i.from)?i.from:[i.from||s],o=i.to||s,t=0;t<r.length;t++)this.mapTransition({name:i.name,from:r[t],to:o})},transitionFor:function(e,t){var n=this.defaults.wildcard;return this.map[e][t]||this.map[n][t]},transitionsFor:function(e){var t=this.defaults.wildcard;return Object.keys(this.map[e]).concat(Object.keys(this.map[t]))},allStates:function(){return this.states},allTransitions:function(){return this.transitions}}),e.exports=o},function(e,t,n){var i=n(0),r=n(6),o=n(1),s=[null,[]];function a(e,t){this.context=e,this.config=t,this.state=t.init.from,this.observers=[e]}i(a.prototype,{init:function(e){if(i(this.context,this.config.data.apply(this.context,e)),o.hook(this,"init"),this.config.init.active)return this.fire(this.config.init.name,[])},is:function(e){return Array.isArray(e)?e.indexOf(this.state)>=0:this.state===e},isPending:function(){return this.pending},can:function(e){return!this.isPending()&&!!this.seek(e)},cannot:function(e){return!this.can(e)},allStates:function(){return this.config.allStates()},allTransitions:function(){return this.config.allTransitions()},transitions:function(){return this.config.transitionsFor(this.state)},seek:function(e,t){var n=this.config.defaults.wildcard,i=this.config.transitionFor(this.state,e),r=i&&i.to;return"function"==typeof r?r.apply(this.context,t):r===n?this.state:r},fire:function(e,t){return this.transit(e,this.state,this.seek(e,t),t)},transit:function(e,t,n,i){var r=this.config.lifecycle,o=this.config.options.observeUnchangedState||t!==n;return n?this.isPending()?this.context.onPendingTransition(e,t,n):(this.config.addState(n),this.beginTransit(),i.unshift({transition:e,from:t,to:n,fsm:this.context}),this.observeEvents([this.observersForEvent(r.onBefore.transition),this.observersForEvent(r.onBefore[e]),o?this.observersForEvent(r.onLeave.state):s,o?this.observersForEvent(r.onLeave[t]):s,this.observersForEvent(r.on.transition),o?["doTransit",[this]]:s,o?this.observersForEvent(r.onEnter.state):s,o?this.observersForEvent(r.onEnter[n]):s,o?this.observersForEvent(r.on[n]):s,this.observersForEvent(r.onAfter.transition),this.observersForEvent(r.onAfter[e]),this.observersForEvent(r.on[e])],i)):this.context.onInvalidTransition(e,t,n)},beginTransit:function(){this.pending=!0},endTransit:function(e){return this.pending=!1,e},failTransit:function(e){throw this.pending=!1,e},doTransit:function(e){this.state=e.to},observe:function(e){if(2===e.length){var t={};t[e[0]]=e[1],this.observers.push(t)}else this.observers.push(e[0])},observersForEvent:function(e){for(var t,n=0,i=this.observers.length,r=[];n<i;n++)(t=this.observers[n])[e]&&r.push(t);return[e,r,!0]},observeEvents:function(e,t,n,i){if(0===e.length)return this.endTransit(void 0===i||i);var r=e[0][0],s=e[0][1],a=e[0][2];if(t[0].event=r,r&&a&&r!==n&&o.hook(this,"lifecycle",t),0===s.length)return e.shift(),this.observeEvents(e,t,r,i);var u=s.shift(),d=u[r].apply(u,t);return d&&"function"==typeof d.then?d.then(this.observeEvents.bind(this,e,t,r)).catch(this.failTransit.bind(this)):!1===d?this.endTransit(!1):this.observeEvents(e,t,r,d)},onInvalidTransition:function(e,t,n){throw new r("transition is invalid in current state",e,t,n,this.state)},onPendingTransition:function(e,t,n){throw new r("transition is invalid while previous transition is still in progress",e,t,n,this.state)}}),e.exports=a},function(e,t,n){"use strict";var i=n(0),r=n(2),o=n(1),s=n(3),a=n(4),u={is:function(e){return this._fsm.is(e)},can:function(e){return this._fsm.can(e)},cannot:function(e){return this._fsm.cannot(e)},observe:function(){return this._fsm.observe(arguments)},transitions:function(){return this._fsm.transitions()},allTransitions:function(){return this._fsm.allTransitions()},allStates:function(){return this._fsm.allStates()},onInvalidTransition:function(e,t,n){return this._fsm.onInvalidTransition(e,t,n)},onPendingTransition:function(e,t,n){return this._fsm.onPendingTransition(e,t,n)}},d={state:{configurable:!1,enumerable:!0,get:function(){return this._fsm.state},set:function(e){throw Error("use transitions to change state")}}};function c(e){return l(this||{},e)}function l(e,t){return h(e,new s(t,c)),e._fsm(),e}function h(e,t){if("object"!=typeof e||Array.isArray(e))throw Error("StateMachine can only be applied to objects");o.build(e,t),Object.defineProperties(e,d),i(e,u),i(e,t.methods),t.allTransitions().forEach((function(t){e[r(t)]=function(){return this._fsm.fire(t,[].slice.call(arguments))}})),e._fsm=function(){this._fsm=new a(this,t),this._fsm.init(arguments)}}c.version="3.0.1",c.factory=function(){var e,t;"function"==typeof arguments[0]?(e=arguments[0],t=arguments[1]||{}):(e=function(){this._fsm.apply(this,arguments)},t=arguments[0]||{});var n=new s(t,c);return h(e.prototype,n),e.prototype._fsm.config=n,e},c.apply=l,c.defaults={wildcard:"*",init:{name:"init",from:"none"}},e.exports=c},function(e,t,n){"use strict";e.exports=function(e,t,n,i,r){this.message=e,this.transition=t,this.from=n,this.to=i,this.current=r}}])},e.exports=i()},function(e,t,n){var i=n(7),r=n(8),o=n(9),s=n(10);e.exports=function(e){return i(e)||r(e)||o(e)||s()}},function(e,t,n){e.exports=n(11)},function(e,t,n){var i=n(3);e.exports=function(e){if(Array.isArray(e))return i(e)}},function(e,t){e.exports=function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}},function(e,t,n){var i=n(3);e.exports=function(e,t){if(e){if("string"==typeof e)return i(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?i(e,t):void 0}}},function(e,t){e.exports=function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}},function(e,t,n){"use strict";n.r(t);var i=n(4),r=n.n(i),o=n(0),s=n.n(o),a=n(1),u=n.n(a),d=new(function(){function e(){s()(this,e)}return u()(e,[{key:"state",value:function(e){console.info("%c"+this._getFormatter()+" "+e,"color: #FF6347")}},{key:"trace",value:function(e){console.info("%c"+this._getFormatter()+" "+e,"color: #008080")}},{key:"info",value:function(e){console.info(this._getFormatter()+" "+e)}},{key:"warn",value:function(e){console.warn(this._getFormatter()+" "+e)}},{key:"error",value:function(e){console.error(this._getFormatter()+" "+e)}},{key:"log",value:function(e){this.info(e)}},{key:"_getFormatter",value:function(){return this._dateFormat("[YY-MM-DD HH:mm:SS.sss]")}},{key:"_dateFormat",value:function(e){var t=new Date,n={"Y+":t.getFullYear().toString(),"M+":(t.getMonth()+1).toString(),"D+":t.getDate().toString(),"H+":t.getHours().toString(),"m+":t.getMinutes().toString(),"S+":t.getSeconds().toString(),"s+":t.getMilliseconds().toString()};for(var i in n){var r=new RegExp("("+i+")").exec(e);r&&(e=e.replace(r[1],1==r[1].length?n[i]:n[i].padStart(r[1].length,"0")))}return e}}]),e}()),c=function(){function e(){s()(this,e),this.handlerMap=new Map}return u()(e,[{key:"addMsgHandler",value:function(e,t){this.handlerMap[e]?d.error("Message: "+e+" handler already exists!"):this.handlerMap[e]=t}},{key:"removeMsgHandler",value:function(e){this.handlerMap[e]?this.handlerMap.delete(e):d.error("Cannot find message handler: "+e)}},{key:"clearMsgHandler",value:function(){this.handlerMap=new Map}},{key:"onMessage",value:function(e,t){try{e.id?this.handlerMap[e.id]?this.handlerMap[e.id](e,t):d.warn("No handler for msg: "+e.id):d.error("Unexpected!!!")}catch(e){console.error(e)}}}]),e}();function l(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return h(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return h(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var i=0,r=function(){};return{s:r,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==n.return||n.return()}finally{if(a)throw o}}}}function h(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function f(){function e(){return(65536*(1+Math.random())|0).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}function p(e,t){var n,i=l(t.split(";"));try{for(i.s();!(n=i.n()).done;){var r=n.value;if(r.indexOf(e)>-1)return r}}catch(e){i.e(e)}finally{i.f()}return null}function g(e){new Promise((function(e){e()})).then((function(){e()}))}function v(e,t,n){var i=n.value;return n.value=function(){for(var e="",n=0;n<arguments.length;n++)e+=e?", "+JSON.stringify(arguments[n]):JSON.stringify(arguments[n]);return e?d.trace("".concat(t,": ")+e):d.trace('"'.concat(t,'"')),i.apply(this,arguments)},n}var y=function(e,t,n,i){if(n&&i||(n=.25,i=.25),t<1)var r=parseInt(e[0].X)+(e[1].X-e[0].X)*n,o=parseInt(e[0].Y)+(e[1].Y-e[0].Y)*n;else r=parseInt(e[t].X)+(e[t+1].X-e[t-1].X)*n,o=parseInt(e[t].Y)+(e[t+1].Y-e[t-1].Y)*n;if(t>e.length-3)var s=e.length-1,a=parseInt(e[s].X)-(e[s].X-e[s-1].X)*i,u=parseInt(e[s].Y)-(e[s].Y-e[s-1].Y)*i;else a=parseInt(e[t+1].X)-(e[t+2].X-e[t].X)*i,u=parseInt(e[t+1].Y)-(e[t+2].Y-e[t].Y)*i;return{pA:{x:r,y:o},pB:{x:a,y:u}}};function m(e){var t;for(t="string"==typeof e?(parseInt(e)>>>0).toString(16).toLocaleUpperCase():parseInt(e).toString(16);t.length<6;)t="0"+t;var n=t.substring(t.length-2),i=t.substring(t.length-4,t.length-2);return"#"+t.substring(t.length-6,t.length-4)+i+n}function b(e,t,n){return e?"_"+e+"_"+t+"_"+n:"_"+t+"_"+n}var _=new(function(){function e(){s()(this,e),this.websocket=null,this.restoring=!1,this.userInfo={appId:null,groupId:null,userId:null},this.loginParams={accessUrl:"",token:null,companyId:"",forceLogin:0,extendInfo:"",mutexType:"web",registered:1},this.msgDispatcher=new c}return u()(e,[{key:"getClientId",value:function(){return"{"+this.userInfo.appId+";"+this.userInfo.groupId+"};"+this.userInfo.userId}},{key:"buildGetGateWayUrl",value:function(e){return e+"?appType=24&appId="+this.appId+"&ver=2.0.0&comid="+this.companyId+"&os=wechat&token="+this.token}}]),e}()),k=function(){function e(t){return s()(this,e),d.log(t),this.socket={},this.addrUrl=t.addrUrl,this.proxyIndex=0,this.isShowLog=!0,this.handler=t.handler,this.opened_hook=t.opened||function(){},this.closed_hook=t.closed||function(){},this.error_hook=t.error||function(){},this.limitConnect=this.getTimer(),this.connectStatus=!0,this._createWebsocket(),this}return u()(e,[{key:"_createWebsocket",value:function(){if(!(this.addrUrl instanceof Array))throw new Error("value is not Array");if(this.proxyIndex<this.addrUrl.length){var e={url:this.addrUrl[this.proxyIndex],success:function(e){d.info("Create websocket success.")},fail:function(e){d.error("Create websocket failed!"+e)},complete:function(e){d.info("Create websocket complete.")}};if(this.socket=wx.connectSocket(e),!this.socket)return void d.error("Connect socket failed: "+this.addrUrl);this._eventBind()}else d.error("Unexpected!")}},{key:"_eventBind",value:function(){var e=this;this.socket.onOpen((function(t){d.log("onOpen: "+JSON.stringify(t)),e.opened_hook(arguments)})),this.socket.onClose((function(t){d.log("onClose: "+JSON.stringify(t)),d.info("websocket 链接断开！"),e.closed_hook(arguments)})),this.socket.onMessage((function(t){var n=JSON.parse(t.data);3e4!=n.id&&d.log("===> Recv msg from "+e.addrUrl+": "+t.data),e.handler.onMessage(n)})),this.socket.onError((function(t){d.warn(t),e.error_hook(arguments),void 0!==e.socket&&e.socket.close()}))}},{key:"reconnect",value:function(){this.connectStatus&&(this.limitConnect((function(){this.proxyIndex++})),this.createWebsocket())}},{key:"getSocket",value:function(){return this.socket&&1===this.socket.readyState?this.socket:null}},{key:"getTimer",value:function(){var e=[];return function(t){e.push((new Date).getTime());var n=(new Date).getTime();n-e[0]>5e3&&(e=[],t.apply(this,arguments))}}},{key:"setAddr",value:function(e){if(!(e instanceof Array))throw new Error("value is not Array");this.addrUrl=e,this.proxyIndex=0,this.createWebsocket()}},{key:"send",value:function(e){this.socket&&1===this.socket.readyState?(d.log("<=== Send msg to "+this.addrUrl+": "+e),this.socket.send({data:e,success:function(e){},fail:function(e){d.error("Send failed!")},complete:function(e){}})):d.error("Send msg failed: "+e)}},{key:"close",value:function(){this.socket&&(this.socket.close(),this.socket=null)}}]),e}(),I=0,S=1,w=2,M=4,R=0,P=1,D=0,O=1,T="curve",x="text",W=0,E=1,A=2,C=0,B=1,N="EVENT_INIT",L="EVENT_LOGIN",j="EVENT_LOGOUT",U="EVENT_JOIN_GROUP",q="EVENT_LEAVE_GROUP",F="EVENT_START_RECV_MEDIA",G="EVENT_STOP_RECV_MEDIA",H="EVENT_GET_ONLINE_USERS",J="EVENT_INVITE",V="EVENT_NOTICE_IGNORE_INVITE",z="EVENT_CANCEL_INVITE",Y="EVENT_NOTICE_CANCEL_INVITE",X="EVENT_CREATE_WHITE_BOARD",$="EVENT_CLOSE_WHITE_BOARD",K=1,Z=2,Q=3;function ee(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return te(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return te(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var i=0,r=function(){};return{s:r,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==n.return||n.return()}finally{if(a)throw o}}}}function te(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}var ne=[].slice;function ie(e,t,n){for(var i=-1,r=e.callbacks.length;++i<r;){var o=e.callbacks[i];o.callback.apply(o.context||n,t)}}var re,oe,se={on:function(e,t,n){var i=this._registry||(this._registry={}),r=i[e]||(i[e]={events:[],callbacks:[]});return r.callbacks.push({callback:t,context:n}),function(e,t,n){if(e.events.length>0){var i,r=ee(e.events);try{for(r.s();!(i=r.n()).done;){var o=i.value;t.apply(n||this,o)}}catch(e){r.e(e)}finally{r.f()}e.events=[]}}(r,t,n),this},off:function(e,t,n){if(!e&&!t&&!n)return delete this._registry,this;for(var i=e?[e]:Object.keys(this._registry),r=0,o=i.length;r<o;r++){var s=i[r],a=this._registry[s].callbacks;if(a){var u=this._registry[s].callbacks=[];if(t||n)for(var d=0,c=a.length;d<c;d++){var l=a[d];(t&&t!==l.callback||n&&n!==l.context)&&u.push(l)}u.length||delete this._registry[s]}else console.warn("Empty callbacks of event: "+s)}return this},trigger:function(e){this._registry||(this._registry={});var t=ne.call(arguments,1),n=this._registry[e]||(this._registry[e]={events:[],callbacks:[]});return n.callbacks.length>0?ie(n,t,this):n.events.length<1024?n.events.push(t):console.warn("Events queue is full, event: "+e),this}},ae=function(e,t){return new Promise((function(n,i){se.on(e,(function(){var e=Array.prototype.shift.call(arguments);0===parseInt(e)?(t&&t.call(this),n.apply(void 0,arguments)):i.apply(void 0,arguments)}))}))},ue=n(2),de=n.n(ue),ce=new(re=function(){function e(){s()(this,e),this.videoParamMap=new Map,this.defaultVideoParam={frameRate:15,width:640,height:480,bitRate:0}}return u()(e,[{key:"startPublishVideo",value:function(e,t){if(e){if(t){if(!("width"in t)||"number"!=typeof t.width)return void d.error("No width or invalid width in videoParam!");if(!("height"in t)||"number"!=typeof t.height)return void d.error("No height or invalid height in videoParam!");if(!("frameRate"in t)||"number"!=typeof t.frameRate)return void d.error("No frameRate or invaid frameRate in videoParam!");if(!("bitRate"in t)||"number"!=typeof t.bitRate)return void d.error("No bitRate or invalid bitRate in videoParam!");this.setVideoParam(e,t)}xe.sendPublishMediaReq(P,w,e)}else d.error("Invalid deviceId!")}},{key:"stopPublishVideo",value:function(e){xe.sendPublishMediaReq(R,w,e)}},{key:"startReceiveVideo",value:function(e,t){return xe.sendRecvMediaReq(O,e,w,t),ae(F+b(e,w,t))}},{key:"stopReceiveVideo",value:function(e,t){return xe.sendRecvMediaReq(D,e,w,t),ae(G+b(e,w,t))}}]),e}(),de()(re.prototype,"startPublishVideo",[v],Object.getOwnPropertyDescriptor(re.prototype,"startPublishVideo"),re.prototype),de()(re.prototype,"stopPublishVideo",[v],Object.getOwnPropertyDescriptor(re.prototype,"stopPublishVideo"),re.prototype),de()(re.prototype,"startReceiveVideo",[v],Object.getOwnPropertyDescriptor(re.prototype,"startReceiveVideo"),re.prototype),de()(re.prototype,"stopReceiveVideo",[v],Object.getOwnPropertyDescriptor(re.prototype,"stopReceiveVideo"),re.prototype),re),le=new(oe=function(){function e(){s()(this,e),this.screenShareStream=null,this.screenShareStreamRefCount=0,this.isCreatingStream=!1,this.screenShareParam={frameRate:15,width:1920,height:1080,bitRate:0}}return u()(e,[{key:"startScreenShare",value:function(e){if(e){if(!("width"in e)||"number"!=typeof e.width)return void console.error("No width or invalid width in shareParam!");if(!("height"in e)||"number"!=typeof e.height)return void console.error("No height or invalid height in shareParam!");if(!("frameRate"in e)||"number"!=typeof e.frameRate)return void console.error("No frameRate or invaid frameRate in shareParam!");if(!("bitRate"in e)||"number"!=typeof e.bitRate)return void console.error("No bitRate or invalid bitRate in shareParam!");this.setScreenShareParam(e),console.log("Set screen share param: ",e)}xe.sendPublishMediaReq(P,I,"0")}},{key:"stopScreenShare",value:function(){xe.sendPublishMediaReq(R,I,"0")}},{key:"startReceiveScreenShare",value:function(e,t){return xe.sendRecvMediaReq(O,e,I,t),ae(F+b(e,I,t))}},{key:"stopReceiveScreenShare",value:function(e,t){return xe.sendRecvMediaReq(D,e,I,t),ae(G+b(userId,I,t))}}]),e}(),de()(oe.prototype,"startScreenShare",[v],Object.getOwnPropertyDescriptor(oe.prototype,"startScreenShare"),oe.prototype),oe);function he(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return fe(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return fe(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var i=0,r=function(){};return{s:r,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==n.return||n.return()}finally{if(a)throw o}}}}function fe(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}var pe,ge,ve={line:function(e,t,n){e.beginPath(),e.lineCap="round",e.lineWidth=t.brush_size*n,e.strokeStyle=m(t.color),e.moveTo(t.x1*n,t.y1*n),e.lineTo(t.x2*n,t.y2*n),e.stroke(),e.closePath()},curve:function(e,t,n){e.beginPath(),e.lineCap="round",e.lineWidth=t.brush_size*n,e.strokeStyle=m(t.color);var i=t.points.map((function(e){return{X:e[0]*n,Y:e[1]*n}}));if(t.brush_size>4){e.moveTo(i[0].X,i[0].Y);for(var r=1;r<i.length;r++){var o=y(i,r-1);e.bezierCurveTo(o.pA.x,o.pA.y,o.pB.x,o.pB.y,i[r].X,i[r].Y)}}else for(var s=1;s<i.length;s++)e.lineTo(i[s].X,i[s].Y);e.stroke(),e.closePath()},text:function(e,t,n){e.beginPath(),e.font="".concat(4*t.fontsize/3*n,'px "').concat(t.color,'"'),e.textBaseline="top",e.fillStyle=m(t.color);var i,r=0,o=he(t.text.split("\r\n"));try{for(o.s();!(i=o.n()).done;){var s=i.value;e.fillText(s,t.left*n,22*r+t.top*n),r++}}catch(e){o.e(e)}finally{o.f()}e.closePath()},rectangle:function(e,t,n){e.beginPath(),e.lineWidth=t.brush_size*n,e.strokeStyle=t.color;var i=parseInt(t.x1)*n,r=parseInt(t.y1)*n,o=parseInt(t.x2)*n,s=parseInt(t.y2)*n;e.rect(i,r,o-i,s-r),e.closePath(),e.stroke()}},ye=n(5),me=n.n(ye),be=function(){function e(t){return s()(this,e),this.boardData={paintMap:new Map},this._init(t),this}return u()(e,[{key:"_init",value:function(e){var t=this,n=e.slice(0,1),i=e.slice(1);this.boardData=Object.assign(this.boardData,n[0].board),i.length>0?i.map((function(e){var n=t.boardData.paintMap.get(e[e.type].pid);n?(n.push(e),t.boardData.paintMap.set(e[e.type].pid,n)):t.boardData.paintMap.set(e[e.type].pid,[e])})):this.boardData.paintMap.set(n[0].board.current_pid,[])}},{key:"clearPaints",value:function(){this.boardData.paintMap=new Map,this.boardData.paintMap.set(this.getCurPage(),[])}},{key:"getCurPage",value:function(){return this.boardData.current_pid}},{key:"getPageCount",value:function(){return this.boardData.page}},{key:"getFilePath",value:function(){return this.boardData.file_path}},{key:"getConvertFilePath",value:function(){return this.boardData.convert_file_path}},{key:"setCurPage",value:function(e){this.boardData.current_pid=e}},{key:"getBoardName",value:function(){return this.boardData.board_name}},{key:"deletePage",value:function(e){this.boardData.paintMap.get(e[e.type].pid)&&this.boardData.paintMap.set(e[e.type].pid,[])}},{key:"findPagePaints",value:function(e){return this.boardData.paintMap.get(e)||this.boardData.paintMap.set(e,[]),this.boardData.paintMap.get(e)}},{key:"findPaintByGid",value:function(e,t){for(var n=0;n<e.length;n++){var i=e[n];if(i[i.type].gid===t)return i}return null}},{key:"deletePaintObj",value:function(e,t){for(var n=0;n<e.length;n++){var i=e[n];if(i[i.type].gid===t){e.splice(n,1),console.log("===>",e);break}}}},{key:"addPaintObj",value:function(e,t){e.push(t)}},{key:"amendPaintObj",value:function(e,t){for(var n=0;n<e.length;n++){var i=e[n];if(i[i.type].gid===t[t.type].gid){var r;if(i.type===T)(r=i[i.type].points).push.apply(r,me()(t[t.type].points));else e.splice(n,1,t);break}}}},{key:"movePaintObj",value:function(e,t,n){for(var i=0;i<e.length;i++){var r=e[i];if(r[r.type].gid===t){r.type===T?r[r.type].points=r[r.type].points.map((function(e){return[e[0]+n.ox,e[1]+n.oy]})):r.type===x?(r[r.type].left+=n.ox,r[r.type].top+=n.oy):(r[r.type].x1+=n.ox,r[r.type].y1+=n.oy,r[r.type].x2+=n.ox,r[r.type].y2+=n.oy);break}}}}]),e}(),_e=(pe=function(){function e(t){return s()(this,e),this.isClosing=!1,this.pageStore=null,this.firstFullData=!0,this.scaleRatio=1,this.width=0,this.height=0,this.parentWidth=0,this.parentHeight=0,this.canvasEle=null,this.canvasCtx=null,this.canvasSizeChangeCallback=null,this.canvasLeft=0,this.canvasTop=0,this.canvasWidth=0,this.canvasHeight=0,this.sourcePaints=[],this.msg_seq_id=null,this.displayMode=K,this.displayParam=null,this.userId=t.userId,this.mediaId=t.mediaId,this.streamId=t.streamId,this.streamToken=t.streamToken,this.streamServer=t.streamServer,this.msgDispatcher=new c,this.msgDispatcher.addMsgHandler(31e3,this._dealAmendData.bind(this)),this.msgDispatcher.addMsgHandler(31002,this._dealAmendData.bind(this)),this.msgDispatcher.addMsgHandler(31006,this._dealAmendData.bind(this)),this.msgDispatcher.addMsgHandler(31110,this._pageChangeHandle.bind(this)),this.msgDispatcher.addMsgHandler(31112,this._moveGraph.bind(this)),this.msgDispatcher.addMsgHandler(3e4,this._heartBeat.bind(this)),this.msgDispatcher.addMsgHandler(30004,this._dealFullData.bind(this)),this.msgDispatcher.addMsgHandler(19005,this._processLoginResp.bind(this)),this.websocket=new k({addrUrl:[this.streamServer],handler:this.msgDispatcher,opened:this._onWebsocketOpen.bind(this),closed:this._onWebsocketClosed.bind(this),error:this._onWebsocketError.bind(this)}),this}return u()(e,[{key:"_processLoginResp",value:function(e){0!=e.result&&d.warn("Login white board receive channel failed!")}},{key:"_onWebsocketOpen",value:function(){xe.sendLoginRecvChannelReq(this.websocket,{mediaType:M,mediaId:"",streamId:this.streamId,streamToken:this.streamToken})}},{key:"_onWebsocketClosed",value:function(){var e=this;this.isClosing||(g((function(){se.trigger("restoreWhiteBoard",{userId:e.userId,mediaId:e.mediaId,parentEle:e.parentEle,displayMode:e.displayMode,displayParam:e.displayParam})})),this.close())}},{key:"_onWebsocketError",value:function(){}},{key:"setDisplayMode",value:function(e,t){(this.displayMode!=e||e==Q&&t&&this.displayParam!=t)&&(this.displayMode=e,this.displayParam=t,this._showWhiteBoard())}},{key:"_showWhiteBoardDbwz",value:function(){this.parentHeight/this.parentWidth.toFixed(6)>this.height/this.width.toFixed(6)?(this.canvasWidth=this.parentWidth,this.canvasHeight=this.height*this.parentWidth/this.width.toFixed(6),this.canvasLeft=0,this.canvasTop=(this.parentHeight-this.canvasHeight)/2):(this.canvasWidth=this.width*this.parentHeight/this.height.toFixed(6),this.canvasHeight=this.parentHeight,this.canvasLeft=(this.parentWidth-this.canvasWidth)/2,this.canvasTop=0),this.canvasSizeChangeCallback(this.canvasLeft,this.canvasTop,this.canvasWidth,this.canvasHeight),this.scaleRatio=this.canvasHeight/this.height.toFixed(6),this.canvasEle.width=this.canvasWidth,this.canvasEle.height=this.canvasHeight,this._refreshRender()}},{key:"_showWhiteBoardDbsy",value:function(){this.parentHeight/this.parentWidth.toFixed(6)>this.height/this.width.toFixed(6)?(this.canvasWidth=this.width*this.parentHeight/this.height.toFixed(6),this.canvasHeight=this.parentHeight,this.canvasLeft=0,this.canvasTop=0):(this.canvasWidth=this.parentWidth,this.canvasHeight=this.height*this.parentWidth/this.width.toFixed(6),this.canvasLeft=0,this.canvasTop=0),this.canvasSizeChangeCallback(this.canvasLeft,this.canvasTop,this.canvasWidth,this.canvasHeight),this.scaleRatio=this.canvasHeight/this.height.toFixed(6),this.canvasEle.width=this.canvasWidth,this.canvasEle.height=this.canvasHeight,this._refreshRender()}},{key:"_showWhiteBoardDbsf",value:function(){this.canvasWidth=this.width*this.displayParam.toFixed(6)/100,this.canvasHeight=this.height*this.displayParam.toFixed(6)/100,this.canvasWidth>=this.parentWidth?this.canvasLeft=0:this.canvasLeft=(this.parentWidth-this.canvasWidth)/2,this.canvasHeight>=this.parentHeight?this.canvasTop=0:this.canvasTop=(this.parentHeight-this.canvasHeight)/2,this.canvasSizeChangeCallback(this.canvasLeft,this.canvasTop,this.canvasWidth,this.canvasHeight),this.scaleRatio=this.displayParam.toFixed(6)/100,this.canvasEle.width=this.canvasWidth,this.canvasEle.height=this.canvasHeight,this._refreshRender()}},{key:"_showWhiteBoard",value:function(){this.canvasEle&&this.canvasCtx?this.displayMode==K?this._showWhiteBoardDbwz():this.displayMode==Z?this._showWhiteBoardDbsy():this.displayMode==Q?this._showWhiteBoardDbsf():d.error("Unknown display mode: "+this.displayMode):console.warn("Invalid canvas render!")}},{key:"setRenderElement",value:function(e,t){d.log("Set render element: "+JSON.stringify(t)),e?(this.canvasEle=e,this.parentWidth=t.parentWidth,this.parentHeight=t.parentHeight,this.canvasSizeChangeCallback=t.canvasSizeChange,this.canvasCtx=this.canvasEle.getContext("2d"),this._showWhiteBoard()):(this._emptyCanvas(),this.canvasEle&&(this.canvasEle.width=0,this.canvasEle.height=0,this.canvasCtx=null,this.canvasEle=null),this.canvasSizeChangeCallback=null,this.parentWidth=0,this.parentHeight=0)}},{key:"_initCanvas",value:function(e){this.width=e.width,this.height=e.height,we._getFileUrl(e.convert_file_path,e.page),this._refreshRender()}},{key:"_emptyCanvas",value:function(){this.canvasCtx&&this.canvasCtx.clearRect(0,0,this.canvasWidth,this.canvasHeight)}},{key:"_waitGetImageUrl",value:function(){var e=this.pageStore.getConvertFilePath();return new Promise((function(t,n){var i=0,r=setInterval((function(){++i,we.cacheFileUrlMap.get(e)?(clearInterval(r),t()):i>10&&(clearInterval(r),n("等待获取图片URL失败"))}),500)}))}},{key:"_drawImage",value:function(){var e=this,t=this.pageStore.getConvertFilePath(),n=this.pageStore.getCurPage(),i="".concat(t,"/").concat(n,".jpg");return new Promise((function(n,r){var o=we.cacheFileUrlMap.get(t).get(i);wx.getImageInfo({src:o,success:function(t){if(e.canvasEle){var i=e.canvasEle.createImage();i.onload=function(){d.log("加载图片成功"),e.canvasCtx&&e.canvasCtx.drawImage(i,0,0,e.canvasWidth,e.canvasHeight),n()},i.onerror=function(e){console.error("加载图片失败",e),r()},i.src=t.path}},fail:function(e){d.warn("Get image info failed!"),r()}})}))}},{key:"_refreshRender",value:function(){var e=this;e._emptyCanvas(),e.pageStore.getFilePath()?e._waitGetImageUrl().then((function(){d.log("Image url is ready."),e._drawImage().then((function(){d.log("Draw image finished."),e._drawAllPaint()})).catch((function(){d.log("Draw image failed!")}))})).catch((function(e){d.warn(e)})):(d.log("无需绘制背景图片"),e._drawAllPaint())}},{key:"_drawPaint",value:function(e,t){if(this.canvasCtx)try{ve[e](this.canvasCtx,t,this.scaleRatio)}catch(t){d.error("Draw type: "+e+", error: "+t)}}},{key:"_drawAllPaint",value:function(){var e=this;this.pageStore&&this.pageStore.findPagePaints(this.pageStore.getCurPage()).map((function(t){e._drawPaint(t.type,t[t.type])}))}},{key:"_drawAmendData",value:function(e,t){if(t.type!==T)this._emptyCanvas(),this._drawAllPaint();else{var n=this.pageStore.findPaintByGid(e,t[t.type].gid);n&&this._drawPaint(n.type,n[n.type])}}},{key:"_dealAmendData",value:function(e){this._checkMsgSeq(e);var t=this.pageStore.findPagePaints(this.pageStore.getCurPage());1===e[e.type].action?(this.pageStore.addPaintObj(t,e),this._drawAmendData(t,e)):2===e[e.type].action?(this.pageStore.amendPaintObj(t,e),this._drawAmendData(t,e)):3===e[e.type].action&&(this.pageStore.deletePaintObj(t,e[e.type].gid),this._drawAllPaint())}},{key:"_pageChangeHandle",value:function(e){this._checkMsgSeq(e);var t=e[e.type];0===t.action?(this.pageStore.setCurPage(t.pid),this._refreshRender(),se.trigger("onWhiteBoardCurPageChanged",{mediaId:this.mediaId,curPage:this.pageStore.getCurPage()})):1===t.action?this.pageStore.addPage(t):2===t.action?this.pageStore.deletePage(t):3===t.action?(this._emptyCanvas(),this.pageStore.clearPaints()):d.warn("Unexpected action: "+t.action)}},{key:"_moveGraph",value:function(e){var t=this;this._checkMsgSeq(e);var n=this.pageStore.findPagePaints(e.gmov.pid);e.gmov.graphs.map((function(i){t.pageStore.movePaintObj(n,i,e.gmov)})),this._drawAllPaint()}},{key:"close",value:function(){this.isClosing=!0,this.pageStore=null,this.msgDispatcher=null,we.removeWhiteBoard(this.mediaId),this.intervalHandle&&(clearInterval(this.intervalHandle),this.intervalHandle=null),this.parentEle&&this.canvasEle&&(this.parentEle.removeChild(this.canvasEle),this.canvasEle=null),this.websocket&&(this.websocket.close(),this.websocket=null)}},{key:"_dealFullData",value:function(e){if(this.sourcePaints=this.sourcePaints.concat(e.data),e.sync_end){if(d.log("Get white board full data complete."),this.pageStore=new be(this.sourcePaints),!this.sourcePaints[0].board)return d.error("Invalid source paints: "+JSON.stringify(this.sourcePaints)),void(this.sourcePaints=[]);this._initCanvas(this.sourcePaints[0].board),this.firstFullData&&(we.tryRestoreWhiteBoardRender(this.mediaId)||se.trigger("onRemoteMediaAdd",{userId:null,mediaType:M,mediaId:this.mediaId,mediaName:this.pageStore.getBoardName(),totalPage:this.pageStore.getPageCount(),curPage:this.pageStore.getCurPage()}),this.firstFullData=!1),this.sourcePaints=[]}}},{key:"_checkMsgSeq",value:function(e){(!this.msg_seq_id||null!==this.msg_seq_id&&e.seq_id-this.msg_seq_id!=1)&&xe.sendGetWhiteBoardFullDataReq(this.websocket),this.msg_seq_id=e.seq_id}},{key:"_heartBeat",value:function(e){this._checkMsgSeq(e)}}]),e}(),de()(pe.prototype,"_processLoginResp",[v],Object.getOwnPropertyDescriptor(pe.prototype,"_processLoginResp"),pe.prototype),de()(pe.prototype,"_onWebsocketOpen",[v],Object.getOwnPropertyDescriptor(pe.prototype,"_onWebsocketOpen"),pe.prototype),de()(pe.prototype,"_onWebsocketClosed",[v],Object.getOwnPropertyDescriptor(pe.prototype,"_onWebsocketClosed"),pe.prototype),de()(pe.prototype,"_onWebsocketError",[v],Object.getOwnPropertyDescriptor(pe.prototype,"_onWebsocketError"),pe.prototype),de()(pe.prototype,"_showWhiteBoardDbwz",[v],Object.getOwnPropertyDescriptor(pe.prototype,"_showWhiteBoardDbwz"),pe.prototype),de()(pe.prototype,"setRenderElement",[v],Object.getOwnPropertyDescriptor(pe.prototype,"setRenderElement"),pe.prototype),de()(pe.prototype,"close",[v],Object.getOwnPropertyDescriptor(pe.prototype,"close"),pe.prototype),pe);function ke(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Ie(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Ie(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var i=0,r=function(){};return{s:r,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==n.return||n.return()}finally{if(a)throw o}}}}function Ie(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}var Se,we=new(ge=function(){function e(){return s()(this,e),this._init(),_.msgDispatcher.addMsgHandler(19001,this._onCreateWhiteBoardRes.bind(this)),_.msgDispatcher.addMsgHandler(19003,this._onCloseWhiteBoardRes.bind(this)),_.msgDispatcher.addMsgHandler(20007,this._onGetWhiteBoardFileUrlRes.bind(this)),se.on("restoreWhiteBoard",this._onRestoreWhiteBoard.bind(this)),this}return u()(e,[{key:"tryRestoreWhiteBoardRender",value:function(e){var t=this;if(0==this.restoreWhiteBoards.length)return d.log("Empty restore white boards."),!1;var n=this.restoreWhiteBoards[0];return n.mediaId!=e?(d.log("Different white board."),!1):(this.setWhiteBoardRender(e,n.parentEle),this.setDisplayMode(e,n.displayMode,n.displayParam),this.restoreWhiteBoards.shift(),this.restoreWhiteBoards.length>0&&g((function(){t._doStartReceiveWhiteBoard(t.restoreWhiteBoards[0])})),!0)}},{key:"_doStartReceiveWhiteBoard",value:function(e){var t=this;this.startReceiveWhiteBoard(e).then((function(){d.log("Start receive white board success.")})).catch((function(e){d.error("Start receive white board failed, err: "+e),t.restoreWhiteBoards.shift()}))}},{key:"_onRestoreWhiteBoard",value:function(e){this.restoreWhiteBoards.push(e),1==this.restoreWhiteBoards.length&&this._doStartReceiveWhiteBoard(e.mediaId)}},{key:"_init",value:function(){this.whiteBoards=new Array,this.displayMode=null,this.displayParam=null,this.cacheFileUrlMap=new Map,this.restoreWhiteBoards=new Array}},{key:"createWhiteBoard",value:function(e){return xe.sendCreateWhiteboardReq(e),ae(X)}},{key:"_onCreateWhiteBoardRes",value:function(e){se.trigger(X,0==e.result?C:B)}},{key:"closeWhiteBoard",value:function(e){if(e)return xe.sendCloseWhiteboardReq(e),ae($);console.error("Invalid mediaId!")}},{key:"_onCloseWhiteBoardRes",value:function(e){se.trigger(X,0==e.result?C:B)}},{key:"startPublishWhiteBoard",value:function(e){xe.sendPublishMediaReq(P,M,e)}},{key:"stopPublishWhiteBoard",value:function(e){xe.sendPublishMediaReq(R,M,e)}},{key:"startReceiveWhiteBoard",value:function(e,t){return xe.sendRecvMediaReq(O,e,M,t),ae(F+b(e,M,t))}},{key:"stopReceiveWhiteBoard",value:function(e,t){return xe.sendRecvMediaReq(D,e,M,t),ae(G+b(e,M,t))}},{key:"setWhiteBoardRender",value:function(e,t,n){var i,r=ke(this.whiteBoards);try{for(r.s();!(i=r.n()).done;){var o=i.value;if(o.mediaId==e)return void o.setRenderElement(t,n)}}catch(e){r.e(e)}finally{r.f()}d.warn("Cannot find white board by mediaId: "+e)}},{key:"unsetWhiteBoardRender",value:function(e){var t,n=ke(this.whiteBoards);try{for(n.s();!(t=n.n()).done;){var i=t.value;if(i.mediaId==e)return void i.setRenderElement(null,null)}}catch(e){n.e(e)}finally{n.f()}d.warn("Cannot find white board by mediaId: "+e)}},{key:"setDisplayMode",value:function(e,t,n){if(t==K||t==Z||t==Q){if(t==Q){if(!n)return void d.error("setDisplayMode param is invalid!");if(!Number.isInteger(n))return void d.error("setDisplayMode param should be integer!")}if(e){var i=this._findWhiteBoard(e);i?i.setDisplayMode(t,n):d.error("Cannot find white board "+e)}else{var r,o=ke(this.whiteBoards);try{for(o.s();!(r=o.n()).done;){r.value.setDisplayMode(t,n)}}catch(e){o.e(e)}finally{o.f()}this.displayMode=t,this.displayParam=n}}else d.error("Invalid display mode: "+t)}},{key:"onStartRecvWhiteBoardRes",value:function(e){if(this._findWhiteBoard(e.mediaId))d.error("White baord "+e.mediaId+"exists already!");else{var t=new _e(e);this.whiteBoards.push(t),this.displayMode&&t.setDisplayMode(this.displayMode,this.displayParam)}}},{key:"onStopRecvWhiteBoardRes",value:function(e){if(this._findWhiteBoard(e.mediaId)){for(var t=0;t<this.whiteBoards.length;t++)if(this.whiteBoards[t].mediaId==e.mediaId){this.whiteBoards[t].close(),this.whiteBoards.splice(t,1);break}}else d.error("Cannot find White baord "+e.mediaId)}},{key:"reinitialize",value:function(){var e,t=ke(this.whiteBoards);try{for(t.s();!(e=t.n()).done;){e.value.close()}}catch(e){t.e(e)}finally{t.f()}this._init()}},{key:"removeWhiteBoard",value:function(e){this.whiteBoards.forEach((function(t,n,i){if(t.mediaId==e)return i.splice(n,1),!1}))}},{key:"_findWhiteBoard",value:function(e){var t,n=ke(this.whiteBoards);try{for(n.s();!(t=n.n()).done;){var i=t.value;if(i.mediaId==e)return i}}catch(e){n.e(e)}finally{n.f()}return null}},{key:"_onGetWhiteBoardFileUrlRes",value:function(e){var t=e.data.file_path,n=t.substr(0,t.lastIndexOf("/")),i=this.cacheFileUrlMap.get(n)||new Map,r=e.data.url;-1==e.data.url.search("https")&&(r=e.data.url.replace(/^http/,"https")),i.set(e.data.file_path,r),this.cacheFileUrlMap.set(n,i)}},{key:"_getFileUrl",value:function(e,t){if(e&&!this.cacheFileUrlMap.get(e))for(var n=0;n<t;n++)xe.sendGetWhiteBoardFileUrlReq("".concat(e,"/").concat(n,".jpg"))}}]),e}(),de()(ge.prototype,"tryRestoreWhiteBoardRender",[v],Object.getOwnPropertyDescriptor(ge.prototype,"tryRestoreWhiteBoardRender"),ge.prototype),de()(ge.prototype,"_onRestoreWhiteBoard",[v],Object.getOwnPropertyDescriptor(ge.prototype,"_onRestoreWhiteBoard"),ge.prototype),de()(ge.prototype,"setDisplayMode",[v],Object.getOwnPropertyDescriptor(ge.prototype,"setDisplayMode"),ge.prototype),ge);function Me(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Re(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Re(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var i=0,r=function(){};return{s:r,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==n.return||n.return()}finally{if(a)throw o}}}}function Re(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}var Pe=new(Se=function(){function e(){s()(this,e),this.upPcMap=new Map,this.downPcMap=new Map,this.restoreDownTracks=new Array,_.msgDispatcher.addMsgHandler(14106,this.onNotifyUserMediaState.bind(this)),_.msgDispatcher.addMsgHandler(14109,this.onNotifyGroupMediaStates.bind(this)),_.msgDispatcher.addMsgHandler(14110,this.onNotifyUserJoinGroup.bind(this)),_.msgDispatcher.addMsgHandler(14111,this.onNotifyUserLeaveGroup.bind(this)),_.msgDispatcher.addMsgHandler(18003,this.onRecvStreamRes.bind(this)),se.on("restoreDownTrack",this._onRestoreDownTrack.bind(this))}return u()(e,[{key:"tryRestoreMediaRender",value:function(e){var t=this;if(0==this.restoreDownTracks.length)return d.log("Empty restore tracks."),!1;var n=this.restoreDownTracks[0];return e.userId!==n.userId||e.mediaType!==n.mediaType||e.mediaId!==n.mediaId?(d.log("Different track."),!1):(n.videoEle&&this.setMediaRender(n.userId,n.mediaType,n.mediaId,n.videoEle),this.restoreDownTracks.shift(),this.restoreDownTracks.length>0&&g((function(){t._doStartReceiveMedia(t.restoreDownTracks[0])})),!0)}},{key:"_doStartReceiveMedia",value:function(e){var t=this;this.startReceiveMedia(e.userId,e.mediaType,e.mediaId).then((function(){d.log("Start receive media success.")})).catch((function(e){d.error("Start receive media failed, err: "+e),t.restoreDownTracks.shift()}))}},{key:"_onRestoreDownTrack",value:function(e){this.restoreDownTracks.push(e),1==this.restoreDownTracks.length&&this._doStartReceiveMedia(e)}},{key:"startPublishMedia",value:function(e,t,n){switch(e){case S:Te.startPublishAudio(t);break;case w:ce.startPublishVideo(t,n);break;case I:le.startScreenShare(n);break;case M:we.startPublishWhiteBoard(t);break;default:d.error("Unknown media type: "+e)}}},{key:"stopPublishMedia",value:function(e,t){switch(e){case S:Te.stopPublishAudio();break;case w:ce.stopPublishVideo(t);break;case I:le.stopScreenShare();break;case M:we.stopPublishWhiteBoard(t);break;default:d.error("Unknown media type: "+e)}}},{key:"startReceiveMedia",value:function(e,t,n){switch(t){case S:return Te.startReceiveAudio(e,n);case w:return ce.startReceiveVideo(e,n);case I:return le.startReceiveScreenShare(e,n);case M:return we.startReceiveWhiteBoard(e,n);default:return new Promise((function(e,n){n("Unknown media type: "+t)}))}}},{key:"stopReceiveMedia",value:function(e,t,n){switch(t){case S:return Te.stopReceiveAudio(e,n);case w:return ce.stopReceiveVideo(e,n);case I:return le.stopReceiveScreenShare(e,n);case M:return we.stopReceiveWhiteBoard(e,n);default:d.error("Unknown media type: "+t)}}},{key:"setMediaRender",value:function(e,t,n,i,r){switch(t){case S:case w:case I:console.warn("Unexpected mediaType: "+t);break;case M:we.setWhiteBoardRender(n,i,r);break;default:d.error("Unknown media type: "+t)}}},{key:"unsetMediaRender",value:function(e,t,n){switch(d.trace("Calling unsetMediaRender: "+e+", "+t),t){case S:case w:case I:console.warn("Unexpected mediaType: "+t);break;case M:we.unsetWhiteBoardRender(n);break;default:d.error("Unknown media type: "+t)}}},{key:"_setMediaRender",value:function(e,t,n,i,r){if(e==_.userInfo.userId)t==w?ce.setLocalVideoRender(n,i,r):t==I?le.setLocalScreenShareRender(i):d.error("Unexpected media type: "+t);else{var o=this.findDownPcByUserMeida(e,t,n);o?(i.srcObject=o.mediaStream,o.videoEle=i,this.curSpkDevId&&Te.setAudioSpeaker(i)):d.error("Cannot find down peer connection!")}}},{key:"_unsetMediaRender",value:function(e,t){if(t&&"srcObject"in t)if(e==_.userInfo.userId)if(t.srcObject){var n,i=Me(t.srcObject.getTracks());try{for(i.s();!(n=i.n()).done;){n.value.stop()}}catch(e){i.e(e)}finally{i.f()}t.srcObject=null}else d.warn("Invalid srcObject!");else t.srcObject=null;else d.error("Invalid videoEle!")}},{key:"onNotifyUserJoinGroup",value:function(e,t){se.trigger("onUserJoinGroup",e.user_id)}},{key:"onNotifyUserLeaveGroup",value:function(e,t){se.trigger("onUserLeaveGroup",e.user_id)}},{key:"_getEventType",value:function(e,t,n,i){return(e==O?F:G)+b(t,n,i)}},{key:"onRecvStreamRes",value:function(e,t){try{if(0===e.group_id.length||0===e.media_id.length)throw"Invalid recv stream response!!!"+e;var n=null;if(!e.stream_server)throw"Cannot find 'stream_server' in msg!";if(!(n=p("ws",e.stream_server)))throw"Cannot find webrtc gateway: "+e.stream_server;if(e.media_type!==M){var i=this.downPcMap.get(e.bind_id);if(e.recv===D)i?i.stopRecvStream({userId:e.user_id,mediaType:e.media_type,mediaId:e.media_id}):d.warn("Have not recv the media, do nothing!");else{if(e.recv!==O)throw"Unknown media operation: "+e.recv;i||(i=new DownPeerConnection(e.bind_id),this.downPcMap.set(e.bind_id,i),d.log("Add a down peer connection, count = "+this.downPcMap.size)),i.startRecvStream({userId:e.user_id,mediaType:e.media_type,mediaId:e.media_id,streamId:e.stream_id,streamServer:n,streamToken:e.subscribe_token})}}else e.recv===O?we.onStartRecvWhiteBoardRes({userId:e.user_id,mediaType:e.media_type,mediaId:e.media_id,streamId:e.stream_id,streamServer:n,streamToken:e.subscribe_token}):we.onStopRecvWhiteBoardRes({userId:e.user_id,mediaType:e.media_type,mediaId:e.media_id,streamId:e.stream_id});se.trigger(this._getEventType(e.recv,e.user_id,e.media_type,e.media_id),C)}catch(t){d.error(t),se.trigger(this._getEventType(e.recv,e.user_id,e.media_type,e.media_id),B)}}},{key:"onNotifyUserMediaState",value:function(e,t){if(e.media_type==I||e.media_type==S||e.media_type==w||e.media_type==M){var n={userId:e.user_id,mediaType:e.media_type,mediaId:e.media_id,mediaName:e.media_description};e.operation==R?se.trigger("onUnPublishMedia",n):e.operation==P&&se.trigger("onPublishMedia",n)}else d.warn("Unexpected media type: ",e.media_type)}},{key:"onNotifyGroupMediaStates",value:function(e,t){if(_.restoring)_.restoring=!1;else{var n,i=[],r=Me(e.user_info);try{for(r.s();!(n=r.n()).done;){var o=n.value;i.push(o.user_id)}}catch(e){r.e(e)}finally{r.f()}i.length>0&&se.trigger("onGroupUserList",i);var s,a=Me(e.user_info);try{for(a.s();!(s=a.n()).done;){var u=s.value;if(!(u.media_info.length<=0)){var d,c=Me(u.media_info);try{for(c.s();!(d=c.n()).done;){var l=d.value,h={userId:u.user_id,mediaType:l.media_type,mediaId:l.media_id,mediaName:l.media_description};se.trigger("onPublishMedia",h)}}catch(e){c.e(e)}finally{c.f()}}}}catch(e){a.e(e)}finally{a.f()}}}}]),e}(),de()(Se.prototype,"tryRestoreMediaRender",[v],Object.getOwnPropertyDescriptor(Se.prototype,"tryRestoreMediaRender"),Se.prototype),de()(Se.prototype,"_onRestoreDownTrack",[v],Object.getOwnPropertyDescriptor(Se.prototype,"_onRestoreDownTrack"),Se.prototype),de()(Se.prototype,"startPublishMedia",[v],Object.getOwnPropertyDescriptor(Se.prototype,"startPublishMedia"),Se.prototype),de()(Se.prototype,"stopPublishMedia",[v],Object.getOwnPropertyDescriptor(Se.prototype,"stopPublishMedia"),Se.prototype),de()(Se.prototype,"startReceiveMedia",[v],Object.getOwnPropertyDescriptor(Se.prototype,"startReceiveMedia"),Se.prototype),de()(Se.prototype,"stopReceiveMedia",[v],Object.getOwnPropertyDescriptor(Se.prototype,"stopReceiveMedia"),Se.prototype),de()(Se.prototype,"setMediaRender",[v],Object.getOwnPropertyDescriptor(Se.prototype,"setMediaRender"),Se.prototype),de()(Se.prototype,"unsetMediaRender",[v],Object.getOwnPropertyDescriptor(Se.prototype,"unsetMediaRender"),Se.prototype),Se);function De(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Oe(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Oe(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var i=0,r=function(){};return{s:r,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==n.return||n.return()}finally{if(a)throw o}}}}function Oe(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}var Te=new(function(){function e(){s()(this,e),this.curMicDevId=null,this.curSpkDevId=null,this.audioMagicValue=0,this.recvMagicAudio=!1}return u()(e,[{key:"startPublishAudio",value:function(e){if(e){this.setCurMicDevId(e);var t=null;t=0==this.audioMagicValue?"appdef_mic":"appdef_mic_magic",xe.sendPublishMediaReq(P,S,t)}else d.error("Invalid devId!")}},{key:"stopPublishAudio",value:function(e){var t=null;t=0==this.audioMagicValue?"appdef_mic":"appdef_mic_magic",xe.sendPublishMediaReq(R,S,t)}},{key:"startReceiveAudio",value:function(e,t){if(e&&t)return xe.sendRecvMediaReq(O,e,S,t),ae(F+b(e,S,t));d.error("Invalid srcUserId or mediaId!")}},{key:"stopReceiveAudio",value:function(e,t){if(e&&t)return xe.sendRecvMediaReq(D,e,S,t),ae(G+b(userId,S,t));d.error("Invalid srcUserId or mediaId!")}},{key:"chooseSpkDevice",value:function(e){this.curSpkDevId=e;var t,n=De(Pe.downPcMap.values());try{for(n.s();!(t=n.n()).done;){var i=t.value;i.videoEle&&this.setAudioSpeaker(i.videoEle)}}catch(e){n.e(e)}finally{n.f()}}},{key:"setSendMagicAudioValue",value:function(e){if(this.audioMagicValue!=e){this.audioMagicValue=e,d.log("Set send audio magic to "+e);var t,n=De(Pe.upPcMap);try{for(n.s();!(t=n.n()).done;){var i,r=t.value,o=De(r.upTracks);try{for(o.s();!(i=o.n()).done;){var s=i.value;if(s.mediaType==S){xe.sendSetAudioMagic(r.websocket,s.streamId,e);break}}}catch(e){o.e(e)}finally{o.f()}}}catch(e){n.e(e)}finally{n.f()}}}},{key:"setRecvMagicAudioMode",value:function(e){e==W||e==E||e==A?(d.log("Set recv audio magic mode: "+e),this.recvMagicAudio=e):d.error("Invalid recv audio magic mode: "+e)}},{key:"setAudioSpeaker",value:function(e){var t=this;void 0!==e.sinkId?e.setSinkId(this.curSpkDevId).then((function(){d.log("Set speaker "+t.curSpkDevId+" success.")})).catch((function(e){d.error("Set speaker "+t.curSpkDevId+" failed!",e)})):d.error("Invalid media element!")}},{key:"setCurMicDevId",value:function(e){e?this.curMicDevId=e:d.error("Invalid microphone device!")}},{key:"getCurMicDevId",value:function(){return this.curMicDevId}},{key:"getCurSpkDevId",value:function(){return this.curSpkDevId}},{key:"buildConstraints",value:function(e){return{audio:{deviceId:e}}}}]),e}()),xe=new(function(){function e(){s()(this,e)}return u()(e,[{key:"sendJoinGroupReq",value:function(e){var t={business:"GS",id:14100,group_id:e};_.websocket.send(JSON.stringify(t))}},{key:"sendLeaveGroupReq",value:function(){_.websocket.send(JSON.stringify({business:"GS",id:14102}))}},{key:"sendResolutionReport",value:function(e,t){var n={business:"SS",id:18004,stream_id:t.streamId,width:t.width,height:t.height,channel_type:t.channelType,report_type:t.reportType};e.send(JSON.stringify(n))}},{key:"sendLogoutReq",value:function(){_.websocket.send(JSON.stringify({business:"BASE",id:10002}))}},{key:"sendLoginReq",value:function(e){var t={business:"BASE",id:1e4,app_id:e.appId,company_id:e.companyId,token:e.token,user_id:e.userId,client_guid:f(),os_type:e.osType,mutex_type:e.mutexType,force_login:e.forceLogin,registered_user:e.registered,protocol_version:"0.0.1",sdk_type:26,extend_info:e.extendInfo};_.websocket.send(JSON.stringify(t))}},{key:"sendPublishMediaReq",value:function(e,t,n){var i={business:"GS",id:14104,media_type:t,media_id:n,operation:e};_.websocket.send(JSON.stringify(i))}},{key:"sendRecvMediaReq",value:function(e,t,n,i){var r={business:"SS",id:18002,group_id:_.userInfo.groupId,user_id:t,media_type:n,media_id:i,recv:e};n==S&&(Te.recvMagicAudio==A?-1==i.indexOf("_magic")&&(r.media_id=i+"_magic"):Te.recvMagicAudio==E&&-1!=i.indexOf("_magic")&&(r.media_id=i.substr(0,i.length-6))),r.media_owner=n==M?"group":"user",_.websocket.send(JSON.stringify(r))}},{key:"sendRecvWhiteboardReq",value:function(e,t,n){var i={business:"SS",id:18002,group_id:_.userInfo.groupId,media_type:t,media_id:n,recv:e,source_type:1};_.websocket.send(JSON.stringify(i))}},{key:"sendCreateWhiteboardReq",value:function(e){var t={business:"WBS",id:19e3,cli_seq_id:1,board_type:0,width:1280,height:768,file_path:"",convert_file_path:"",page:1};t=Object.assign(t,e),_.websocket.send(JSON.stringify(t))}},{key:"sendCloseWhiteboardReq",value:function(e){var t={business:"WBS",id:19002,whiteboard_id:e};t=Object.assign(t,parmas),_.websocket.send(JSON.stringify(t))}},{key:"sendNotifySendStreamRes",value:function(e){var t={business:"SS",id:18001,stream_id:e.streamId,send:e.send,result:e.result};_.websocket.send(JSON.stringify(t))}},{key:"sendLogoutRecvChannelReq",value:function(e,t){var n={business:"SS",id:19012,stream_id:t,client_id:"{"+_.userInfo.appId+";"+_.userInfo.groupId+"};"+_.userInfo.userId};e.send(JSON.stringify(n))}},{key:"sendLoginRecvChannelReq",value:function(e,t,n){var i={business:"WBS",id:19004,stream_id:t.streamId,stream_token:t.streamToken,media_type:t.media_type,media_id:t.media_id,client_id:"{"+_.userInfo.appId+";"+_.userInfo.groupId+"};"+_.userInfo.userId,version:"1.0.0",bind_id:n};e.send(JSON.stringify(i))}},{key:"sendSdpInfo",value:function(e,t,n){var i={business:"SS",id:19008,type:t.type,pc_id:n,sdp:t.sdp};e.send(JSON.stringify(i))}},{key:"sendCandidate",value:function(e,t,n){var i={business:"SS",id:19008,pc_id:n,candidate:t.candidate.candidate,sdpMid:t.candidate.sdpMid,sdpMLineIndex:t.candidate.sdpMLineIndex};e.send(JSON.stringify(i))}},{key:"sendLoginSendChannelReq",value:function(e,t,n){var i={business:"WBS",id:19006,stream_id:t.streamId,stream_token:t.streamToken,media_type:t.mediaType,media_id:t.mediaId,client_id:_.getClientId(),version:"1.0.0",bind_id:n};e.send(JSON.stringify(i))}},{key:"sendSetAudioMagic",value:function(e,t,n){var i={business:"SS",id:19010,stream_id:t,client_id:_.getClientId(),param:[{param_type:"SoundTouch",param_value:n.toString()}]};e.send(JSON.stringify(i))}},{key:"SendSetAudioMagicReq",value:function(e,t,n){var i={business:"SS",id:19010,stream_id:t,client_id:_.getClientId(),param:[{param_type:"SoundTouch",param_value:n.toString()}]};e.send(JSON.stringify(i))}},{key:"sendGetWhiteBoardFullDataReq",value:function(e){e.send(JSON.stringify({id:30003}))}},{key:"sendGetWhiteBoardFileUrlReq",value:function(e){var t={business:"STORE",id:20006,file_path:e};_.websocket.send(JSON.stringify(t))}},{key:"sendUserMsg",value:function(e){var t={business:"SG",id:11e3,dst_user_id:e.dstUserId,msg_id:1024,msg:e.msg};_.websocket.send(JSON.stringify(t))}},{key:"sendUserMsgAck",value:function(e){var t={business:"SG",id:11004,src_user_id:e.src_user_id,msg_id:e.msg_id};_.websocket.send(JSON.stringify(t))}},{key:"sendGroupMsgWithWhiteList",value:function(e){var t={business:"SG",id:11006,group_id:e.groupId,white_list:e.whiteList,msg_id:1024,msg:e.msg};_.websocket.send(JSON.stringify(t))}},{key:"sendGroupMsgWithBlackList",value:function(e){var t={business:"SG",id:11006,group_id:e.groupId,black_list:e.blackList,msg_id:1024,msg:e.msg};_.websocket.send(JSON.stringify(t))}},{key:"sendGroupMsg",value:function(e){var t={business:"SG",id:11006,group_id:e.groupId,msg_id:1024,msg:e.msg};_.websocket.send(JSON.stringify(t))}},{key:"sendGroupMsgAck",value:function(e){var t={business:"SG",id:11010,group_id:e.group_id,src_user_id:e.src_user_id,msg_id:e.msg_id};_.websocket.send(JSON.stringify(t))}},{key:"sendKickOutRes",value:function(){_.websocket.send(JSON.stringify({business:"PS",id:12008}))}}]),e}()),We=new(function(){function e(){s()(this,e),this.serverDomain="https://fspwxlite.hst.com:443/weapp/webrtc_room",this.requestNum=0,this.heart=0,this.heartBeatReq=0,this.requestSeq=0,this.requestTask=[]}return u()(e,[{key:"request",value:function(e){var t=this;t.requestNum++;var n=wx.request({url:t.serverDomain+e.url,data:e.data||{},method:"POST",header:{"content-type":"application/json"},success:function(t){t.data.code?(console.error("服务器请求失败, url="+e.url+", params = "+(e.data?JSON.stringify(e.data):"")+", 错误信息="+JSON.stringify(t)),e.fail&&e.fail({errCode:t.data.code,errMsg:t.data.message})):e.success&&e.success(t)},fail:function(t){console.error("请求失败, url="+e.url+", 错误信息="+JSON.stringify(t)),e.fail&&e.fail(t)},complete:function(){t.requestNum--,console.log("complete requestNum: ",t.requestNum)}});return t.requestTask[t.requestSeq++]=n,n}},{key:"clearRequest",value:function(){for(var e=0;e<this.requestSeq;e++)this.requestTask[e].abort();this.requestTask=[],this.requestSeq=0}},{key:"getLoginInfo",value:function(e,t,n){var i={};e&&(i.userID=e),this.request({url:"/get_login_info",data:i,success:t,fail:n})}},{key:"getRoomList",value:function(e,t,n,i){this.request({url:"/get_room_list",data:{index:e,count:t,roomType:"trtc"},success:n,fail:i})}},{key:"createRoom",value:function(e,t,n,i){console.log("roomInfo",t);this.request({url:"/create_room",data:{userID:e,roomInfo:t,roomType:"trtc"},success:function(e){n&&n(e)},fail:i})}},{key:"enterRoom",value:function(e,t,n,i){this.request({url:"/enter_room",data:{userID:e,roomID:t},success:function(e){n&&n(e)},fail:i})}},{key:"quitRoom",value:function(e,t,n,i){this.request({url:"/quit_room",data:{userID:e,roomID:t},success:n,fail:i})}},{key:"startHeartBeat",value:function(e,t,n,i){this.heart="1",this.heartBeat(e,t,n,i)}},{key:"stopHeartBeat",value:function(){this.heart="",this.heartBeatReq&&(console.log("停止心跳"),this.heartBeatReq.abort(),this.heartBeatReq=null)}},{key:"heartBeat",value:function(e,t,n,i){var r=this;r.heart?r.heartBeatReq=r.request({url:"/heartbeat",data:{userID:e,roomID:t},success:function(o){r.heart&&(console.log("心跳成功"),n&&n(o),setTimeout((function(){r.heartBeat(e,t,n,i)}),7e3))},fail:function(o){i&&i(o),r.heart&&setTimeout((function(){r.heartBeat(e,t,n,i)}),7e3)}}):r.clearRequest()}}]),e}()),Ee=new r.a({init:"uninit",transitions:[{name:"doInit",from:["uninit","restoring"],to:"initing"},{name:"initSuccess",from:"initing",to:"inited"},{name:"initFailed",from:"initing",to:"uninit"},{name:"doLogin",from:"inited",to:"logining"},{name:"loginSuccess",from:"logining",to:"logined"},{name:"loginFailed",from:"logining",to:"inited"},{name:"doJoin",from:"logined",to:"joining"},{name:"joinSuccess",from:"joining",to:"joined"},{name:"joinFailed",from:"joining",to:"logined"},{name:"doLeave",from:"joined",to:"leaving"},{name:"leaveSuccess",from:"leaving",to:"logined"},{name:"leaveFailed",from:"leaving",to:"joined"},{name:"doLogout",from:"logined",to:"logouting"},{name:"logoutSuccess",from:"logouting",to:"inited"},{name:"logoutFailed",from:"logouting",to:"logined"},{name:"doDestroy",from:"inited",to:"uninit"},{name:"doRestore",from:"joined",to:"restoring"}],data:{registered:!1},methods:{onWebSocketClosed:function(){d.warn("Signalling websocket closed, state: "+this.state),_.websocket.close(),_.websocket=null,"joined"==this.state&&this.doRestore()},onWebSocketOpened:function(){var e={appId:_.userInfo.appId,userId:_.userInfo.userId,token:_.loginParams.token,companyId:_.loginParams.companyId,osType:"webchat",mutexType:_.loginParams.mutexType,forceLogin:_.loginParams.forceLogin,registered:_.loginParams.registered,extendInfo:_.loginParams.extendInfo};xe.sendLoginReq(e)},onLeaveGroup:function(){_.userInfo.groupId=null,we.reinitialize()},onLogout:function(){this.onLeaveGroup(),_.userInfo.userId=null},onDestroy:function(){this.onLogout(),_.userInfo.appId=null,_.userInfo.token=null,_.userInfo.companyId=null,_.websocket&&(_.websocket.close(),_.websocket=null)},onLoginRes:function(e,t){var n=this;0==e.result?We.getLoginInfo(_.userInfo.userId,(function(e){n.loginSuccess({sdkAppId:e.data.sdkAppID,userSig:e.data.userSig,accountType:e.data.accountType})}),(function(e){n.loginFailed()})):n.loginFailed(e.result)},onLogoutRes:function(e,t){0==e.result?this.logoutSuccess():this.logoutFailed()},onJoinGroupRes:function(e,t){var n=this;0==e.result?We.getLoginInfo(e.room_id+"_"+_.userInfo.userId,(function(t){var i=t.data.sdkAppID,r=t.data.userSig;We.createRoom(_.userInfo.userId,_.userInfo.groupId,(function(t){console.log("createRoom success."+JSON.stringify(t)),n.joinSuccess({serverRoomId:t.data.roomID,serverUserId:e.room_id+"_"+_.userInfo.userId,txRoomId:e.room_id,privateMapKey:t.data.privateMapKey,sdkAppId:i,userSig:r})}),(function(e){console.error("Creat room failed!"),n.joinFailed()}))}),(function(e){console.error("Get login info failed!"),n.joinFailed()})):this.joinFailed()},onLeaveGroupRes:function(e,t){0==e.result?this.leaveSuccess():this.leaveFailed()},onForceLogout:function(e,t){se.trigger("onUserForceLogout")},onKickOut:function(e,t){xe.sendKickOutRes(),se.trigger("onKickOut"),this.onDestroy()},onDoInit:function(e,t){var n=this;this.registered||(_.msgDispatcher.addMsgHandler(10001,this.onLoginRes.bind(this)),_.msgDispatcher.addMsgHandler(10003,this.onLogoutRes.bind(this)),_.msgDispatcher.addMsgHandler(10004,this.onForceLogout.bind(this)),_.msgDispatcher.addMsgHandler(12007,this.onKickOut.bind(this)),_.msgDispatcher.addMsgHandler(14101,this.onJoinGroupRes.bind(this)),_.msgDispatcher.addMsgHandler(14103,this.onLeaveGroupRes.bind(this)),this.registered=!0),g((function(){n.initSuccess()}))},onTransition:function(e){d.state("transition: "+e.transition+", from "+e.from+" to "+e.to)},onInitSuccess:function(e,t){var n=this;if(_.restoring){var i={userId:_.userInfo.userId,appId:_.userInfo.appId,companyId:_.loginParams.companyId,token:_.loginParams.token,forceLogin:!0,mutexType:_.loginParams.mutexType,extendInfo:_.loginParams.extendInfo,accessUrl:_.loginParams.accessUrl};g((function(){n.doLogin(i)}))}else se.trigger(N,C)},onInitFailed:function(e,t){_.restoring?(_.restoring=!1,d.warn("Restoring failed for init!")):se.trigger(N,B)},onDoLogin:function(e,t){var n=this;t.userId?_.userInfo.userId=t.userId:g((function(){n.loginFailed("Invalid userId!")})),t.appId?_.userInfo.appId=t.appId:g((function(){n.loginFailed("Invalid appId!")})),t.token?_.loginParams.token=t.token:g((function(){n.loginFailed("Invalid token!")})),t.accessUrl||(t.accessUrl="https://access.paas.hst.com/server/address"),_.loginParams.accessUrl=t.accessUrl,t.forceLogin&&(_.loginParams.forceLogin=t.forceLogin?1:0),t.extendInfo&&(_.loginParams.extendInfo=t.extendInfo),t.companyId&&(_.loginParams.companyId=t.companyId),t.mutexType&&(_.loginParams.mutexType=t.mutexType);var i=this;try{wx.request({url:_.buildGetGateWayUrl(t.accessUrl),data:{},method:"GET",header:{"content-type":"application/json"},success:function(e){if(console.log("Response from access service: "+JSON.stringify(e)),0!=e.data.code)throw"Get websocket gateway error!";var t=p("ws",e.data.result);if(!t)throw"Cannot find websocket gateway from response!";var n={addrUrl:[t],handler:_.msgDispatcher,opened:function(){i.onWebSocketOpened()},closed:function(){i.onWebSocketClosed()},error:function(){i.loginFailed("Websocket error!")}};_.websocket=new k(n)},fail:function(e){throw"Get websocket gateway failed"},complete:function(e){console.log("Get websocket gateway complete")}})}catch(e){g((function(){i.loginFailed(e)}))}},onLoginSuccess:function(e,t){var n=this;_.restoring?g((function(){n.doJoin(_.userInfo.groupId)})):se.trigger(L,C,t)},onLoginFailed:function(e,t){d.error("Login failed: "+t),_.restoring?(_.restoring=!1,d.warn("Restoring failed for login!")):se.trigger(L,B)},onDoJoin:function(e,t){xe.sendJoinGroupReq(t),_.userInfo.groupId=t},onJoinSuccess:function(e,t){_.restoring?d.log("Restoring success."):se.trigger(U,C,t)},onJoinFailed:function(e,t){_.restoring?(_.restoring=!1,d.warn("Restoring failed for join group!")):se.trigger(U,B)},onDoLeave:function(e,t){xe.sendLeaveGroupReq()},onLeaveSuccess:function(e,t){this.onLeaveGroup(),se.trigger(q,C)},onLeaveFailed:function(e,t){se.trigger(q,B)},onDoLogout:function(e,t){xe.sendLogoutReq()},onLogoutSuccess:function(e,t){this.onLogout(),se.trigger(j,C)},onLogoutFailed:function(e,t){se.trigger(j,B)},onDoDestroy:function(e,t){this.onDestroy()},onRestoring:function(e,t){var n=this;_.restoring=!0,g((function(){n.doInit()}))}}});function Ae(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Ce(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Ce(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var i=0,r=function(){};return{s:r,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==n.return||n.return()}finally{if(a)throw o}}}}function Ce(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}var Be=new(function(){function e(){s()(this,e),this.cachedUserList=null,_.msgDispatcher.addMsgHandler(12120,this.onGetOnlineUsersRes.bind(this)),_.msgDispatcher.addMsgHandler(12123,this.onOnlineUsersNotify.bind(this)),_.msgDispatcher.addMsgHandler(14001,this.onInviteRes.bind(this)),_.msgDispatcher.addMsgHandler(14002,this.onNotifyInvite.bind(this)),_.msgDispatcher.addMsgHandler(14004,this.onNotifyIgnoreInvite.bind(this)),_.msgDispatcher.addMsgHandler(14007,this.onCancelInviteRes.bind(this)),_.msgDispatcher.addMsgHandler(14008,this.onNotifyCancelInvite.bind(this))}return u()(e,[{key:"getOnlineUsers",value:function(){var e={business:"PS",id:12119,seq_id:Math.floor(4096*Math.random())};_.websocket.send(JSON.stringify(e))}},{key:"onGetOnlineUsersRes",value:function(e){if(0==e.result){var t,n={totalPages:e.page_info.total_pages,curPage:e.page_info.cur_page},i=[],r=Ae(e.member_state_list);try{for(r.s();!(t=r.n()).done;){var o,s=t.value,a={userId:s.uid,onlineInfo:[]},u=Ae(s.online_info);try{for(u.s();!(o=u.n()).done;){var d=o.value,c={mutexType:d.mutex_type,customState:d.custom_state,state:d.state,extendInfo:d.extend_info};a.onlineInfo.push(c)}}catch(e){u.e(e)}finally{u.f()}i.push(a)}}catch(e){r.e(e)}finally{r.f()}var l={pageInfo:n,userInfo:i};se.trigger(H,C,l),this.cachedUserList=null}else se.trigger(H,B)}},{key:"invite",value:function(e){var t,n={business:"GS",id:14e3,seq_id:e.seqId,group_id:e.groupId,callee_info:[],extend_info:e.extendInfo},i=Ae(e.calleeInfo);try{for(i.s();!(t=i.n()).done;){var r=t.value;n.callee_info.push({user_id:r})}}catch(e){i.e(e)}finally{i.f()}_.websocket.send(JSON.stringify(n))}},{key:"replyInvite",value:function(e){var t={business:"GS",id:14003,seq_id:e.seqId,group_id:e.groupId,operate:e.operation,extend_info:e.extendInfo};_.websocket.send(JSON.stringify(t))}},{key:"cancelInvite",value:function(e){var t={business:"GS",id:14006,seq_id:e.seqId,group_id:e.groupId,callee_info:e.calleeInfo};_.websocket.send(JSON.stringify(t))}},{key:"onOnlineUsersNotify",value:function(e){e.result;var t={userId:e.user_id,mutexType:e.mutex_type,state:e.operation,customState:e.custom_state,extendInfo:e.extend_info};se.trigger("onOnlineUserState",t)}},{key:"onInviteRes",value:function(e){var t={seqId:e.seq_id,userId:e.user_id,result:e.result};se.trigger("onInviteReply",t)}},{key:"onNotifyInvite",value:function(e){var t={seqId:e.seq_id,groupId:e.group_id,userId:e.user_id,userName:e.user_name,extendInfo:e.extend_info};se.trigger("onCommingInvite",t)}},{key:"onNotifyIgnoreInvite",value:function(e){var t={groupId:e.group_id,userId:e.user_id,userName:e.user_name};se.trigger(V,t)}},{key:"onCancelInviteRes",value:function(e){var t=e.result,n={seqId:e.seq_id,userId:e.user_id};se.trigger(z,t,n)}},{key:"onNotifyCancelInvite",value:function(e){var t={seqId:e.seq_id,userId:e.user_id};se.trigger(Y,t)}}]),e}());var Ne,Le,je,Ue=new(function(){function e(){s()(this,e),_.msgDispatcher.addMsgHandler(11e3,this._onRecvUserMsg.bind(this)),_.msgDispatcher.addMsgHandler(11006,this._onRecvGroupMsg.bind(this)),_.msgDispatcher.addMsgHandler(11010,this._onRecvServerAck.bind(this))}return u()(e,[{key:"sendUserMsg",value:function(e){xe.sendUserMsg(e)}},{key:"sendGroupMsgWithWhiteList",value:function(e){xe.sendGroupMsgWithWhiteList(e)}},{key:"sendGroupMsgWithBlackList",value:function(e){xe.sendGroupMsgWithBlackList(e)}},{key:"sendGroupMsg",value:function(e){xe.sendGroupMsg(e)}},{key:"_onRecvUserMsg",value:function(e){se.trigger("onRecvUserMsg",{srcUserId:e.src_user_id,msg:e.msg,msgId:e.msg_id}),xe.sendUserMsgAck(e)}},{key:"_onRecvGroupMsg",value:function(e){se.trigger("onRecvGroupMsg",{srcUserId:e.src_user_id,groupId:e.group_id,msg:e.msg,msgId:e.msg_id}),xe.sendGroupMsgAck(e)}},{key:"_onRecvServerAck",value:function(e){}}]),e}());function qe(){0}(Ne=qe).prototype.subEvent=function(){console.log("Subscribe event: ",arguments[0]),se.on.apply(se,arguments)},Ne.prototype.unsubEvent=function(){console.log("Unsubscribe event: ",arguments[0]),se.off.apply(se,arguments)},(Le=qe).prototype.init=function(e){return Ee.doInit(e),ae(N)},Le.prototype.login=function(e){return Ee.doLogin(e),ae(L)},Le.prototype.joinGroup=function(e){return Ee.doJoin(e),ae(U)},Le.prototype.leaveGroup=function(){return Ee.doLeave(),ae(q)},Le.prototype.logout=function(){return Ee.doLogout(),ae(j)},Le.prototype.destroy=function(){Ee.doDestroy()},(je=qe).prototype.startPublishMedia=function(e,t,n){Pe.startPublishMedia(e,t,n)},je.prototype.stopPublishMedia=function(e,t){Pe.stopPublishMedia(e,t)},je.prototype.startReceiveMedia=function(e,t,n){return Pe.startReceiveMedia(e,t,n)},je.prototype.stopReceiveMedia=function(e,t,n){return Pe.stopReceiveMedia(e,t,n)},je.prototype.setMediaRender=function(e,t,n,i,r){Pe.setMediaRender(e,t,n,i,r)},je.prototype.unsetMediaRender=function(e,t,n){Pe.unsetMediaRender(e,t,n)},je.prototype.setSendMagicAudioValue=function(e){Te.setSendMagicAudioValue(e)},je.prototype.setRecvMagicAudioMode=function(e){Te.setRecvMagicAudioMode(e)},je.prototype.createWhiteBoard=function(e){return we.createWhiteBoard(e)},je.prototype.closeWhiteBoard=function(e){return we.closeWhiteBoard(e)},je.prototype.setWhiteBoardDisplayMode=function(e,t,n){return we.setDisplayMode(e,t,n)},function(e){e.prototype.getOnlineUsers=function(){return Be.getOnlineUsers(),ae(H)},e.prototype.invite=function(e){return Be.invite(e),ae(J)},e.prototype.replyInvite=function(e){Be.replyInvite(e)},e.prototype.cancelInvite=function(e){return Be.cancelInvite(e),ae(z)}}(qe),function(e){e.prototype.MediaType={SCREEN_SHARE:0,AUDIO:1,VIDEO:2,TRANSPARENT_DATA:3,WHITE_BOARD:4},e.prototype.OnlineType={OFFLINE:0,ONLINE:1},e.prototype.DisplayMode={DBWZ:1,DBSY:2,DBSF:3}}(qe),function(e){e.prototype.sendUserMsg=function(e){Ue.sendUserMsg(e)},e.prototype.sendGroupMsgWithWhiteList=function(e){Ue.sendGroupMsgWithWhiteList(e)},e.prototype.sendGroupMsgWithBlackList=function(e){Ue.sendGroupMsgWithBlackList(e)},e.prototype.sendGroupMsg=function(e){Ue.sendGroupMsg(e)}}(qe);t.default=qe}]).default;
//# sourceMappingURL=HstWxRtcEngine.js.map