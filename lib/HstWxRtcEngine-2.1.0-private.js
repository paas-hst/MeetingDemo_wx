module.exports=function(e){var t={};function i(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,i),r.l=!0,r.exports}return i.m=e,i.c=t,i.d=function(e,t,n){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)i.d(n,r,function(t){return e[t]}.bind(null,r));return n},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=7)}([function(e,t){e.exports=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},e.exports.default=e.exports,e.exports.__esModule=!0},function(e,t){function i(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}e.exports=function(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e},e.exports.default=e.exports,e.exports.__esModule=!0},function(e,t){e.exports=function(e,t,i,n,r){var s={};return Object.keys(n).forEach((function(e){s[e]=n[e]})),s.enumerable=!!s.enumerable,s.configurable=!!s.configurable,("value"in s||s.initializer)&&(s.writable=!0),s=i.slice().reverse().reduce((function(i,n){return n(e,t,i)||i}),s),r&&void 0!==s.initializer&&(s.value=s.initializer?s.initializer.call(r):void 0,s.initializer=void 0),void 0===s.initializer&&(Object.defineProperty(e,t,s),s=null),s},e.exports.default=e.exports,e.exports.__esModule=!0},function(e,t){e.exports=function(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e},e.exports.default=e.exports,e.exports.__esModule=!0},function(e,t){e.exports=function(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,n=new Array(t);i<t;i++)n[i]=e[i];return n},e.exports.default=e.exports,e.exports.__esModule=!0},function(e,t,i){var n;n=function(){return function(e){var t={};function i(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,i),r.l=!0,r.exports}return i.m=e,i.c=t,i.i=function(e){return e},i.d=function(e,t,n){i.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:n})},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=5)}([function(e,t,i){"use strict";e.exports=function(e,t){var i,n,r;for(i=1;i<arguments.length;i++)for(r in n=arguments[i])n.hasOwnProperty(r)&&(e[r]=n[r]);return e}},function(e,t,i){"use strict";var n=i(0);e.exports={build:function(e,t){var i,r,s,a=t.plugins;for(i=0,r=a.length;i<r;i++)(s=a[i]).methods&&n(e,s.methods),s.properties&&Object.defineProperties(e,s.properties)},hook:function(e,t,i){var n,r,s,a,o=e.config.plugins,d=[e.context];for(i&&(d=d.concat(i)),n=0,r=o.length;n<r;n++)a=o[n],(s=o[n][t])&&s.apply(a,d)}}},function(e,t,i){"use strict";function n(e){if(0===e.length)return e;var t,i,n=e.split(/[_-]/);if(1===n.length&&n[0][0].toLowerCase()===n[0][0])return e;for(i=n[0].toLowerCase(),t=1;t<n.length;t++)i=i+n[t].charAt(0).toUpperCase()+n[t].substring(1).toLowerCase();return i}n.prepended=function(e,t){return e+(t=n(t))[0].toUpperCase()+t.substring(1)},e.exports=n},function(e,t,i){"use strict";var n=i(0),r=i(2);function s(e,t){e=e||{},this.options=e,this.defaults=t.defaults,this.states=[],this.transitions=[],this.map={},this.lifecycle=this.configureLifecycle(),this.init=this.configureInitTransition(e.init),this.data=this.configureData(e.data),this.methods=this.configureMethods(e.methods),this.map[this.defaults.wildcard]={},this.configureTransitions(e.transitions||[]),this.plugins=this.configurePlugins(e.plugins,t.plugin)}n(s.prototype,{addState:function(e){this.map[e]||(this.states.push(e),this.addStateLifecycleNames(e),this.map[e]={})},addStateLifecycleNames:function(e){this.lifecycle.onEnter[e]=r.prepended("onEnter",e),this.lifecycle.onLeave[e]=r.prepended("onLeave",e),this.lifecycle.on[e]=r.prepended("on",e)},addTransition:function(e){this.transitions.indexOf(e)<0&&(this.transitions.push(e),this.addTransitionLifecycleNames(e))},addTransitionLifecycleNames:function(e){this.lifecycle.onBefore[e]=r.prepended("onBefore",e),this.lifecycle.onAfter[e]=r.prepended("onAfter",e),this.lifecycle.on[e]=r.prepended("on",e)},mapTransition:function(e){var t=e.name,i=e.from,n=e.to;return this.addState(i),"function"!=typeof n&&this.addState(n),this.addTransition(t),this.map[i][t]=e,e},configureLifecycle:function(){return{onBefore:{transition:"onBeforeTransition"},onAfter:{transition:"onAfterTransition"},onEnter:{state:"onEnterState"},onLeave:{state:"onLeaveState"},on:{transition:"onTransition"}}},configureInitTransition:function(e){return"string"==typeof e?this.mapTransition(n({},this.defaults.init,{to:e,active:!0})):"object"==typeof e?this.mapTransition(n({},this.defaults.init,e,{active:!0})):(this.addState(this.defaults.init.from),this.defaults.init)},configureData:function(e){return"function"==typeof e?e:"object"==typeof e?function(){return e}:function(){return{}}},configureMethods:function(e){return e||{}},configurePlugins:function(e,t){var i,n,r;for(i=0,n=(e=e||[]).length;i<n;i++)"function"==typeof(r=e[i])&&(e[i]=r=r()),r.configure&&r.configure(this);return e},configureTransitions:function(e){var t,i,n,r,s,a=this.defaults.wildcard;for(i=0;i<e.length;i++)for(n=e[i],r=Array.isArray(n.from)?n.from:[n.from||a],s=n.to||a,t=0;t<r.length;t++)this.mapTransition({name:n.name,from:r[t],to:s})},transitionFor:function(e,t){var i=this.defaults.wildcard;return this.map[e][t]||this.map[i][t]},transitionsFor:function(e){var t=this.defaults.wildcard;return Object.keys(this.map[e]).concat(Object.keys(this.map[t]))},allStates:function(){return this.states},allTransitions:function(){return this.transitions}}),e.exports=s},function(e,t,i){var n=i(0),r=i(6),s=i(1),a=[null,[]];function o(e,t){this.context=e,this.config=t,this.state=t.init.from,this.observers=[e]}n(o.prototype,{init:function(e){if(n(this.context,this.config.data.apply(this.context,e)),s.hook(this,"init"),this.config.init.active)return this.fire(this.config.init.name,[])},is:function(e){return Array.isArray(e)?e.indexOf(this.state)>=0:this.state===e},isPending:function(){return this.pending},can:function(e){return!this.isPending()&&!!this.seek(e)},cannot:function(e){return!this.can(e)},allStates:function(){return this.config.allStates()},allTransitions:function(){return this.config.allTransitions()},transitions:function(){return this.config.transitionsFor(this.state)},seek:function(e,t){var i=this.config.defaults.wildcard,n=this.config.transitionFor(this.state,e),r=n&&n.to;return"function"==typeof r?r.apply(this.context,t):r===i?this.state:r},fire:function(e,t){return this.transit(e,this.state,this.seek(e,t),t)},transit:function(e,t,i,n){var r=this.config.lifecycle,s=this.config.options.observeUnchangedState||t!==i;return i?this.isPending()?this.context.onPendingTransition(e,t,i):(this.config.addState(i),this.beginTransit(),n.unshift({transition:e,from:t,to:i,fsm:this.context}),this.observeEvents([this.observersForEvent(r.onBefore.transition),this.observersForEvent(r.onBefore[e]),s?this.observersForEvent(r.onLeave.state):a,s?this.observersForEvent(r.onLeave[t]):a,this.observersForEvent(r.on.transition),s?["doTransit",[this]]:a,s?this.observersForEvent(r.onEnter.state):a,s?this.observersForEvent(r.onEnter[i]):a,s?this.observersForEvent(r.on[i]):a,this.observersForEvent(r.onAfter.transition),this.observersForEvent(r.onAfter[e]),this.observersForEvent(r.on[e])],n)):this.context.onInvalidTransition(e,t,i)},beginTransit:function(){this.pending=!0},endTransit:function(e){return this.pending=!1,e},failTransit:function(e){throw this.pending=!1,e},doTransit:function(e){this.state=e.to},observe:function(e){if(2===e.length){var t={};t[e[0]]=e[1],this.observers.push(t)}else this.observers.push(e[0])},observersForEvent:function(e){for(var t,i=0,n=this.observers.length,r=[];i<n;i++)(t=this.observers[i])[e]&&r.push(t);return[e,r,!0]},observeEvents:function(e,t,i,n){if(0===e.length)return this.endTransit(void 0===n||n);var r=e[0][0],a=e[0][1],o=e[0][2];if(t[0].event=r,r&&o&&r!==i&&s.hook(this,"lifecycle",t),0===a.length)return e.shift(),this.observeEvents(e,t,r,n);var d=a.shift(),c=d[r].apply(d,t);return c&&"function"==typeof c.then?c.then(this.observeEvents.bind(this,e,t,r)).catch(this.failTransit.bind(this)):!1===c?this.endTransit(!1):this.observeEvents(e,t,r,c)},onInvalidTransition:function(e,t,i){throw new r("transition is invalid in current state",e,t,i,this.state)},onPendingTransition:function(e,t,i){throw new r("transition is invalid while previous transition is still in progress",e,t,i,this.state)}}),e.exports=o},function(e,t,i){"use strict";var n=i(0),r=i(2),s=i(1),a=i(3),o=i(4),d={is:function(e){return this._fsm.is(e)},can:function(e){return this._fsm.can(e)},cannot:function(e){return this._fsm.cannot(e)},observe:function(){return this._fsm.observe(arguments)},transitions:function(){return this._fsm.transitions()},allTransitions:function(){return this._fsm.allTransitions()},allStates:function(){return this._fsm.allStates()},onInvalidTransition:function(e,t,i){return this._fsm.onInvalidTransition(e,t,i)},onPendingTransition:function(e,t,i){return this._fsm.onPendingTransition(e,t,i)}},c={state:{configurable:!1,enumerable:!0,get:function(){return this._fsm.state},set:function(e){throw Error("use transitions to change state")}}};function h(e){return u(this||{},e)}function u(e,t){return l(e,new a(t,h)),e._fsm(),e}function l(e,t){if("object"!=typeof e||Array.isArray(e))throw Error("StateMachine can only be applied to objects");s.build(e,t),Object.defineProperties(e,c),n(e,d),n(e,t.methods),t.allTransitions().forEach((function(t){e[r(t)]=function(){return this._fsm.fire(t,[].slice.call(arguments))}})),e._fsm=function(){this._fsm=new o(this,t),this._fsm.init(arguments)}}h.version="3.0.1",h.factory=function(){var e,t;"function"==typeof arguments[0]?(e=arguments[0],t=arguments[1]||{}):(e=function(){this._fsm.apply(this,arguments)},t=arguments[0]||{});var i=new a(t,h);return l(e.prototype,i),e.prototype._fsm.config=i,e},h.apply=u,h.defaults={wildcard:"*",init:{name:"init",from:"none"}},e.exports=h},function(e,t,i){"use strict";e.exports=function(e,t,i,n,r){this.message=e,this.transition=t,this.from=i,this.to=n,this.current=r}}])},e.exports=n()},function(e,t,i){var n=i(8),r=i(9),s=i(10),a=i(11);e.exports=function(e){return n(e)||r(e)||s(e)||a()},e.exports.default=e.exports,e.exports.__esModule=!0},function(e,t,i){e.exports=i(12)},function(e,t,i){var n=i(4);e.exports=function(e){if(Array.isArray(e))return n(e)},e.exports.default=e.exports,e.exports.__esModule=!0},function(e,t){e.exports=function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)},e.exports.default=e.exports,e.exports.__esModule=!0},function(e,t,i){var n=i(4);e.exports=function(e,t){if(e){if("string"==typeof e)return n(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(e):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?n(e,t):void 0}},e.exports.default=e.exports,e.exports.__esModule=!0},function(e,t){e.exports=function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")},e.exports.default=e.exports,e.exports.__esModule=!0},function(e,t,i){"use strict";i.r(t);var n=i(5),r=i.n(n),s=i(0),a=i.n(s),o=i(1),d=i.n(o),c=new(function(){function e(){a()(this,e)}return d()(e,[{key:"state",value:function(e){console.info("%c"+this._getFormatter()+" "+e,"color: #FF6347")}},{key:"trace",value:function(e){console.info("%c"+this._getFormatter()+" "+e,"color: #008080")}},{key:"info",value:function(e){console.info(this._getFormatter()+" "+e)}},{key:"warn",value:function(e){console.warn(this._getFormatter()+" "+e)}},{key:"error",value:function(e){console.error(this._getFormatter()+" "+e)}},{key:"log",value:function(e){this.info(e)}},{key:"_getFormatter",value:function(){return this._dateFormat("[YY-MM-DD HH:mm:SS.sss]")}},{key:"_dateFormat",value:function(e){var t=new Date,i={"Y+":t.getFullYear().toString(),"M+":(t.getMonth()+1).toString(),"D+":t.getDate().toString(),"H+":t.getHours().toString(),"m+":t.getMinutes().toString(),"S+":t.getSeconds().toString(),"s+":t.getMilliseconds().toString()};for(var n in i){var r=new RegExp("("+n+")").exec(e);r&&(e=e.replace(r[1],1==r[1].length?i[n]:i[n].padStart(r[1].length,"0")))}return e}}]),e}()),h=function(){function e(){a()(this,e),this.handlerMap=new Map}return d()(e,[{key:"addMsgHandler",value:function(e,t){this.handlerMap[e]?c.error("Message: "+e+" handler already exists!"):this.handlerMap[e]=t}},{key:"removeMsgHandler",value:function(e){this.handlerMap[e]?this.handlerMap.delete(e):c.error("Cannot find message handler: "+e)}},{key:"clearMsgHandler",value:function(){this.handlerMap=new Map}},{key:"onMessage",value:function(e,t){try{e.id?this.handlerMap[e.id]?this.handlerMap[e.id](e,t):3e4!==e.id&&c.warn("No handler for msg: "+e.id):c.error("Unexpected!!!")}catch(e){console.error(e)}}}]),e}();function u(){function e(){return(65536*(1+Math.random())|0).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}function l(e){new Promise((function(e){e()})).then((function(){e()}))}function p(e,t,i){var n=i.value;return i.value=function(){for(var e="",i=0;i<arguments.length;i++)e+=e?", "+JSON.stringify(arguments[i]):JSON.stringify(arguments[i]);return e?c.trace("".concat(t,": ")+e):c.trace('"'.concat(t,'"')),n.apply(this,arguments)},i}var f=function(e,t,i,n){if(i&&n||(i=.25,n=.25),t<1)var r=parseInt(e[0].X)+(e[1].X-e[0].X)*i,s=parseInt(e[0].Y)+(e[1].Y-e[0].Y)*i;else r=parseInt(e[t].X)+(e[t+1].X-e[t-1].X)*i,s=parseInt(e[t].Y)+(e[t+1].Y-e[t-1].Y)*i;if(t>e.length-3)var a=e.length-1,o=parseInt(e[a].X)-(e[a].X-e[a-1].X)*n,d=parseInt(e[a].Y)-(e[a].Y-e[a-1].Y)*n;else o=parseInt(e[t+1].X)-(e[t+2].X-e[t].X)*n,d=parseInt(e[t+1].Y)-(e[t+2].Y-e[t].Y)*n;return{pA:{x:r,y:s},pB:{x:o,y:d}}};function g(e){var t;for(t="string"==typeof e?(parseInt(e)>>>0).toString(16).toLocaleUpperCase():parseInt(e).toString(16);t.length<6;)t="0"+t;var i=t.substring(t.length-2),n=t.substring(t.length-4,t.length-2);return"#"+t.substring(t.length-6,t.length-4)+n+i}function v(e,t,i){return e?"_"+e+"_"+t+"_"+i:"_"+t+"_"+i}var y=new(function(){function e(){a()(this,e),this.websocket=null,this.restoring=!1,this.userInfo={appId:null,groupId:null,userId:null},this.loginParams={accessUrl:"",token:null,companyId:"",forceLogin:0,extendInfo:"",mutexType:"web",registered:1,sessionId:""},this.mainWebsocketChannelId="",this.msgDispatcher=new h}return d()(e,[{key:"getClientId",value:function(){return"{"+this.userInfo.appId+";"+this.userInfo.groupId+"};"+this.userInfo.userId}},{key:"buildGetGateWayUrl",value:function(e){return e+"?appType=24&appId="+this.userInfo.appId+"&ver=2.1.0&comid="+this.loginParams.companyId+"&os=wechat&token="+this.loginParams.token}},{key:"buildGetProxyWayUrl",value:function(e){return e+"?appType=37&appId="+this.userInfo.appId+"&ver=2.1.0&comid="+this.loginParams.companyId+"&os=wechat&token="+this.loginParams.token}}]),e}()),m=i(3),_=i.n(m);function b(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}var k=new(function(){function e(){a()(this,e),this.curAddrUrl="",this.socket={},this.allSocket={},this.handlers=[],this.connected_hooks=[],this.closed_hooks=[],this.error_hooks=[],this.limitConnect=this.getTimer(),this.proxyIndex=0,this.timer=null;var t=new h;t.addMsgHandler("101",this._onConnectSuccess.bind(this)),this.handlers.push(t)}return d()(e,[{key:"_createWebsocket",value:function(e){var t=this,i=this.allSocket[e].addrUrl;if(this.curAddrUrl=i,!i)throw new Error("Can't find webscoket link !");var n={url:i,success:function(){c.info("Create websocket success.")},fail:function(e){c.error("Create websocket failed, url: "+t.curAddrUrl),console.error(e)},complete:function(){c.info("Create websocket complete.")}};this.socket=wx.connectSocket(n),this.socket?this._eventBind(e):c.error("Connect socket failed: "+this.curAddrUrl)}},{key:"_sendCreateProxyMsg",value:function(e){var t={id:100,backward_addr:this.allSocket[e].backward_addr,seq:e};this.socket&&1===this.socket.readyState?this.socket.send({data:JSON.stringify(t),success:function(e){},fail:function(e){console.warn("res",e),c.error("Send failed!"),resolve(!1)},complete:function(e){}}):c.warn("socket error")}},{key:"_eventBind",value:function(e){var t=this;this.socket.onOpen((function(i){c.warn("Websocket opened: "+t.curAddrUrl),console.error(i),t._sendCreateProxyMsg(e)})),this.socket.onClose((function(e){var i=arguments;c.warn("Websocket closed: "+t.curAddrUrl),console.error(e),t.closed_hooks.map((function(e){e(i)}))})),this.socket.onMessage((function(e){var i=JSON.parse(e.data),n=i.channel_id;103==i.id&&(i=JSON.parse(i.msg)),i.channel_id=n,3e4!=i.id&&c.log("===> Recv msg from "+t.curAddrUrl+": "+JSON.stringify(i)),t.handlers.map((function(e){e.onMessage(i)}))})),this.socket.onError((function(e){var i=arguments;c.warn("Error res",e),t.error_hooks.map((function(e){e(i)})),void 0!==t.socket&&t.socket.close()}))}},{key:"_onConnectSuccess",value:function(){var e=arguments;this.connected_hooks.map((function(t){t(e)}))}},{key:"createProxyConnect",value:function(e){var t=e.seq_id;if(this.allSocket[t])c.info("Proxy connect already exists !");else{var i=e.handler,n=void 0===i?{}:i,r=e.opened,s=void 0===r?function(){}:r,a=e.closed,o=void 0===a?function(){}:a,d=e.error,h=void 0===d?function(){}:d;this.handlers.push(n),this.connected_hooks.push(s),this.closed_hooks.push(o),this.error_hooks.push(h),this.allSocket[t]=function(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?b(Object(i),!0).forEach((function(t){_()(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):b(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}({},e),this.socket&&1===this.socket.readyState?this._sendCreateProxyMsg(t):this._createWebsocket(t)}}},{key:"reconnect",value:function(){var e=arguments,t=this;console.warn("start reconnect"),clearInterval(this.timer),this.timer=setInterval((function(){if(console.warn("this.socket",t.socket),t.proxyIndex>=10||t.socket&&1===t.socket.readyState)t.proxyIndex=0,clearInterval(t.timer),t.closed_hooks.map((function(t){t(e)}));else for(var i in t.proxyIndex++,console.warn("this.allSocket",t.allSocket),t.allSocket)t._createWebsocket(i)}),3e3)}},{key:"getTimer",value:function(){var e=[];return function(t){e.push((new Date).getTime());var i=(new Date).getTime();i-e[0]>5e3&&(e=[],t.apply(this,arguments))}}},{key:"send",value:function(e){this.socket&&1===this.socket.readyState?(c.log("<=== Send msg to "+this.curAddrUrl+": "+e),this.socket.send({data:e,success:function(e){},fail:function(e){c.error("Send failed!")},complete:function(e){}})):c.error("Send msg failed: "+e)}},{key:"close",value:function(){this.socket&&(this.socket.close(),this.socket=null)}}]),e}()),S=0,I=1,w=2,M=4,P=0,R=1,O=0,x=1,C={LINE:"line",CURVE:"curve",TEXT:"text",ERASER:"eraser",MASK_CURVE:"mask_curve"},D=0,T=1,E=2,W=0,B=1,A="EVENT_INIT",N="EVENT_LOGIN",j="EVENT_LOGOUT",U="EVENT_JOIN_GROUP",L="EVENT_LEAVE_GROUP",q="EVENT_START_RECV_MEDIA",G="EVENT_STOP_RECV_MEDIA",F="EVENT_GET_ONLINE_USERS",H="EVENT_INVITE",J="EVENT_NOTICE_IGNORE_INVITE",V="EVENT_CANCEL_INVITE",z="EVENT_NOTICE_CANCEL_INVITE",Y="EVENT_CREATE_WHITE_BOARD",X="EVENT_CLOSE_WHITE_BOARD",K=1,$=2,Z=3;function Q(e,t){var i="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=function(e,t){if(!e)return;if("string"==typeof e)return ee(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);"Object"===i&&e.constructor&&(i=e.constructor.name);if("Map"===i||"Set"===i)return Array.from(e);if("Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return ee(e,t)}(e))||t&&e&&"number"==typeof e.length){i&&(e=i);var n=0,r=function(){};return{s:r,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,a=!0,o=!1;return{s:function(){i=i.call(e)},n:function(){var e=i.next();return a=e.done,e},e:function(e){o=!0,s=e},f:function(){try{a||null==i.return||i.return()}finally{if(o)throw s}}}}function ee(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,n=new Array(t);i<t;i++)n[i]=e[i];return n}var te=[].slice;function ie(e,t,i){for(var n=-1,r=e.callbacks.length;++n<r;){var s=e.callbacks[n];s.callback.apply(s.context||i,t)}}var ne,re,se={on:function(e,t,i){var n=this._registry||(this._registry={}),r=n[e]||(n[e]={events:[],callbacks:[]});return r.callbacks.push({callback:t,context:i}),function(e,t,i){if(e.events.length>0){var n,r=Q(e.events);try{for(r.s();!(n=r.n()).done;){var s=n.value;t.apply(i||this,s)}}catch(e){r.e(e)}finally{r.f()}e.events=[]}}(r,t,i),this},off:function(e,t,i){if(!e&&!t&&!i)return delete this._registry,this;for(var n=e?[e]:Object.keys(this._registry),r=0,s=n.length;r<s;r++){var a=n[r],o=this._registry[a].callbacks;if(o){var d=this._registry[a].callbacks=[];if(t||i)for(var c=0,h=o.length;c<h;c++){var u=o[c];(t&&t!==u.callback||i&&i!==u.context)&&d.push(u)}d.length||delete this._registry[a]}else console.warn("Empty callbacks of event: "+a)}return this},trigger:function(e){this._registry||(this._registry={});var t=te.call(arguments,1),i=this._registry[e]||(this._registry[e]={events:[],callbacks:[]});return i.callbacks.length>0?ie(i,t,this):i.events.length<1024?i.events.push(t):console.warn("Events queue is full, event: "+e),this}},ae=function(e,t){return new Promise((function(i,n){se.on(e,(function(){var e=Array.prototype.shift.call(arguments);0===parseInt(e)?(t&&t.call(this),i.apply(void 0,arguments)):n.apply(void 0,arguments)}))}))},oe=i(2),de=i.n(oe),ce=new(ne=function(){function e(){a()(this,e),this.videoParamMap=new Map,this.defaultVideoParam={frameRate:15,width:640,height:480,bitRate:0}}return d()(e,[{key:"startPublishVideo",value:function(e,t){if(e){if(t){if(!("width"in t)||"number"!=typeof t.width)return void c.error("No width or invalid width in videoParam!");if(!("height"in t)||"number"!=typeof t.height)return void c.error("No height or invalid height in videoParam!");if(!("frameRate"in t)||"number"!=typeof t.frameRate)return void c.error("No frameRate or invaid frameRate in videoParam!");if(!("bitRate"in t)||"number"!=typeof t.bitRate)return void c.error("No bitRate or invalid bitRate in videoParam!");this.setVideoParam(e,t)}Fe.sendPublishMediaReq(R,w,e)}else c.error("Invalid deviceId!")}},{key:"stopPublishVideo",value:function(e){Fe.sendPublishMediaReq(P,w,e)}},{key:"startReceiveVideo",value:function(e,t){return Fe.sendRecvMediaReq(x,e,w,t),ae(q+v(e,w,t))}},{key:"stopReceiveVideo",value:function(e,t){return Fe.sendRecvMediaReq(O,e,w,t),ae(G+v(e,w,t))}}]),e}(),de()(ne.prototype,"startPublishVideo",[p],Object.getOwnPropertyDescriptor(ne.prototype,"startPublishVideo"),ne.prototype),de()(ne.prototype,"stopPublishVideo",[p],Object.getOwnPropertyDescriptor(ne.prototype,"stopPublishVideo"),ne.prototype),de()(ne.prototype,"startReceiveVideo",[p],Object.getOwnPropertyDescriptor(ne.prototype,"startReceiveVideo"),ne.prototype),de()(ne.prototype,"stopReceiveVideo",[p],Object.getOwnPropertyDescriptor(ne.prototype,"stopReceiveVideo"),ne.prototype),ne),he=new(re=function(){function e(){a()(this,e),this.screenShareStream=null,this.screenShareStreamRefCount=0,this.isCreatingStream=!1,this.screenShareParam={frameRate:15,width:1920,height:1080,bitRate:0}}return d()(e,[{key:"startScreenShare",value:function(e){if(e){if(!("width"in e)||"number"!=typeof e.width)return void console.error("No width or invalid width in shareParam!");if(!("height"in e)||"number"!=typeof e.height)return void console.error("No height or invalid height in shareParam!");if(!("frameRate"in e)||"number"!=typeof e.frameRate)return void console.error("No frameRate or invaid frameRate in shareParam!");if(!("bitRate"in e)||"number"!=typeof e.bitRate)return void console.error("No bitRate or invalid bitRate in shareParam!");this.setScreenShareParam(e),console.log("Set screen share param: ",e)}Fe.sendPublishMediaReq(R,S,"0")}},{key:"stopScreenShare",value:function(){Fe.sendPublishMediaReq(P,S,"0")}},{key:"startReceiveScreenShare",value:function(e,t){return Fe.sendRecvMediaReq(x,e,S,t),ae(q+v(e,S,t))}},{key:"stopReceiveScreenShare",value:function(e,t){return Fe.sendRecvMediaReq(O,e,S,t),ae(G+v(e,S,t))}}]),e}(),de()(re.prototype,"startScreenShare",[p],Object.getOwnPropertyDescriptor(re.prototype,"startScreenShare"),re.prototype),re),ue=i(6),le=i.n(ue);function pe(e,t,i){var n=i.y-t.y,r=t.x-i.x,s=i.x*t.y-t.x*i.y,a=Math.abs(n*e.x+r*e.y+s)/Math.sqrt(Math.pow(n,2)+Math.pow(n,2));if(a>15)return!1;var o=(-(n*s+r*(n*e.y-r*e.x))/(Math.pow(r,2)+Math.pow(n,2))-t.x)/(i.x-t.x);return o>1||isNaN(o)?a=fe(i,e):o<0&&(a=fe(t,e)),a<=15}function fe(e,t){return Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))}var ge="undefined"==typeof Float32Array?Array:Float32Array;function ve(e,t){var i=new ge(2);return null==e&&(e=0),null==t&&(t=0),i[0]=e,i[1]=t,i}Math.pow;var ye=Math.sqrt;ye(3),ve(),ve(),ve();var me=Math.min,_e=Math.max;Math.sin,Math.cos,Math.PI,ve(),ve(),ve();var be=function(){function e(t){return a()(this,e),this.boardData={paintMap:new Map},this.editConfig={id:1,status:!1},this.shape=C.CURVE,this.color=4278255442,this.brush_size=4,this.revokeStack=[],this.restoreStack=[],this.graphIdSeed=0,this._init(t),this}return d()(e,[{key:"_init",value:function(e){var t=this,i=e.slice(0,1),n=e.slice(1);this.boardData=Object.assign(this.boardData,i[0].board),this.editConfig.id=this.boardData.edit_id,n.length>0?n.map((function(e){var i=t.boardData.paintMap.get(e[e.type].pid);i?(i.push(e),t.boardData.paintMap.set(e[e.type].pid,i)):t.boardData.paintMap.set(e[e.type].pid,[e])})):this.boardData.paintMap.set(i[0].board.current_pid,[])}},{key:"clearPaints",value:function(){this.boardData.paintMap=new Map,this.boardData.paintMap.set(this.getCurPage(),[])}},{key:"getCurPage",value:function(){return this.boardData.current_pid}},{key:"getPageCount",value:function(){return this.boardData.page}},{key:"getFilePath",value:function(){return this.boardData.convert_file_path}},{key:"getConvertFilePath",value:function(){return this.boardData.convert_file_path}},{key:"setCurPage",value:function(e){this.boardData.current_pid=e}},{key:"getBoardName",value:function(){return this.boardData.board_name}},{key:"deletePage",value:function(e){this.boardData.paintMap.get(e[e.type].pid)&&this.boardData.paintMap.set(e[e.type].pid,[])}},{key:"findPagePaints",value:function(e){return this.boardData.paintMap.get(e)||this.boardData.paintMap.set(e,[]),this.boardData.paintMap.get(e)}},{key:"findPaintByGid",value:function(e,t){for(var i=0;i<e.length;i++){var n=e[i];if(n[n.type].gid===t)return n}return null}},{key:"deletePaintObj",value:function(e,t){for(var i=0;i<e.length;i++){var n=e[i];if(n[n.type].gid===t)try{return e.splice(i,1)[0]}catch(e){return null}}return null}},{key:"addPaintObj",value:function(e,t){e.push(t)}},{key:"amendPaintObj",value:function(e,t){for(var i=0;i<e.length;i++){var n=e[i];if(n[n.type].gid===t[t.type].gid){var r;if(n.type===C.CURVE)(r=n[n.type].points).push.apply(r,le()(t[t.type].points));else e.splice(i,1,t);break}}}},{key:"repalcePaintObj",value:function(e,t,i){for(var n=0;n<e.length;n++){var r=e[n];if(r[r.type].gid===t){r[r.type]=i;break}}}},{key:"movePaintObj",value:function(e,t,i){for(var n=0;n<e.length;n++){var r=e[n];if(r[r.type].gid===t){r.type===C.CURVE?r[r.type].points=r[r.type].points.map((function(e){return[e[0]+i.ox,e[1]+i.oy]})):r.type===C.TEXT?(r[r.type].left+=i.ox,r[r.type].top+=i.oy):(r[r.type].x1+=i.ox,r[r.type].y1+=i.oy,r[r.type].x2+=i.ox,r[r.type].y2+=i.oy);break}}}},{key:"findPaintsByPoint",value:function(e,t){for(var i=!1,n=0;n<e.length;n++){var r=e[n];if(r.type===C.CURVE||r.type===C.MASK_CURVE)for(var s=r[r.type].points,a=0;a<s.length-1;a++){var o=s[a],d=s[a+1];if(i=pe(t,{x:o[0],y:o[1]},{x:d[0],y:d[1]}))break}else if(r.type===C.LINE){var c=r[r.type];i=pe(t,{x:c.x1,y:c.y1},{x:c.x2,y:c.y2})}if(i)return r}return null}},{key:"containPaintObj",value:function(e){var t=this.findPagePaints(this.boardData.current_pid),i=[];return t.map((function(t){if(t.type===C.CURVE){var n=!0;t[t.type].points.map((function(t){(t[0]<e.x1||t[0]>e.x2||t[1]<e.y1||t[1]>e.y2)&&(n=!1)})),n&&i.push(t[t.type].gid)}else if(t.type===C.TEXT);else if(t.type===C.LINE){var r=t[t.type];if(r.x1<e.x1||r.x2>e.x2||r.y1<e.y1||r.y2>e.y2)return;i.push(t[t.type].gid)}})),i}},{key:"boundingRect",value:function(e){var t=this.findPagePaints(this.boardData.current_pid),i=this.findPaintByGid(t,e),n=[],r=[];if("line"===i.type){var s=i[i.type];!function(e,t,i,n,r,s){r[0]=me(e,i),r[1]=me(t,n),s[0]=_e(e,i),s[1]=_e(t,n)}(s.x1,s.y1,s.x2,s.y2,n,r)}else"curve"===i.type&&function(e,t,i){if(0!==e.length){var n,r=e[0],s=r[0],a=r[0],o=r[1],d=r[1];for(n=1;n<e.length;n++)r=e[n],s=me(s,r[0]),a=_e(a,r[0]),o=me(o,r[1]),d=_e(d,r[1]);t[0]=s,t[1]=o,i[0]=a,i[1]=d}}(i[i.type].points,n,r);return{x1:n[0],y1:n[1],x2:r[0],y2:r[1]}}},{key:"groupBoundingRect",value:function(e){var t=this,i=null;return e.map((function(e){var n=t.boundingRect(e);(i=i||n).x1=Math.min(i.x1,n.x1),i.y1=Math.min(i.y1,n.y1),i.x2=Math.max(i.x2,n.x2),i.y2=Math.max(i.y2,n.y2)})),i}}]),e}();function ke(e,t){var i="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=function(e,t){if(!e)return;if("string"==typeof e)return Se(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);"Object"===i&&e.constructor&&(i=e.constructor.name);if("Map"===i||"Set"===i)return Array.from(e);if("Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return Se(e,t)}(e))||t&&e&&"number"==typeof e.length){i&&(e=i);var n=0,r=function(){};return{s:r,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,a=!0,o=!1;return{s:function(){i=i.call(e)},n:function(){var e=i.next();return a=e.done,e},e:function(e){o=!0,s=e},f:function(){try{a||null==i.return||i.return()}finally{if(o)throw s}}}}function Se(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,n=new Array(t);i<t;i++)n[i]=e[i];return n}var Ie,we,Me={line:function(e,t,i){e.beginPath(),e.lineCap="round",e.lineWidth=parseInt(t.brush_size*i),e.strokeStyle=g(t.color),e.moveTo(t.x1*i,t.y1*i),e.lineTo(t.x2*i,t.y2*i),e.stroke(),e.closePath()},curve:function(e,t,i){e.beginPath(),e.lineCap="round",e.lineWidth=t.brush_size*i,e.strokeStyle=g(t.color);var n=t.points.map((function(e){return{X:parseInt(e[0]*i),Y:parseInt(e[1]*i)}}));if(t.brush_size>4){e.moveTo(n[0].X,n[0].Y);for(var r=1;r<n.length;r++){var s=f(n,r-1);e.bezierCurveTo(s.pA.x,s.pA.y,s.pB.x,s.pB.y,n[r].X,n[r].Y)}}else for(var a=1;a<n.length;a++)e.lineTo(n[a].X,n[a].Y);e.stroke(),e.closePath()},text:function(e,t,i){e.beginPath(),e.font="".concat(4*Math.abs(t.fontsize)/3*i,'px "').concat(t.color,'"'),e.textBaseline="top",e.fillStyle=g(t.color);var n,r=0,s=ke(t.text.split("\r\n"));try{for(s.s();!(n=s.n()).done;){var a=n.value;e.fillText(a,t.left*i,22*r+t.top*i),r++}}catch(e){s.e(e)}finally{s.f()}e.closePath()},rectangle:function(e,t,i){e.beginPath(),e.lineWidth=t.brush_size*i,e.strokeStyle=t.color;var n=parseInt(t.x1)*i,r=parseInt(t.y1)*i,s=parseInt(t.x2)*i,a=parseInt(t.y2)*i;e.rect(n,r,s-n,a-r),e.closePath(),e.stroke()},mask_curve:function(e,t,i){e.beginPath(),e.lineCap="round",e.lineWidth=t.brush_size*i,e.strokeStyle=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"1",i=parseInt(e.slice(1,3),16),n=parseInt(e.slice(3,5),16),r=parseInt(e.slice(5,7),16);return"rgba(".concat(i,", ").concat(n,", ").concat(r,", ").concat(t,")")}(g(t.color),".4");var n=t.points.map((function(e){return{X:parseInt(e[0]*i),Y:parseInt(e[1]*i)}}));if(t.brush_size>4){e.moveTo(n[0].X,n[0].Y);for(var r=1;r<n.length;r++){var s=f(n,r-1);e.bezierCurveTo(s.pA.x,s.pA.y,s.pB.x,s.pB.y,n[r].X,n[r].Y)}}else for(var a=1;a<n.length;a++)e.lineTo(n[a].X,n[a].Y);e.stroke(),e.closePath()},arrow:function(e,t,i){var n,r,s,a,o,d,c,h,u,l,p,f,v,y,m,_;e.lineWidth=t.brush_size*i,e.strokeStyle=g(t.color),e.fillStyle=g(t.color),n=e,r=t.x1*i,s=t.y1*i,a=t.x2*i,o=t.y2*i,d=10,c=26,l=180*Math.atan2(s-o,r-a)/Math.PI,p=(l+c)*Math.PI/180,f=(l-c)*Math.PI/180,v=d*Math.cos(p),y=d*Math.sin(p),m=d*Math.cos(f),_=d*Math.sin(f),e.save(),n.beginPath(),n.moveTo(r,s),n.lineTo(a,o),h=a+v,u=o+y,n.moveTo(h,u),n.lineTo(a,o),h=a+m,u=o+_,n.lineTo(h,u),n.closePath(),n.fill(),n.stroke(),n.restore()},rect:function(e,t,i){e.beginPath(),e.lineWidth=t.brush_size*i,e.strokeStyle=g(t.color);var n=parseInt(t.left)*i,r=parseInt(t.bottom)*i,s=parseInt(t.right)*i,a=parseInt(t.top)*i;e.rect(n,r,s-n,a-r),e.closePath(),e.stroke()},round_rect:function(e,t,i){e.lineWidth=t.brush_size*i,e.strokeStyle=g(t.color);var n=parseInt(t.left)*i,r=parseInt(t.bottom)*i,s=parseInt(t.right-t.left)*i,a=parseInt(t.top-t.bottom)*i,o=Math.min(s,a)/10;e.save(),e.translate(n,r),e.beginPath(),e.arc(s-o,a-o,o,0,Math.PI/2),e.lineTo(o,a),e.arc(o,a-o,o,Math.PI/2,Math.PI),e.lineTo(0,o),e.arc(o,o,o,Math.PI,3*Math.PI/2),e.lineTo(s-o,0),e.arc(s-o,o,o,3*Math.PI/2,2*Math.PI),e.lineTo(s,a-o),e.closePath(),e.stroke(),e.restore()},ellipse:function(e,t,i){e.lineWidth=t.brush_size*i,e.strokeStyle=g(t.color);var n=parseInt((t.right-t.left)/2)*i,r=parseInt((t.top-t.bottom)/2)*i,s=n+parseInt(t.left)*i,a=r+parseInt(t.bottom)*i;e.save();var o=n>r?n:r,d=n/o,c=r/o;e.scale(d,c),e.beginPath(),e.moveTo((s+n)/d,a/c),e.arc(s/d,a/c,o,0,2*Math.PI),e.closePath(),e.restore(),e.stroke()},pic:function(e,t,i,n){var r="/".concat(t.user_data.id),s="/".concat(t.user_data.id,"/",0,".jpg");!function a(){var o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;if(o>20)return;if(Be.cacheFileUrlMap.get(r)&&Be.cacheFileUrlMap.get(r).get(s)){var d=t.left*i,c=t.bottom*i,h=t.right*i,u=t.top*i;wx.getImageInfo({src:Be.cacheFileUrlMap.get(r).get(s),success:function(t){if(console.warn("getImageInfoRes",t),n){var i=n.createImage();i.src=t.path,i.onload=function(){console.log("加载图片成功"),e.drawImage(i,0,0,h-d,u-c)},i.onerror=function(e){console.error("加载图片失败",e)}}},fail:function(e){console.warn("Get image info failed!")}})}else Be._getFileUrl(s),setTimeout((function(){a(++o)}),500)}()}},Pe=function(){function e(t,i){a()(this,e),this.painter=t,this.pageStore=i}return d()(e,[{key:"_drawAllPaint",value:function(){var e=this;this.pageStore&&this.pageStore.findPagePaints(this.pageStore.getCurPage()).map((function(t){e._drawPaint(t.type,t[t.type])}))}},{key:"_insertImage",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;if(!(t>10)){var i=this.pageStore.getConvertFilePath(),n=i,r=this.pageStore.getCurPage(),s=i;s.includes(".jpg")?n=i.substr(0,i.lastIndexOf("/")):s="".concat(i,"/").concat(r,".jpg"),Be.cacheFileUrlMap.get(n)&&Be.cacheFileUrlMap.get(n).get(s)?this.painter.canvasEle?this.painter._refreshRender():console.warn("Invalid canvas element!"):(Be._getFileUrl(s),setTimeout(function(){e._insertImage(++t)}.bind(this),500))}}},{key:"_emptyCanvas",value:function(){this.painter.canvasCtx&&this.painter.canvasCtx.clearRect(0,0,this.painter.canvasWidth,this.painter.canvasHeight)}},{key:"_drawPaint",value:function(e,t){if(this.painter.canvasCtx)try{Me[e](this.painter.canvasCtx,t,this.painter.scaleRatio,this.painter.canvasEle)}catch(t){console.error("Draw type: "+e+", error: "+t)}}},{key:"drawAmendData",value:function(e,t){this._drawAllPaint();var i=this.pageStore.findPaintByGid(e,t[t.type].gid);i&&this._drawPaint(i.type,i[i.type])}},{key:"dealAmendData",value:function(e){var t=this.pageStore.findPagePaints(this.pageStore.getCurPage());1===e[e.type].action?(this.pageStore.addPaintObj(t,e),this.drawAmendData(t,e)):2===e[e.type].action?(this.pageStore.amendPaintObj(t,e),this.drawAmendData(t,e)):3===e[e.type].action?(this.pageStore.deletePaintObj(t,e[e.type].gid),this._emptyCanvas(),this._drawAllPaint()):4===e[e.type].action&&(this.pageStore.repalcePaintObj(t,e[e.type].gid,e[e.type]),this._drawAllPaint())}},{key:"pageChange",value:function(e){this.pageStore&&(this.pageStore.setCurPage(e.cur_page),this.pageStore.getConvertFilePath()&&this._insertImage(),this.painter._refreshRender(),se.trigger("shareOperation",{type:"pageChange",mediaId:this.painter.mediaId,curPage:this.pageStore.getCurPage()}))}},{key:"moveGraph",value:function(e){var t=this,i=this.pageStore.findPagePaints(e.gmov.pid);e.gmov.graphs.map((function(n){t.pageStore.movePaintObj(i,n,e.gmov)})),this._emptyCanvas(),this._drawAllPaint()}},{key:"drawBoundingRect",value:function(e){if(e){this.painter.canvasCtx.beginPath(),this.painter.canvasCtx.lineWidth=1,this.painter.canvasCtx.strokeStyle="#00ff00";var t=parseInt(e.x1)*this.painter.scaleRatio,i=parseInt(e.y1)*this.painter.scaleRatio,n=parseInt(e.x2)*this.painter.scaleRatio,r=parseInt(e.y2)*this.painter.scaleRatio;this.painter.canvasCtx.rect(t,i,n-t,r-i),this.painter.canvasCtx.closePath(),this.painter.canvasCtx.stroke()}}}]),e}(),Re=function(){function e(t,i){a()(this,e),this.painter=t,this.pageStore=i||{},this.render=this.painter.render,this.userId=y.userInfo.userId,this.parttern={},this.getGraphId(),this.graphChildren=[],this.boundingRect=null,this.moveStatus=!1,se.on("touchStart".concat(this.painter.mediaId),this.touchMoveStart.bind(this)),se.on("touchMove".concat(this.painter.mediaId),this.touchMoveEvent.bind(this)),se.on("touchEnd".concat(this.painter.mediaId),this.touchMoveEnd.bind(this))}return d()(e,[{key:"getGraphId",value:function(){return this.userId<<16|this.pageStore.graphIdSeed++}},{key:"touchMoveStart",value:function(e){this.rateX=this.painter.width/this.painter.canvasWidth,this.rateY=this.painter.height/this.painter.canvasHeight;var t=this._calcXY(e.touches[0].x,e.touches[0].y);if(this.pageStore.shape!==C.ERASER)this._createShapeObject(),this.pageStore.shape===C.CURVE&&(this.parttern.points.push([t.x,t.y]),this.painter._sendGraphMsg(this.pageStore.shape,this.parttern,1));else{var i=this.pageStore.findPagePaints(this.pageStore.getCurPage()),n=this.pageStore.findPaintsByPoint(i,t);n&&(this.painter._sendGraphMsg(n.type,n[n.type],3),this._storeStack(n.type,n[n.type]))}}},{key:"touchMoveEvent",value:function(e){var t=Math.floor(e.touches[0].x*this.rateX),i=Math.floor(e.touches[0].y*this.rateY),n=this._calcXY(e.touches[0].x,e.touches[0].y);if(this.pageStore.shape===C.ERASER){var r=this.pageStore.findPagePaints(this.pageStore.getCurPage()),s=this.pageStore.findPaintsByPoint(r,n);s&&(this.painter._sendGraphMsg(s.type,s[s.type],3),this._storeStack(s.type,s[s.type]))}else this.pageStore.shape===C.LINE?(this.parttern.x2=t,this.parttern.y2=i,this.painter._sendGraphMsg(this.pageStore.shape,this.parttern,2)):this.pageStore.shape===C.CURVE?(this.parttern.points=[[t,i]],this.painter._sendGraphMsg(this.pageStore.shape,this.parttern,2)):this.pageStore.shape===C.GMOV&&(this.moveStatus?(this.parttern.ox=t-n.x,this.parttern.oy=i-n.y,this.parttern.graphs=this.graphChildren,this.painter._sendGraphMsg(C.GMOV,this.parttern),n.x=t,n.y=i):(this.painter.render._drawAllPaint(),this.boundingRect={x1:n.x,y1:n.y,x2:t,y2:i},this.render.drawBoundingRect(this.boundingRect)))}},{key:"touchMoveEnd",value:function(e){this.pageStore.shape!==C.GMOV&&(this._storeStack(this.pageStore.shape,this.parttern),this.painter._sendGraphMsg(this.pageStore.shape,this.parttern,5)),this.pageStore.shape===C.GMOV&&(this.moveStatus=!1,this.render._drawAllPaint(),this.boundingRect&&(this.graphChildren=this.pageStore.containPaintObj(this.boundingRect),this.boundingRect=this.pageStore.groupBoundingRect(this.graphChildren),this.render.drawBoundingRect(this.boundingRect)))}},{key:"_storeStack",value:function(e,t){var i={type:e};i[e]=t,this.pageStore.revokeStack.push(i)}},{key:"_createShapeObject",value:function(){switch(this.pageStore.shape){case C.LINE:this.parttern={pid:this.pageStore.getCurPage(),gid:this.getGraphId(),action:null,graph:1,brush_size:this.pageStore.brush_size,color:this.pageStore.color,x1:null,y1:null,x2:null,y2:null};break;case C.CURVE:this.parttern={pid:this.pageStore.getCurPage(),gid:this.getGraphId(),action:null,graph:2,brush_size:this.pageStore.brush_size,color:this.pageStore.color,points:[]};break;case C.TEXT:this.parttern={pid:this.pageStore.getCurPage(),gid:this.getGraphId(),text:"",action:null,color:this.pageStore.color,left:"",top:"",right:"",bottom:"",font:"新宋体",fontsize:20};break;case C.GMOV:this.parttern={pid:this.pageStore.getCurPage(),ox:null,oy:null,graphs:[]}}}},{key:"_calcXY",value:function(e,t){return{x:Math.ceil(this.rateX*e),y:Math.ceil(this.rateY*t)}}},{key:"_calcTextDisance",value:function(e,t){return this.painter.displayMode==DisplayMode.DBSY?{x:e,y:t}:{x:Math.ceil(e+(this.painter.parentEle.offsetWidth-this.painter.canvasWidth)/2),y:Math.ceil(t+(this.painter.parentEle.offsetHeight-this.painter.canvasHeight)/2)}}}]),e}(),Oe=(Ie=function(){function e(t){return a()(this,e),this.isClosing=!1,this.isSelect=!1,this.isRotate=!1,this.isSwitchPage=!1,this.rotateAngle=0,this.pageStore=null,this.firstFullData=!0,this.scaleRatio=1,this.width=0,this.height=0,this.write=null,this.parentWidth=0,this.parentHeight=0,this.canvasWidth=0,this.canvasHeight=0,this.canvasEle=null,this.canvasCtx=null,this.canvasSizeChangeCallback=null,this.canvasLeft=0,this.canvasTop=0,this.canvasWidth=0,this.canvasHeight=0,this.sourcePaints=[],this.msg_seq_id=null,this.local_seq_id=this.msg_seq_id,this.displayMode=$,this.displayParam=null,this.userId=t.userId,this.mediaId=t.mediaId,this.mediaName=t.mediaName,this.streamId=t.streamId,this.streamToken=t.streamToken,this.streamServer=t.streamServer,this.channelId="",this.seqId=parseInt(1e3*Math.random()),this.msgDispatcher=new h,this.msgDispatcher.addMsgHandler(30002,this._editRes.bind(this)),this.msgDispatcher.addMsgHandler(31e3,this._dealAmendData.bind(this)),this.msgDispatcher.addMsgHandler(31002,this._dealAmendData.bind(this)),this.msgDispatcher.addMsgHandler(30103,this._mouseMove.bind(this)),this.msgDispatcher.addMsgHandler(31004,this._dealAmendData.bind(this)),this.msgDispatcher.addMsgHandler(31006,this._dealAmendData.bind(this)),this.msgDispatcher.addMsgHandler(31008,this._dealAmendData.bind(this)),this.msgDispatcher.addMsgHandler(30200,this._pageChangeHandle.bind(this)),this.msgDispatcher.addMsgHandler(30202,this._moveGraph.bind(this)),this.msgDispatcher.addMsgHandler(3e4,this._heartBeat.bind(this)),this.msgDispatcher.addMsgHandler(30004,this._dealFullData.bind(this)),this.msgDispatcher.addMsgHandler(19005,this._processLoginResp.bind(this)),this.msgDispatcher.addMsgHandler(101,this._onConnectSuccess.bind(this)),this.websocket=k,this.websocket.createProxyConnect({backward_addr:this.streamServer,handler:this.msgDispatcher,seq_id:this.seqId,closed:this._onWebsocketClosed.bind(this),error:this._onWebsocketError.bind(this)}),this}return d()(e,[{key:"_processLoginResp",value:function(e){0!=e.result&&c.warn("Login white board receive channel failed!")}},{key:"_onWebsocketOpen",value:function(e){Fe.sendLoginRecvChannelReq({mediaType:M,mediaId:"",streamId:this.streamId,streamToken:this.streamToken,channelId:e})}},{key:"_onWebsocketClosed",value:function(){var e=this;this.isClosing||(this.websocket.reconnectNum<10?setTimeout((function(){e.websocket.reconnect({backward_addr:e.streamServer,handler:e.msgDispatcher,seq_id:e.seqId,closed:e._onWebsocketClosed.bind(e),error:e._onWebsocketError.bind(e)})}),1e3):se.trigger("onError"))}},{key:"_onWebsocketError",value:function(){}},{key:"_onConnectSuccess",value:function(e,t){var i=e.result,n=e.channel_id,r=e.seq;0===i&&(r===this.seqId?(this.channelId=n,this._onWebsocketOpen(n)):c.info("proxyChannel has exist"))}},{key:"setDisplayMode",value:function(e,t){(this.displayMode!=e||e==Z&&t&&this.displayParam!=t)&&(this.displayMode=e,this.displayParam=t,this._showWhiteBoard())}},{key:"_showWhiteBoardDbwz",value:function(){this.parentHeight/this.parentWidth.toFixed(6)>this.height/this.width.toFixed(6)?(this.canvasWidth=this.parentWidth,this.canvasHeight=this.height*this.parentWidth/this.width.toFixed(6),this.canvasLeft=0,this.canvasTop=(this.parentHeight-this.canvasHeight)/2):(this.canvasWidth=this.width*this.parentHeight/this.height.toFixed(6),this.canvasHeight=this.parentHeight,this.canvasLeft=(this.parentWidth-this.canvasWidth)/2,this.canvasTop=0),this.canvasSizeChangeCallback(this.canvasLeft,this.canvasTop,this.canvasWidth,this.canvasHeight),this.scaleRatio=this.canvasHeight/this.height.toFixed(6),this.canvasEle.width=this.canvasWidth,this.canvasEle.height=this.canvasHeight,this._refreshRender()}},{key:"_showWhiteBoardDbsy",value:function(){this.parentHeight/this.parentWidth.toFixed(6)>this.height/this.width.toFixed(6)?(this.canvasWidth=this.width*this.parentHeight/this.height.toFixed(6),this.canvasHeight=this.parentHeight,this.canvasLeft=0,this.canvasTop=0,console.error("canvasWidth0",this.canvasWidth)):(this.canvasWidth=this.parentWidth,this.canvasHeight=this.height*this.parentWidth/this.width.toFixed(6),this.canvasLeft=0,this.canvasTop=0,console.error("canvasWidth1",this.canvasWidth)),this.canvasSizeChangeCallback(this.canvasLeft,this.canvasTop,this.canvasWidth,this.canvasHeight),this.scaleRatio=this.canvasHeight/this.height.toFixed(6),this.canvasEle.width=this.canvasWidth,this.canvasEle.height=this.canvasHeight,this._refreshRender()}},{key:"_showWhiteBoardDbsf",value:function(){this.canvasWidth=this.width*this.displayParam.toFixed(6)/100,this.canvasHeight=this.height*this.displayParam.toFixed(6)/100,this.canvasWidth>=this.parentWidth?this.canvasLeft=0:this.canvasLeft=(this.parentWidth-this.canvasWidth)/2,this.canvasHeight>=this.parentHeight?this.canvasTop=0:this.canvasTop=(this.parentHeight-this.canvasHeight)/2,this.canvasSizeChangeCallback(this.canvasLeft,this.canvasTop,this.canvasWidth,this.canvasHeight),this.scaleRatio=this.displayParam.toFixed(6)/100,this.canvasEle.width=this.canvasWidth,this.canvasEle.height=this.canvasHeight,this._refreshRender()}},{key:"_showWhiteBoard",value:function(){this.canvasEle&&this.canvasCtx?(this.pageStore&&this.pageStore.getConvertFilePath()&&this.render._insertImage(),this.displayMode==K?this._showWhiteBoardDbwz():this.displayMode==$?this._showWhiteBoardDbsy():this.displayMode==Z?this._showWhiteBoardDbsf():c.error("Unknown display mode: "+this.displayMode)):console.warn("Invalid canvas render!")}},{key:"setRenderElement",value:function(e,t){c.log("Set render element: "+JSON.stringify(t)),e?(this.canvasEle=e,this.parentWidth=t.parentWidth,this.parentHeight=t.parentHeight,this.displayParam=t.scaleRatio,this.canvasSizeChangeCallback=t.canvasSizeChange,this.canvasCtx=this.canvasEle.getContext("2d"),this.pageStore&&(this.write=new Re(this,this.pageStore)),this._showWhiteBoard()):(this._emptyCanvas(),this.canvasEle&&(this.canvasEle.width=0,this.canvasEle.height=0,this.canvasCtx=null,this.canvasEle=null),this.canvasSizeChangeCallback=null,this.parentWidth=0,this.parentHeight=0)}},{key:"_initCanvas",value:function(e){this.width=e.width,this.height=e.height,this.pageStore&&this.pageStore.getConvertFilePath()&&this.render._insertImage(),this._refreshRender()}},{key:"_waitGetImageUrl",value:function(){var e=this.pageStore.getConvertFilePath();return new Promise((function(t,i){var n=0,r=setInterval((function(){++n,Be.cacheFileUrlMap.get(e)?(clearInterval(r),t()):n>10&&(clearInterval(r),i("等待获取图片URL失败"))}),500)}))}},{key:"_drawImage",value:function(){var e=this,t=this.pageStore.getConvertFilePath(),i=t,n=this.pageStore.getCurPage(),r=t;return r.includes(".jpg")?i=t.substr(0,t.lastIndexOf("/")):r="".concat(t,"/").concat(n,".jpg"),new Promise((function(t,n){var s=Be.cacheFileUrlMap.get(i).get(r);console.log("imgUrl",s),wx.getImageInfo({src:s,success:function(i){if(console.log("getImageInfoRes",i),e.canvasEle){var r=e.canvasEle.createImage();r.src=i.path,r.onload=function(){console.log("加载图片成功"),e.canvasCtx&&e.canvasCtx.drawImage(r,0,0,e.canvasWidth,e.canvasHeight),t()},r.onerror=function(e){console.error("加载图片失败",e),n()},r.src=i.path}},fail:function(e){c.warn("Get image info failed!"),n()}})}))}},{key:"_refreshRender",value:function(){var e=this,t=this;t._emptyCanvas(),t.pageStore&&t.pageStore.getConvertFilePath()?t._waitGetImageUrl().then((function(){c.log("Image url is ready."),t._drawImage().then((function(){c.log("Draw image finished."),e.render&&e.render._drawAllPaint()})).catch((function(){c.log("Draw image failed!")}))})).catch((function(e){c.warn(e)})):(c.log("无需绘制背景图片"),this.render&&this.render._drawAllPaint())}},{key:"_emptyCanvas",value:function(){this.canvasCtx&&this.canvasCtx.clearRect(0,0,this.canvasWidth,this.canvasHeight)}},{key:"_drawAllPaint",value:function(){var e=this;this.pageStore&&this.pageStore.findPagePaints(this.pageStore.getCurPage()).map((function(t){e._drawPaint(t.type,t[t.type])}))}},{key:"_drawAmendData",value:function(e,t){if(t.type!==C.CURVE)this._emptyCanvas(),this._drawAllPaint();else{var i=this.pageStore.findPaintByGid(e,t[t.type].gid);i&&this._drawPaint(i.type,i[i.type])}}},{key:"_dealAmendData",value:function(e){e.channel_id===this.channelId&&(this._updateMsgSeq(e),this.render.dealAmendData(e))}},{key:"_pageChangeHandle",value:function(e){e.channel_id===this.channelId&&(this._updateMsgSeq(e),this.render.pageChange(e))}},{key:"_moveGraph",value:function(e){this._updateMsgSeq(e),this.render.moveGraph(e)}},{key:"_mouseMove",value:function(e){var t=e.rotate_angle,i=e.cur_page;(t||0===t)&&(this.rotateAngle=t,se.trigger("shareOperation",{userId:this.userId,mediaId:this.mediaId,rotateAngle:t,type:"rotate"})),(i||0===i)&&this._pageChangeHandle(e),this._updateMsgSeq(e)}},{key:"_editRes",value:function(e){if(e.channel_id===this.channelId)if(this.pageStore.editConfig.id=e.edit_id,this.isSelect)Fe.sendSwitchWhiteBoard(e.edit_id,this.channelId),this.isSelect=!1;else if(this.isRotate){var t={edit_id:e.edit_id,rotateAngle:this.rotateAngle};Fe.sendChangeWhiteBoardProperty(t,this.channelId),this.isRotate=!1}else if(this.isSwitchPage){var i={edit_id:this.pageStore.editConfig.id,cur_page:this.pageStore.getCurPage()};Fe.sendChangeWhiteBoardProperty(i,this.channelId),this.isSwitchPage=!1}else this.pageStore.editConfig.status=!0,se.trigger("edit_white_board",0,!0)}},{key:"select",value:function(){this.pageStore.editConfig.id?Fe.sendSwitchWhiteBoard(this.pageStore.editConfig.id,this.channelId):(this.isSelect=!0,Fe.sendOpenEdit(this.channelId))}},{key:"rotate",value:function(e){if(this.rotateAngle=e,this.pageStore.editConfig.id){var t={edit_id:this.pageStore.editConfig.id,rotateAngle:e};Fe.sendChangeWhiteBoardProperty(t,this.channelId)}else this.isRotate=!0,Fe.sendOpenEdit(this.channelId)}},{key:"switchBoardPage",value:function(e,t){if(this.pageStore.setCurPage(e),t)if(this.pageStore.editConfig.id){var i={edit_id:this.pageStore.editConfig.id,cur_page:e};Fe.sendChangeWhiteBoardProperty(i,this.channelId)}else this.isSwitchPage=!0,Fe.sendOpenEdit(this.channelId);else this.pageStore&&this.pageStore.getConvertFilePath()&&this.render._insertImage(),this._refreshRender()}},{key:"close",value:function(){c.log("Close white board: "+this.mediaId),this.isClosing=!0,this.pageStore=null,this.msgDispatcher=null,this.intervalHandle&&(clearInterval(this.intervalHandle),this.intervalHandle=null),this.parentEle&&this.canvasEle&&(this.parentEle.removeChild(this.canvasEle),this.canvasEle=null),this.websocket&&(this.websocket.close(),this.websocket=null)}},{key:"_dealFullData",value:function(e){if(e.channel_id===this.channelId&&(this.sourcePaints=this.sourcePaints.concat(e.data),e.sync_end)){if(c.log("Get white board full data complete."),this.pageStore=new be(this.sourcePaints),this.render=new Pe(this,this.pageStore),this.write=new Re(this,this.pageStore),!this.sourcePaints[0].board)return c.error("Invalid source paints: "+JSON.stringify(this.sourcePaints)),void(this.sourcePaints=[]);if(this._initCanvas(this.sourcePaints[0].board),this.firstFullData){if(!Be.tryRestoreWhiteBoardRender(this.mediaId)){var t=this.sourcePaints[0].board,i=t.property&&t.property.rotate_angle||0,n=JSON.parse(t.user_data).rights_index,r=void 0===n?0:n;se.trigger("onRemoteMediaAdd",{userId:this.userId,mediaType:M,mediaId:this.mediaId,rotateAngle:i,rightIndex:r,mediaName:this.pageStore.getBoardName(),totalPage:this.pageStore.getPageCount(),curPage:this.pageStore.getCurPage()})}this.firstFullData=!1}this.sourcePaints=[]}}},{key:"_updateMsgSeq",value:function(e){var t=e.channel_id,i=e.seq_id;t===this.channelId&&(this.msg_seq_id=i)}},{key:"_checkMsgSeq",value:function(e){var t=e.seq_id;(!this.msg_seq_id||null!==this.msg_seq_id&&t-this.msg_seq_id!=1)&&Fe.sendGetWhiteBoardFullDataReq(this.channelId),this.msg_seq_id=t,this.local_seq_id=this.msg_seq_id}},{key:"_heartBeat",value:function(e){e.channel_id===this.channelId&&this._checkMsgSeq(e)}},{key:"_sendGraphMsg",value:function(e,t,i){var n={type:e,seq_id:++this.local_seq_id,edit_id:this.pageStore&&this.pageStore.editConfig.id,channelId:this.channelId};t.action=i,t.line_shape=0,n[e]=t,e===C.LINE?n.id=31e3:e===C.CURVE?n.id=31002:e===C.TEXT?n.id=31006:e===C.GMOV&&(delete t.action,n.id=30202),Fe.sendGraphMsg(n)}},{key:"clear",value:function(){var e={curPage:this.pageStore.getCurPage(),edit_id:this.pageStore.editConfig.id,action:3,channelId:this.channelId};Fe.sendPageInfoMsg(e),this.pageStore.revokeStack=[],this.pageStore.restoreStack=[]}},{key:"brushSize",value:function(e){if(void 0===e)return this.pageStore.brush_size;this.pageStore.brush_size=parseInt(e)||this.pageStore.brush_size}},{key:"brushColor",value:function(e){if(void 0===e)return g(this.pageStore.color);this.pageStore.color=function(e){for(e="#"==e.charAt(0)?e.substring(1,7):e;e.length<8;)e="f"+e;return parseInt(e,16)}(e)||this.pageStore.color}},{key:"toolType",value:function(e){if(void 0===e)return this.pageStore.shape;this.pageStore.shape=e||this.pageStore.shape}},{key:"_transrate",value:function(e,t){var i=e.pop();if(i){var n=i.type,r=this.pageStore.findPagePaints(i[n].pid);1===(i=this.pageStore.findPaintByGid(r,i[n].gid)||i)[n].action||2===i[n].action?(this._sendGraphMsg(n,i[n],3),t.push(i)):3===i[n].action&&(this._sendGraphMsg(n,i[n],1),t.push(i))}}},{key:"revoke",value:function(){this._transrate(this.pageStore.revokeStack,this.pageStore.restoreStack)}},{key:"restore",value:function(){this._transrate(this.pageStore.restoreStack,this.pageStore.revokeStack)}},{key:"edit",value:function(e){return void 0===e?this.pageStore.editConfig.status:e?(Fe.sendOpenEdit(this.channelId),ae("edit_white_board")):(this.pageStore.editConfig.status=!1,Promise.resolve(!1))}},{key:"page",value:function(e){if(void 0===e)return this.pageStore.getCurPage();if(e>=this.pageStore.getPageCount()||e<1)return c.warn("page number is not reasonable");var t={curPage:e,edit_id:this.pageStore.editConfig.id,action:0,channelId:this.channelId};Fe.sendPageInfoMsg(t)}},{key:"startPainting",value:function(e){this.pageStore&&this.pageStore.editConfig&&this.pageStore.editConfig.status&&se.trigger("touchStart".concat(this.mediaId),e)}},{key:"painting",value:function(e){this.pageStore&&this.pageStore.editConfig&&this.pageStore.editConfig.status&&se.trigger("touchMove".concat(this.mediaId),e)}},{key:"stopPainting",value:function(e){this.pageStore&&this.pageStore.editConfig&&this.pageStore.editConfig.status&&se.trigger("touchEnd".concat(this.mediaId),e)}}]),e}(),de()(Ie.prototype,"_processLoginResp",[p],Object.getOwnPropertyDescriptor(Ie.prototype,"_processLoginResp"),Ie.prototype),de()(Ie.prototype,"_onWebsocketOpen",[p],Object.getOwnPropertyDescriptor(Ie.prototype,"_onWebsocketOpen"),Ie.prototype),de()(Ie.prototype,"_onWebsocketClosed",[p],Object.getOwnPropertyDescriptor(Ie.prototype,"_onWebsocketClosed"),Ie.prototype),de()(Ie.prototype,"_onWebsocketError",[p],Object.getOwnPropertyDescriptor(Ie.prototype,"_onWebsocketError"),Ie.prototype),de()(Ie.prototype,"setRenderElement",[p],Object.getOwnPropertyDescriptor(Ie.prototype,"setRenderElement"),Ie.prototype),de()(Ie.prototype,"close",[p],Object.getOwnPropertyDescriptor(Ie.prototype,"close"),Ie.prototype),Ie),xe=new(function(){function e(){a()(this,e),y.msgDispatcher.addMsgHandler(20001,this._onRecvOpenUploadMsg.bind(this)),y.msgDispatcher.addMsgHandler(20003,this._onRecvCloseUploadMsg.bind(this)),y.msgDispatcher.addMsgHandler(21001,this._onRecvTransCodeMsg.bind(this))}return d()(e,[{key:"startUpload",value:function(e){this._init(e),this.startUpload_hook.call(this),Fe.sendOpenUpload({file_path:"/".concat(this.file_path,"/0.jpg"),size:this.size})}},{key:"_init",value:function(e){this.startUpload_hook=e.onStartUpload||function(){},this.uploadSuccess_hook=e.onUploadSuccess||function(){},this.startTransCode_hook=e.onStartTransCode||function(){},this.transCodeSuccess_hook=e.onTransCodeSuccess||function(){},this.failed_hook=e.onFiled||function(){},this.fileTempPath=e.file,this.file_name=e.file_name,this.size=e.file_size,this.upload_mode=e.upload_mode||0,this.check_code=e.CheckCode,this.appid=e.SrvAppID,this.link=e.SrvAddrLink,this.user_id=e.UserID,this.convert_file_path=String(e.Guid).toUpperCase(),this.file_path=String(e.Guid).toUpperCase()}},{key:"_onRecvOpenUploadMsg",value:function(e){var t=this;if(0===e.code){var i=this.file_path;this.file_path=e.data.file_path;var n=e.data.url.replace("http:","https:");wx.uploadFile({url:n,filePath:this.fileTempPath,name:this.file_name,header:{"x-obs-acl":"private","x-obs-storage-class":"STANDARD"},success:function(){var e={guid:i,check_code:t.check_code,appid:t.appid,link:t.link,file_path:t.file_path,file_name:t.file_name,file_size:t.size,user_id:t.user_id};Fe.sendUploadEnd(e)},fail:function(){t.failed_hook.call(t,{code:-1,msg:"上传失败"})}})}else this.failed_hook.call(this,{code:-1,msg:e.msg})}},{key:"_onRecvCloseUploadMsg",value:function(e){0===e.code?this.file_name.includes(".jpg")?this.uploadSuccess_hook.call(this,{board_name:this.file_name,convert_file_path:e.data.file_path,file_path:e.data.file_path,check_code:this.check_code,appid:this.appid,link:this.link,id:this.convert_file_path}):(this.startTransCode_hook.call(this),Fe.sendTransCodeMsg(this.file_path)):this.failed_hook({code:-1,msg:e.msg})}},{key:"_onRecvTransCodeMsg",value:function(e){0===e.code?(e=e.data,this.transCodeSuccess_hook.call(this,{board_name:this.file_name,convert_file_path:e.convert_file_path,file_path:e.file_path,width:e.width,height:e.height,page:e.convert_counts})):this.failed_hook.call(this,{code:-1,msg:e.msg})}}]),e}());function Ce(e,t){var i="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=function(e,t){if(!e)return;if("string"==typeof e)return De(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);"Object"===i&&e.constructor&&(i=e.constructor.name);if("Map"===i||"Set"===i)return Array.from(e);if("Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return De(e,t)}(e))||t&&e&&"number"==typeof e.length){i&&(e=i);var n=0,r=function(){};return{s:r,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,a=!0,o=!1;return{s:function(){i=i.call(e)},n:function(){var e=i.next();return a=e.done,e},e:function(e){o=!0,s=e},f:function(){try{a||null==i.return||i.return()}finally{if(o)throw s}}}}function De(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,n=new Array(t);i<t;i++)n[i]=e[i];return n}function Te(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function Ee(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Te(Object(i),!0).forEach((function(t){_()(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Te(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}var We,Be=new(we=function(){function e(){return a()(this,e),this._init(),y.msgDispatcher.addMsgHandler(19001,this._onCreateWhiteBoardRes.bind(this)),y.msgDispatcher.addMsgHandler(19003,this._onCloseWhiteBoardRes.bind(this)),y.msgDispatcher.addMsgHandler(20005,this._onNotifyGetFileList.bind(this)),y.msgDispatcher.addMsgHandler(20007,this._onGetWhiteBoardFileUrlRes.bind(this)),y.msgDispatcher.addMsgHandler(30101,this._onNotifySwitchWhiteBoardRes.bind(this)),se.on("restoreWhiteBoard",this._onRestoreWhiteBoard.bind(this)),this}return d()(e,[{key:"tryRestoreWhiteBoardRender",value:function(e){var t=this;if(0==this.restoreWhiteBoards.length)return c.log("Empty restore white boards."),!1;var i=this.restoreWhiteBoards[0];if(i.mediaId!=e)return c.log("Different white board."),!1;if(this.setWhiteBoardRender(e,i.parentEle),this.setDisplayMode(e,i.displayMode,i.displayParam),this.restoreWhiteBoards.shift(),this.restoreWhiteBoards.length>0){var n=this.restoreWhiteBoards[0];l((function(){t._doStartReceiveWhiteBoard(n.userId,n.mediaId)})),console.warn("Try to restore white board: "+n.mediaId)}return!0}},{key:"_doStartReceiveWhiteBoard",value:function(e,t){var i=this;this.startReceiveWhiteBoard(e,t).then((function(){c.log("Start receive white board success.")})).catch((function(e){c.error("Start receive white board failed, err: "+e),i.restoreWhiteBoards.shift()}))}},{key:"_onRestoreWhiteBoard",value:function(e){this.restoreWhiteBoards.push(e),1==this.restoreWhiteBoards.length&&this._doStartReceiveWhiteBoard(e.userId,e.mediaId)}},{key:"_onNotifySwitchWhiteBoardRes",value:function(e){var t=e.channel_id,i=this.whiteBoards.find((function(e){return e.channelId===t}));se.trigger("shareOperation",Ee(Ee({},i),{},{type:"switch"}))}},{key:"_init",value:function(){this.whiteBoards=new Array,this.displayMode=null,this.displayParam=null,this.cacheFileUrlMap=new Map,this.restoreWhiteBoards=new Array}},{key:"createWhiteBoard",value:function(e){var t=e.convert_file_path;return t&&(e.board_type=1,e.convert_file_path=t.substr(0,t.lastIndexOf("/"))),Fe.sendCreateWhiteboardReq(e),ae(Y)}},{key:"_onCreateWhiteBoardRes",value:function(e){0===e.result&&(this.startPublishWhiteBoard(e.board_id),se.trigger(Y,Y,Y,0==e.result?W:B))}},{key:"closeWhiteBoard",value:function(e){if(e)return Fe.sendCloseWhiteboardReq(e),ae(X);console.error("Invalid mediaId!")}},{key:"rotateWhiteBoard",value:function(e,t){var i=this.whiteBoards.find((function(e){return e.mediaId===t}));i&&i.rotate(e)}},{key:"switchWhiteBoard",value:function(e){var t=this.whiteBoards.find((function(t){return t.mediaId===e}));t&&t.select()}},{key:"getFileList",value:function(e){Fe.sendRecvBoardFileList(e)}},{key:"switchWhiteBoardPage",value:function(e,t,i){var n=this.whiteBoards.find((function(e){return e.mediaId===t}));n&&n.switchBoardPage(e,i)}},{key:"_onCloseWhiteBoardRes",value:function(e){se.trigger(Y,0==e.result?W:B)}},{key:"startPublishWhiteBoard",value:function(e){Fe.sendPublishMediaReq(R,M,e,"group")}},{key:"stopPublishWhiteBoard",value:function(e){Fe.sendPublishMediaReq(P,M,e,"group")}},{key:"startReceiveWhiteBoard",value:function(e,t){return Fe.sendRecvMediaReq(x,e,M,t),ae(q+v(e,M,t))}},{key:"stopReceiveWhiteBoard",value:function(e,t){var i=this.whiteBoards.find((function(e){return e.mediaId===t}));if(i&&i.pageStore){var n=i.pageStore.getConvertFilePath();n&&this.cacheFileUrlMap.delete(n)}return setTimeout((function(){Fe.sendRecvMediaReq(O,e,M,t)}),100),ae(G+v(e,M,t))}},{key:"startUploadDoc",value:function(e){xe.startUpload(e)}},{key:"setWhiteBoardRender",value:function(e,t,i){var n,r=Ce(this.whiteBoards);try{for(r.s();!(n=r.n()).done;){var s=n.value;if(s.mediaId==e)return void s.setRenderElement(t,i)}}catch(e){r.e(e)}finally{r.f()}c.warn("Cannot find white board by mediaId: "+e)}},{key:"unsetWhiteBoardRender",value:function(e){var t,i=Ce(this.whiteBoards);try{for(i.s();!(t=i.n()).done;){var n=t.value;if(n.mediaId==e)return void n.setRenderElement(null,null)}}catch(e){i.e(e)}finally{i.f()}c.warn("Cannot find white board by mediaId: "+e)}},{key:"setDisplayMode",value:function(e,t,i){if(t==K||t==$||t==Z){if(t==Z){if(!i)return void c.error("setDisplayMode param is invalid!");if(!Number.isInteger(i))return void c.error("setDisplayMode param should be integer!")}if(e){var n=this._findWhiteBoard(e);n?n.setDisplayMode(t,i):c.error("Cannot find white board "+e)}else{var r,s=Ce(this.whiteBoards);try{for(s.s();!(r=s.n()).done;){r.value.setDisplayMode(t,i)}}catch(e){s.e(e)}finally{s.f()}this.displayMode=t,this.displayParam=i}}else c.error("Invalid display mode: "+t)}},{key:"onStartRecvWhiteBoardRes",value:function(e){if(this._findWhiteBoard(e.mediaId))c.error("White baord "+e.mediaId+"exists already!");else{var t=new Oe(e);this.whiteBoards.push(t),this.displayMode&&t.setDisplayMode(this.displayMode,this.displayParam),c.log("Total white board count: "+this.whiteBoards.length)}}},{key:"onStopRecvWhiteBoardRes",value:function(e){if(this._findWhiteBoard(e.mediaId)){for(var t=0;t<this.whiteBoards.length;t++)if(this.whiteBoards[t].mediaId==e.mediaId){this.whiteBoards[t].close(),this.whiteBoards.splice(t,1);break}}else c.error("Cannot find White baord "+e.mediaId)}},{key:"reinitialize",value:function(){var e,t=Ce(this.whiteBoards);try{for(t.s();!(e=t.n()).done;){e.value.close()}}catch(e){t.e(e)}finally{t.f()}this._init()}},{key:"removeWhiteBoard",value:function(e){this.whiteBoards.forEach((function(t,i,n){if(t.mediaId==e)return n.splice(i,1),!1}))}},{key:"getWhiteBoard",value:function(e){return this._findWhiteBoard(e)}},{key:"_findWhiteBoard",value:function(e){var t,i=Ce(this.whiteBoards);try{for(i.s();!(t=i.n()).done;){var n=t.value;if(n.mediaId==e)return n}}catch(e){i.e(e)}finally{i.f()}return null}},{key:"_onGetWhiteBoardFileUrlRes",value:function(e){if(0===e.code){var t=e.data.file_path,i=t.substr(0,t.lastIndexOf("/")),n=this.cacheFileUrlMap.get(i)||new Map,r=e.data.url;-1==e.data.url.search("https")&&(r=e.data.url.replace(/^http/,"https")),n.set(e.data.file_path,r),this.cacheFileUrlMap.set(i,n)}else console.warn("获取图片下载url失败")}},{key:"_onNotifyGetFileList",value:function(e){var t=e.data.file_list;se.trigger("onGetFileList",t)}},{key:"_getFileUrl",value:function(e){if(console.warn("file_path",e),e){var t=e.substr(0,e.lastIndexOf("/"));this.cacheFileUrlMap.get(t)&&this.cacheFileUrlMap.get(t).get(e)||Fe.sendGetWhiteBoardFileUrlReq(e)}}}]),e}(),de()(we.prototype,"tryRestoreWhiteBoardRender",[p],Object.getOwnPropertyDescriptor(we.prototype,"tryRestoreWhiteBoardRender"),we.prototype),de()(we.prototype,"_onRestoreWhiteBoard",[p],Object.getOwnPropertyDescriptor(we.prototype,"_onRestoreWhiteBoard"),we.prototype),de()(we.prototype,"setDisplayMode",[p],Object.getOwnPropertyDescriptor(we.prototype,"setDisplayMode"),we.prototype),de()(we.prototype,"onStopRecvWhiteBoardRes",[p],Object.getOwnPropertyDescriptor(we.prototype,"onStopRecvWhiteBoardRes"),we.prototype),de()(we.prototype,"reinitialize",[p],Object.getOwnPropertyDescriptor(we.prototype,"reinitialize"),we.prototype),we);function Ae(e,t){var i="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=function(e,t){if(!e)return;if("string"==typeof e)return Ne(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);"Object"===i&&e.constructor&&(i=e.constructor.name);if("Map"===i||"Set"===i)return Array.from(e);if("Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return Ne(e,t)}(e))||t&&e&&"number"==typeof e.length){i&&(e=i);var n=0,r=function(){};return{s:r,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,a=!0,o=!1;return{s:function(){i=i.call(e)},n:function(){var e=i.next();return a=e.done,e},e:function(e){o=!0,s=e},f:function(){try{a||null==i.return||i.return()}finally{if(o)throw s}}}}function Ne(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,n=new Array(t);i<t;i++)n[i]=e[i];return n}var je=new(We=function(){function e(){a()(this,e),this.upPcMap=new Map,this.downPcMap=new Map,this.restoreDownTracks=new Array,y.msgDispatcher.addMsgHandler(14106,this.onNotifyUserMediaState.bind(this)),y.msgDispatcher.addMsgHandler(14109,this.onNotifyGroupMediaStates.bind(this)),y.msgDispatcher.addMsgHandler(14110,this.onNotifyUserJoinGroup.bind(this)),y.msgDispatcher.addMsgHandler(14111,this.onNotifyUserLeaveGroup.bind(this)),y.msgDispatcher.addMsgHandler(18003,this.onRecvStreamRes.bind(this)),y.msgDispatcher.addMsgHandler(18e3,this.onNotifySendStreamRes.bind(this)),se.on("restoreDownTrack",this._onRestoreDownTrack.bind(this))}return d()(e,[{key:"tryRestoreMediaRender",value:function(e){var t=this;if(0==this.restoreDownTracks.length)return c.log("Empty restore tracks."),!1;var i=this.restoreDownTracks[0];return e.userId!==i.userId||e.mediaType!==i.mediaType||e.mediaId!==i.mediaId?(c.log("Different track."),!1):(i.videoEle&&this.setMediaRender(i.userId,i.mediaType,i.mediaId,i.videoEle),this.restoreDownTracks.shift(),this.restoreDownTracks.length>0&&l((function(){t._doStartReceiveMedia(t.restoreDownTracks[0])})),!0)}},{key:"_doStartReceiveMedia",value:function(e){var t=this;this.startReceiveMedia(e.userId,e.mediaType,e.mediaId).then((function(){c.log("Start receive media success.")})).catch((function(e){c.error("Start receive media failed, err: "+e),t.restoreDownTracks.shift()}))}},{key:"_doStopReceiveMedia",value:function(e){this.stopReceiveMedia(e.userId,e.mediaType,e.mediaId).then((function(){c.log("Start receive media success.")})).catch((function(e){c.error("Start receive media failed, err: "+e)}))}},{key:"_onRestoreDownTrack",value:function(e){this.restoreDownTracks.push(e),1==this.restoreDownTracks.length&&this._doStartReceiveMedia(e)}},{key:"startPublishMedia",value:function(e,t,i){switch(e){case I:qe.startPublishAudio(t);break;case w:ce.startPublishVideo(t,i);break;case S:he.startScreenShare(i);break;case M:Be.startPublishWhiteBoard(t);break;default:c.error("Unknown media type: "+e)}}},{key:"stopPublishMedia",value:function(e,t){switch(e){case I:qe.stopPublishAudio();break;case w:ce.stopPublishVideo(t);break;case S:he.stopScreenShare();break;case M:Be.stopPublishWhiteBoard(t);break;default:c.error("Unknown media type: "+e)}}},{key:"startReceiveMedia",value:function(e,t,i){switch(t){case I:return qe.startReceiveAudio(e,i);case w:return ce.startReceiveVideo(e,i);case S:return he.startReceiveScreenShare(e,i);case M:return Be.startReceiveWhiteBoard(e,i);default:return new Promise((function(e,i){i("Unknown media type: "+t)}))}}},{key:"stopReceiveMedia",value:function(e,t,i){switch(t){case I:return qe.stopReceiveAudio(e,i);case w:return ce.stopReceiveVideo(e,i);case S:return he.stopReceiveScreenShare(e,i);case M:return Be.stopReceiveWhiteBoard(e,i);default:c.error("Unknown media type: "+t)}}},{key:"setMediaRender",value:function(e,t,i,n,r){switch(t){case I:case w:case S:console.warn("Unexpected mediaType: "+t);break;case M:Be.setWhiteBoardRender(i,n,r);break;default:c.error("Unknown media type: "+t)}}},{key:"unsetMediaRender",value:function(e,t,i){switch(c.trace("Calling unsetMediaRender: "+e+", "+t),t){case I:case w:case S:console.warn("Unexpected mediaType: "+t);break;case M:Be.unsetWhiteBoardRender(i);break;default:c.error("Unknown media type: "+t)}}},{key:"_setMediaRender",value:function(e,t,i,n,r){if(e==y.userInfo.userId)t==w?ce.setLocalVideoRender(i,n,r):t==S?he.setLocalScreenShareRender(n):c.error("Unexpected media type: "+t);else{var s=this.findDownPcByUserMeida(e,t,i);s?(n.srcObject=s.mediaStream,s.videoEle=n,this.curSpkDevId&&qe.setAudioSpeaker(n)):c.error("Cannot find down peer connection!")}}},{key:"_unsetMediaRender",value:function(e,t){if(t&&"srcObject"in t)if(e==y.userInfo.userId)if(t.srcObject){var i,n=Ae(t.srcObject.getTracks());try{for(n.s();!(i=n.n()).done;){i.value.stop()}}catch(e){n.e(e)}finally{n.f()}t.srcObject=null}else c.warn("Invalid srcObject!");else t.srcObject=null;else c.error("Invalid videoEle!")}},{key:"onNotifyUserJoinGroup",value:function(e,t){se.trigger("onUserJoinGroup",e.user_id)}},{key:"onNotifyUserLeaveGroup",value:function(e,t){se.trigger("onUserLeaveGroup",e.user_id)}},{key:"_getEventType",value:function(e,t,i,n){return(e==x?q:G)+v(t,i,n)}},{key:"onRecvStreamRes",value:function(e,t){if(e.media_type===M)try{if(0===e.group_id.length||0===e.media_id.length)throw"Invalid recv stream response!!!"+e;var i=null;if(!e.stream_server)throw"Cannot find 'stream_server' in msg!";if(!(i=e.stream_server))throw"Cannot find webrtc gateway: "+e.stream_server;e.recv===x?Be.onStartRecvWhiteBoardRes({userId:e.user_id,mediaType:e.media_type,mediaId:e.media_id,streamId:e.stream_id,streamServer:i,streamToken:e.subscribe_token}):Be.onStopRecvWhiteBoardRes({userId:e.user_id,mediaType:e.media_type,mediaId:e.media_id,streamId:e.stream_id}),se.trigger(this._getEventType(e.recv,e.user_id,e.media_type,e.media_id),W)}catch(t){c.error(t),se.trigger(this._getEventType(e.recv,e.user_id,e.media_type,e.media_id),B)}}},{key:"onNotifySendStreamRes",value:function(e){var t={streamId:e.stream_id,send:e.send};Fe.sendNotifySendStreamRes(t)}},{key:"onNotifyUserMediaState",value:function(e,t){if(e.media_type==S||e.media_type==I||e.media_type==w||e.media_type==M){var i={userId:e.user_id,mediaType:e.media_type,mediaId:e.media_id,mediaName:e.media_description||e.media_name};e.operation==P?(se.trigger("onUnPublishMedia",i),this._doStopReceiveMedia(i)):e.operation==R&&(se.trigger("onPublishMedia",i),this._doStartReceiveMedia(i))}else c.warn("Unexpected media type: ",e.media_type)}},{key:"onNotifyGroupMediaStates",value:function(e,t){if(y.restoring)y.restoring=!1;else{var i,n=[],r=Ae(e.user_info);try{for(r.s();!(i=r.n()).done;){var s=i.value;n.push(s.user_id)}}catch(e){r.e(e)}finally{r.f()}n.length>0&&se.trigger("onGroupUserList",n);var a,o=Ae(e.user_info);try{for(o.s();!(a=o.n()).done;){var d=a.value;if(!(d.media_info.length<=0)){var c,h=Ae(d.media_info);try{for(h.s();!(c=h.n()).done;){var u=c.value,l={userId:d.user_id,mediaType:u.media_type,mediaId:u.media_id,mediaName:u.media_description};se.trigger("onPublishMedia",l),this._doStartReceiveMedia(l)}}catch(e){h.e(e)}finally{h.f()}}}}catch(e){o.e(e)}finally{o.f()}var p,f=Ae(e.group_media);try{for(f.s();!(p=f.n()).done;){var g=p.value,v={userId:g.user_id,mediaType:g.media_type,mediaId:g.media_id,mediaName:g.media_name};this._doStartReceiveMedia(v)}}catch(e){f.e(e)}finally{f.f()}se.trigger("onGroupPushComplete")}}}]),e}(),de()(We.prototype,"tryRestoreMediaRender",[p],Object.getOwnPropertyDescriptor(We.prototype,"tryRestoreMediaRender"),We.prototype),de()(We.prototype,"_onRestoreDownTrack",[p],Object.getOwnPropertyDescriptor(We.prototype,"_onRestoreDownTrack"),We.prototype),de()(We.prototype,"startPublishMedia",[p],Object.getOwnPropertyDescriptor(We.prototype,"startPublishMedia"),We.prototype),de()(We.prototype,"stopPublishMedia",[p],Object.getOwnPropertyDescriptor(We.prototype,"stopPublishMedia"),We.prototype),de()(We.prototype,"startReceiveMedia",[p],Object.getOwnPropertyDescriptor(We.prototype,"startReceiveMedia"),We.prototype),de()(We.prototype,"stopReceiveMedia",[p],Object.getOwnPropertyDescriptor(We.prototype,"stopReceiveMedia"),We.prototype),de()(We.prototype,"setMediaRender",[p],Object.getOwnPropertyDescriptor(We.prototype,"setMediaRender"),We.prototype),de()(We.prototype,"unsetMediaRender",[p],Object.getOwnPropertyDescriptor(We.prototype,"unsetMediaRender"),We.prototype),We);function Ue(e,t){var i="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=function(e,t){if(!e)return;if("string"==typeof e)return Le(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);"Object"===i&&e.constructor&&(i=e.constructor.name);if("Map"===i||"Set"===i)return Array.from(e);if("Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return Le(e,t)}(e))||t&&e&&"number"==typeof e.length){i&&(e=i);var n=0,r=function(){};return{s:r,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,a=!0,o=!1;return{s:function(){i=i.call(e)},n:function(){var e=i.next();return a=e.done,e},e:function(e){o=!0,s=e},f:function(){try{a||null==i.return||i.return()}finally{if(o)throw s}}}}function Le(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,n=new Array(t);i<t;i++)n[i]=e[i];return n}var qe=new(function(){function e(){a()(this,e),this.curMicDevId=null,this.curSpkDevId=null,this.audioMagicValue=0,this.recvMagicAudio=!1}return d()(e,[{key:"startPublishAudio",value:function(e){if(e){this.setCurMicDevId(e);var t=null;t=0==this.audioMagicValue?"appdef_mic":"appdef_mic_magic",Fe.sendPublishMediaReq(R,I,t)}else c.error("Invalid devId!")}},{key:"stopPublishAudio",value:function(e){var t=null;t=0==this.audioMagicValue?"appdef_mic":"appdef_mic_magic",Fe.sendPublishMediaReq(P,I,t)}},{key:"startReceiveAudio",value:function(e,t){if(e&&t)return Fe.sendRecvMediaReq(x,e,I,t),ae(q+v(e,I,t));c.error("Invalid srcUserId or mediaId!")}},{key:"stopReceiveAudio",value:function(e,t){if(e&&t)return Fe.sendRecvMediaReq(O,e,I,t),ae(G+v(e,I,t));c.error("Invalid srcUserId or mediaId!")}},{key:"chooseSpkDevice",value:function(e){this.curSpkDevId=e;var t,i=Ue(je.downPcMap.values());try{for(i.s();!(t=i.n()).done;){var n=t.value;n.videoEle&&this.setAudioSpeaker(n.videoEle)}}catch(e){i.e(e)}finally{i.f()}}},{key:"setSendMagicAudioValue",value:function(e){if(this.audioMagicValue!=e){this.audioMagicValue=e,c.log("Set send audio magic to "+e);var t,i=Ue(je.upPcMap);try{for(i.s();!(t=i.n()).done;){var n,r=Ue(t.value.upTracks);try{for(r.s();!(n=r.n()).done;){var s=n.value;if(s.mediaType==I){Fe.sendSetAudioMagic(s.streamId,e);break}}}catch(e){r.e(e)}finally{r.f()}}}catch(e){i.e(e)}finally{i.f()}}}},{key:"setRecvMagicAudioMode",value:function(e){e==D||e==T||e==E?(c.log("Set recv audio magic mode: "+e),this.recvMagicAudio=e):c.error("Invalid recv audio magic mode: "+e)}},{key:"setAudioSpeaker",value:function(e){var t=this;void 0!==e.sinkId?e.setSinkId(this.curSpkDevId).then((function(){c.log("Set speaker "+t.curSpkDevId+" success.")})).catch((function(e){c.error("Set speaker "+t.curSpkDevId+" failed!",e)})):c.error("Invalid media element!")}},{key:"setCurMicDevId",value:function(e){e?this.curMicDevId=e:c.error("Invalid microphone device!")}},{key:"getCurMicDevId",value:function(){return this.curMicDevId}},{key:"getCurSpkDevId",value:function(){return this.curSpkDevId}},{key:"buildConstraints",value:function(e){return{audio:{deviceId:e}}}}]),e}());function Ge(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}var Fe=new(function(){function e(){a()(this,e)}return d()(e,[{key:"sendJoinGroupReq",value:function(e){var t={business:"GS",id:14100,group_id:e};t=this._dealMsg(t),y.websocket.send(JSON.stringify(t))}},{key:"sendLeaveGroupReq",value:function(){var e={business:"GS",id:14102};e=this._dealMsg(e),y.websocket.send(JSON.stringify(e))}},{key:"sendResolutionReport",value:function(e){var t={business:"SS",id:18004,stream_id:e.streamId,width:e.width,height:e.height,channel_type:e.channelType,report_type:e.reportType};t=this._dealMsg(t),y.websocket.send(JSON.stringify(t))}},{key:"sendLogoutReq",value:function(){var e={business:"BASE",id:10002};e=this._dealMsg(e),y.websocket.send(JSON.stringify(e))}},{key:"sendLoginReq",value:function(e){var t={business:"BASE",id:1e4,app_id:e.appId,company_id:e.companyId,token:e.token,user_id:e.userId,client_guid:u(),os_type:e.osType,mutex_type:e.mutexType,force_login:e.forceLogin,registered_user:e.registered,protocol_version:"0.0.1",sdk_type:26,extend_info:e.extendInfo};t=this._dealMsg(t),y.websocket.send(JSON.stringify(t))}},{key:"sendPublishMediaReq",value:function(e,t,i,n){var r={business:"GS",id:14104,media_type:t,media_id:i,media_owner:n,operation:e};r=this._dealMsg(r),y.websocket.send(JSON.stringify(r))}},{key:"sendRecvMediaReq",value:function(e,t,i,n){var r={business:"SS",id:18002,group_id:y.userInfo.groupId,user_id:t,media_type:i,media_id:n,recv:e};i==I&&(qe.recvMagicAudio==E?-1==n.indexOf("_magic")&&(r.media_id=n+"_magic"):qe.recvMagicAudio==T&&-1!=n.indexOf("_magic")&&(r.media_id=n.substr(0,n.length-6))),r.media_owner=i==M?"group":"user",r=this._dealMsg(r),y.websocket.send(JSON.stringify(r))}},{key:"sendRecvWhiteboardReq",value:function(e,t,i){var n={business:"SS",id:18002,group_id:y.userInfo.groupId,media_type:t,media_id:i,recv:e,source_type:1,user_data:{}};n=this._dealMsg(n),y.websocket.send(JSON.stringify(n))}},{key:"sendCreateWhiteboardReq",value:function(e){var t={business:"WBS",id:19e3,cli_seq_id:1,board_type:0,width:1280,height:768,file_path:"",convert_file_path:"",page:1};(t=Object.assign(t,e)).convert_file_path=t.convert_file_path.toUpperCase(),t=this._dealMsg(t),y.websocket.send(JSON.stringify(t))}},{key:"sendCloseWhiteboardReq",value:function(e){var t={business:"WBS",id:19002,board_id:e};t=this._dealMsg(t),y.websocket.send(JSON.stringify(t))}},{key:"sendOpenUpload",value:function(e){var t=e.file_path,i=e.size,n={business:"STORE",id:2e4,upload_id:y.userInfo.userId,checksum:"",file_path:t,file_size:i,upload_mode:0};n=this._dealMsg(n),y.websocket.send(JSON.stringify(n))}},{key:"sendUploadEnd",value:function(e){var t=function(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Ge(Object(i),!0).forEach((function(t){_()(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Ge(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}({business:"STORE",id:20002},e);t=this._dealMsg(t),y.websocket.send(JSON.stringify(t))}},{key:"sendTransCodeMsg",value:function(e){var t={business:"DC",id:21e3,file_path:e};t=this._dealMsg(t),y.websocket.send(JSON.stringify(t))}},{key:"sendNotifySendStreamRes",value:function(e){var t={business:"SS",id:18001,stream_id:e.streamId,send:e.send,result:e.result};t=this._dealMsg(t),y.websocket.send(JSON.stringify(t))}},{key:"sendLogoutRecvChannelReq",value:function(e){var t={business:"SS",id:19012,stream_id:e,client_id:"{"+y.userInfo.appId+";"+y.userInfo.groupId+"};"+y.userInfo.userId};t=this._dealMsg(t),y.websocket.send(JSON.stringify(t))}},{key:"sendLoginRecvChannelReq",value:function(e,t){var i={business:"WBS",id:19004,stream_id:e.streamId,stream_token:e.streamToken,media_type:e.media_type,media_id:e.media_id,client_id:"{"+y.userInfo.appId+";"+y.userInfo.groupId+"};"+y.userInfo.userId,version:"1.0.0",bind_id:t};i=this._dealMsg(i,e.channelId),y.websocket.send(JSON.stringify(i))}},{key:"sendSdpInfo",value:function(e,t){var i={business:"SS",id:19008,type:e.type,pc_id:t,sdp:e.sdp};i=this._dealMsg(i),y.websocket.send(JSON.stringify(i))}},{key:"sendCandidate",value:function(e,t){var i={business:"SS",id:19008,pc_id:t,candidate:e.candidate.candidate,sdpMid:e.candidate.sdpMid,sdpMLineIndex:e.candidate.sdpMLineIndex};i=this._dealMsg(i),y.websocket.send(JSON.stringify(i))}},{key:"sendLoginSendChannelReq",value:function(e,t){var i={business:"WBS",id:19006,stream_id:e.streamId,stream_token:e.streamToken,media_type:e.mediaType,media_id:e.mediaId,client_id:y.getClientId(),version:"1.0.0",bind_id:t};i=this._dealMsg(i),y.websocket.send(JSON.stringify(i))}},{key:"sendSetAudioMagic",value:function(e,t){var i={business:"SS",id:19010,stream_id:e,client_id:y.getClientId(),param:[{param_type:"SoundTouch",param_value:t.toString()}]};i=this._dealMsg(i),y.websocket.send(JSON.stringify(i))}},{key:"SendSetAudioMagicReq",value:function(e,t){var i={business:"SS",id:19010,stream_id:e,client_id:y.getClientId(),param:[{param_type:"SoundTouch",param_value:t.toString()}]};i=this._dealMsg(i),y.websocket.send(JSON.stringify(i))}},{key:"sendGetWhiteBoardFullDataReq",value:function(e){var t={id:30003};t=this._dealMsg(t,e),y.websocket.send(JSON.stringify(t))}},{key:"sendChangeWhiteBoardProperty",value:function(e,t){var i={id:30103,seq_id:Math.floor(1e3*Math.random()),edit_id:e.edit_id,zoom:e.zoom,rotate_angle:e.rotateAngle,mouse_posx:e.mouse_posx,mouse_posy:e.mouse_posy,scroll_posx:e.scroll_posx,cur_page:e.cur_page};i=this._dealMsg(i,t),y.websocket.send(JSON.stringify(i))}},{key:"sendSwitchWhiteBoard",value:function(e,t){var i={id:30101,seq_id:Math.floor(100*Math.random()),edit_id:e,is_select:!0};i=this._dealMsg(i,t),y.websocket.send(JSON.stringify(i))}},{key:"sendRecvBoardFileList",value:function(e){var t={business:"STORE",id:20004,path:e};t=this._dealMsg(t),y.websocket.send(JSON.stringify(t))}},{key:"sendGetWhiteBoardFileUrlReq",value:function(e){var t={business:"STORE",id:20006,file_path:e};t=this._dealMsg(t),y.websocket.send(JSON.stringify(t))}},{key:"sendUserMsg",value:function(e){var t={business:"SG",id:11e3,dst_user_id:e.dstUserId,msg_id:1024,msg:e.msg};t=this._dealMsg(t),y.websocket.send(JSON.stringify(t))}},{key:"sendUserMsgAck",value:function(e){var t={business:"SG",id:11004,src_user_id:e.src_user_id,msg_id:e.msg_id};t=this._dealMsg(t),y.websocket.send(JSON.stringify(t))}},{key:"sendGroupMsgWithWhiteList",value:function(e){var t={business:"SG",id:11006,group_id:e.groupId,white_list:e.whiteList,msg_id:1024,msg:e.msg};t=this._dealMsg(t),y.websocket.send(JSON.stringify(t))}},{key:"sendGroupMsgWithBlackList",value:function(e){var t={business:"SG",id:11006,group_id:e.groupId,black_list:e.blackList,msg_id:1024,msg:e.msg};t=this._dealMsg(t),y.websocket.send(JSON.stringify(t))}},{key:"sendGroupMsg",value:function(e){var t={business:"SG",id:11006,group_id:e.groupId,msg_id:1024,msg:e.msg};t=this._dealMsg(t),y.websocket.send(JSON.stringify(t))}},{key:"sendGroupMsgAck",value:function(e){var t={business:"SG",id:11010,group_id:e.group_id,src_user_id:e.src_user_id,msg_id:e.msg_id};t=this._dealMsg(t),y.websocket.send(JSON.stringify(t))}},{key:"sendKickOutRes",value:function(){var e={business:"PS",id:12008};e=this._dealMsg(e),y.websocket.send(JSON.stringify(e))}},{key:"sendOpenEdit",value:function(e){var t={id:30001};t=this._dealMsg(t,e),y.websocket.send(JSON.stringify(t))}},{key:"sendPageInfoMsg",value:function(e){var t={id:30200,page:{pid:e.curPage,action:e.action},edit_id:e.edit_id,seq_id:e.seq_id,type:"page"};t=this._dealMsg(t,e.channelId),y.websocket.send(JSON.stringify(t))}},{key:"sendGraphMsg",value:function(e){var t=this._dealMsg(e,e.channelId);y.websocket.send(JSON.stringify(t))}},{key:"_dealMsg",value:function(e,t){return t||(t=y.mainWebsocketChannelId),{id:102,channel_id:t,msg:JSON.stringify(e)}}}]),e}()),He=new(function(){function e(){a()(this,e),this.serverDomain="https://fspwxlite.haoshitong.com:8443/weapp/webrtc_room",this.requestNum=0,this.heart=0,this.heartBeatReq=0,this.requestSeq=0,this.requestTask=[]}return d()(e,[{key:"request",value:function(e){var t=this;t.requestNum++;var i=wx.request({url:t.serverDomain+e.url,data:e.data||{},method:"POST",header:{"content-type":"application/json"},success:function(t){t.data.code?(console.error("服务器请求失败, url="+e.url+", params = "+(e.data?JSON.stringify(e.data):"")+", 错误信息="+JSON.stringify(t)),e.fail&&e.fail({errCode:t.data.code,errMsg:t.data.message})):e.success&&e.success(t)},fail:function(t){console.error("请求失败, url="+e.url+", 错误信息="+JSON.stringify(t)),e.fail&&e.fail(t)},complete:function(){t.requestNum--,console.log("complete requestNum: ",t.requestNum)}});return t.requestTask[t.requestSeq++]=i,i}},{key:"clearRequest",value:function(){for(var e=0;e<this.requestSeq;e++)this.requestTask[e].abort();this.requestTask=[],this.requestSeq=0}},{key:"getLoginInfo",value:function(e,t,i){var n={};e&&(n.userID=e),this.request({url:"/get_login_info",data:n,success:t,fail:i})}},{key:"getRoomList",value:function(e,t,i,n){this.request({url:"/get_room_list",data:{index:e,count:t,roomType:"trtc"},success:i,fail:n})}},{key:"createRoom",value:function(e,t,i,n){console.log("roomInfo",t);this.request({url:"/create_room",data:{userID:e,roomInfo:t,roomType:"trtc"},success:function(e){i&&i(e)},fail:n})}},{key:"enterRoom",value:function(e,t,i,n){this.request({url:"/enter_room",data:{userID:e,roomID:t},success:function(e){i&&i(e)},fail:n})}},{key:"quitRoom",value:function(e,t,i,n){this.request({url:"/quit_room",data:{userID:e,roomID:t},success:i,fail:n})}},{key:"startHeartBeat",value:function(e,t,i,n){this.heart="1",this.heartBeat(e,t,i,n)}},{key:"stopHeartBeat",value:function(){this.heart="",this.heartBeatReq&&(console.log("停止心跳"),this.heartBeatReq.abort(),this.heartBeatReq=null)}},{key:"heartBeat",value:function(e,t,i,n){var r=this;r.heart?r.heartBeatReq=r.request({url:"/heartbeat",data:{userID:e,roomID:t},success:function(s){r.heart&&(console.log("心跳成功"),i&&i(s),setTimeout((function(){r.heartBeat(e,t,i,n)}),7e3))},fail:function(s){n&&n(s),r.heart&&setTimeout((function(){r.heartBeat(e,t,i,n)}),7e3)}}):r.clearRequest()}}]),e}()),Je=new r.a({init:"uninit",transitions:[{name:"doInit",from:["uninit","restoring"],to:"initing"},{name:"initSuccess",from:"initing",to:"inited"},{name:"initFailed",from:"initing",to:"uninit"},{name:"doLogin",from:"inited",to:"logining"},{name:"loginSuccess",from:"logining",to:"logined"},{name:"loginFailed",from:"logining",to:"inited"},{name:"doJoin",from:"logined",to:"joining"},{name:"joinSuccess",from:"joining",to:"joined"},{name:"joinFailed",from:"joining",to:"logined"},{name:"doLeave",from:"joined",to:"leaving"},{name:"leaveSuccess",from:"leaving",to:"logined"},{name:"leaveFailed",from:"leaving",to:"joined"},{name:"doLogout",from:"logined",to:"logouting"},{name:"logoutSuccess",from:"logouting",to:"inited"},{name:"logoutFailed",from:"logouting",to:"logined"},{name:"doDestroy",from:["inited","logined","joined"],to:"uninit"},{name:"doRestore",from:"joined",to:"restoring"}],data:{registered:!1,forceLogouted:!1,kickedOut:!1,hasLogin:!1},methods:{onWebSocketClosed:function(){c.warn("Signalling websocket closed, state: "+this.state,Date.now()),y.websocket&&(y.websocket.close(),y.websocket=null),"joined"!=this.state||this.forceLogouted||this.kickedOut||this.doRestore()},onLeaveGroup:function(){y.userInfo.groupId=null,Be.reinitialize()},onLogout:function(){this.onLeaveGroup(),y.userInfo.userId=null},onDestroy:function(){this.onLogout(),this.hasLogin=!1,y.userInfo.appId=null,y.userInfo.token=null,y.userInfo.companyId=null,y.websocket&&(y.websocket.close(),y.websocket=null)},onLoginRes:function(e,t){var i=this;0==e.result?He.getLoginInfo(y.userInfo.userId,(function(e){i.loginSuccess({sdkAppId:e.data.sdkAppID,userSig:e.data.userSig,accountType:e.data.accountType})}),(function(e){i.loginFailed()})):i.loginFailed(e.result)},onLogoutRes:function(e,t){0==e.result?this.logoutSuccess():this.logoutFailed()},onJoinGroupRes:function(e,t){var i=this;0==e.result?He.getLoginInfo(e.room_id+"_"+y.userInfo.userId,(function(t){var n=t.data.sdkAppID,r=t.data.userSig;He.createRoom(y.userInfo.userId,y.userInfo.groupId,(function(t){console.log("createRoom success."+JSON.stringify(t)),i.joinSuccess({serverRoomId:t.data.roomID,serverUserId:e.room_id+"_"+y.userInfo.userId,txRoomId:e.room_id,privateMapKey:t.data.privateMapKey,sdkAppId:n,userSig:r})}),(function(e){console.error("Creat room failed!"),i.joinFailed()}))}),(function(e){console.error("Get login info failed!"),i.joinFailed()})):this.joinFailed()},onLeaveGroupRes:function(e,t){0==e.result?this.leaveSuccess():this.leaveFailed()},onForceLogout:function(e,t){this.forceLogouted=!0,this.onLogout(),se.trigger("onUserForceLogout")},onKickOut:function(e,t){this.kickedOut=!0,this.onLogOut(),Fe.sendKickOutRes(),se.trigger("onKickOut")},_onConnectSuccess:function(e,t){if(0==e.result){if(this.hasLogin)return;y.mainWebsocketChannelId=e.channel_id,this.hasLogin=!0;var i={appId:y.userInfo.appId,userId:y.userInfo.userId,token:y.loginParams.token,companyId:y.loginParams.companyId,osType:"webchat",mutexType:y.loginParams.mutexType,forceLogin:y.loginParams.forceLogin,registered:y.loginParams.registered,extendInfo:y.loginParams.extendInfo};Fe.sendLoginReq(i)}},onDoInit:function(e,t){var i=this;this.registered||(y.msgDispatcher.addMsgHandler(10001,this.onLoginRes.bind(this)),y.msgDispatcher.addMsgHandler(10003,this.onLogoutRes.bind(this)),y.msgDispatcher.addMsgHandler(10004,this.onForceLogout.bind(this)),y.msgDispatcher.addMsgHandler(12007,this.onKickOut.bind(this)),y.msgDispatcher.addMsgHandler(14101,this.onJoinGroupRes.bind(this)),y.msgDispatcher.addMsgHandler(14103,this.onLeaveGroupRes.bind(this)),y.msgDispatcher.addMsgHandler(101,this._onConnectSuccess.bind(this)),this.registered=!0),l((function(){i.initSuccess()}))},onTransition:function(e){c.state("transition: "+e.transition+", from "+e.from+" to "+e.to)},onInitSuccess:function(e,t){var i=this;if(y.restoring){var n={userId:y.userInfo.userId,appId:y.userInfo.appId,companyId:y.loginParams.companyId,token:y.loginParams.token,forceLogin:!0,mutexType:y.loginParams.mutexType,extendInfo:y.loginParams.extendInfo,accessUrl:y.loginParams.accessUrl};l((function(){i.doLogin(n)}))}else se.trigger(A,W)},onInitFailed:function(e,t){y.restoring?(y.restoring=!1,c.warn("Restoring failed for init!")):se.trigger(A,B)},onDoLogin:function(e,t){var i=this;t.userId?y.userInfo.userId=t.userId:l((function(){i.loginFailed("Invalid userId!")})),t.appId?y.userInfo.appId=t.appId:l((function(){i.loginFailed("Invalid appId!")})),t.token?y.loginParams.token=t.token:l((function(){i.loginFailed("Invalid token!")})),t.accessUrl||(t.accessUrl="https://paas-demo-private.haoshitong.com:21000/server/address"),y.loginParams.accessUrl=t.accessUrl,t.forceLogin&&(y.loginParams.forceLogin=t.forceLogin?1:0),t.extendInfo&&(y.loginParams.extendInfo=t.extendInfo),t.companyId&&(y.loginParams.companyId=t.companyId),t.mutexType&&(y.loginParams.mutexType=t.mutexType);var n=this;try{wx.request({url:y.buildGetProxyWayUrl(t.accessUrl),data:{},method:"GET",header:{"content-type":"application/json"},success:function(e){if(console.log("Response from access service: "+JSON.stringify(e)),0!=e.data.code)throw"Get websocket gateway error!";var i=e.data.result;wx.request({url:y.buildGetGateWayUrl(t.accessUrl),data:{},method:"GET",header:{"content-type":"application/json"},success:function(e){if(0!=e.data.code)throw"Cannot find websocket gateway from response!";var t=e.data.result;if(t){var r={addrUrl:i,backward_addr:t,handler:y.msgDispatcher,seq_id:parseInt(1e3*Math.random()),closed:function(){n.onWebSocketClosed()},error:function(){n.loginFailed("Websocket error!")}};y.websocket=k,y.websocket.createProxyConnect(r)}},fail:function(e){throw"Get websocket gateway failed"},complete:function(e){console.log("Get websocket gateway complete")}})}})}catch(e){l((function(){n.loginFailed(e)}))}},onLoginSuccess:function(e,t){var i=this;y.restoring?l((function(){i.doJoin(y.userInfo.groupId)})):se.trigger(N,W,t)},onLoginFailed:function(e,t){c.error("Login failed: "+t),y.restoring?(y.restoring=!1,c.warn("Restoring failed for login!")):se.trigger(N,B)},onDoJoin:function(e,t){Fe.sendJoinGroupReq(t),y.userInfo.groupId=t},onJoinSuccess:function(e,t){y.restoring?c.log("Restoring success."):se.trigger(U,W,t)},onJoinFailed:function(e,t){y.restoring?(y.restoring=!1,c.warn("Restoring failed for join group!")):se.trigger(U,B)},onDoLeave:function(e,t){Fe.sendLeaveGroupReq()},onLeaveSuccess:function(e,t){this.onLeaveGroup(),se.trigger(L,W)},onLeaveFailed:function(e,t){se.trigger(L,B)},onDoLogout:function(e,t){Fe.sendLogoutReq()},onLogoutSuccess:function(e,t){this.onLogout(),se.trigger(j,W)},onLogoutFailed:function(e,t){se.trigger(j,B)},onDoDestroy:function(e,t){this.onDestroy()},onRestoring:function(e,t){var i=this;y.restoring=!0,l((function(){i.doInit()}))}}});function Ve(e,t){var i="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=function(e,t){if(!e)return;if("string"==typeof e)return ze(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);"Object"===i&&e.constructor&&(i=e.constructor.name);if("Map"===i||"Set"===i)return Array.from(e);if("Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return ze(e,t)}(e))||t&&e&&"number"==typeof e.length){i&&(e=i);var n=0,r=function(){};return{s:r,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,a=!0,o=!1;return{s:function(){i=i.call(e)},n:function(){var e=i.next();return a=e.done,e},e:function(e){o=!0,s=e},f:function(){try{a||null==i.return||i.return()}finally{if(o)throw s}}}}function ze(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,n=new Array(t);i<t;i++)n[i]=e[i];return n}var Ye=new(function(){function e(){a()(this,e),this.cachedUserList=null,y.msgDispatcher.addMsgHandler(12120,this.onGetOnlineUsersRes.bind(this)),y.msgDispatcher.addMsgHandler(12123,this.onOnlineUsersNotify.bind(this)),y.msgDispatcher.addMsgHandler(14001,this.onInviteRes.bind(this)),y.msgDispatcher.addMsgHandler(14002,this.onNotifyInvite.bind(this)),y.msgDispatcher.addMsgHandler(14004,this.onNotifyIgnoreInvite.bind(this)),y.msgDispatcher.addMsgHandler(14007,this.onCancelInviteRes.bind(this)),y.msgDispatcher.addMsgHandler(14008,this.onNotifyCancelInvite.bind(this))}return d()(e,[{key:"getOnlineUsers",value:function(){var e={business:"PS",id:12119,seq_id:Math.floor(4096*Math.random())};e=this._dealMsg(e),y.websocket.send(JSON.stringify(e))}},{key:"onGetOnlineUsersRes",value:function(e){if(0==e.result){var t,i={totalPages:e.page_info.total_pages,curPage:e.page_info.cur_page},n=[],r=Ve(e.member_state_list);try{for(r.s();!(t=r.n()).done;){var s,a=t.value,o={userId:a.uid,onlineInfo:[]},d=Ve(a.online_info);try{for(d.s();!(s=d.n()).done;){var c=s.value,h={mutexType:c.mutex_type,customState:c.custom_state,state:c.state,extendInfo:c.extend_info};o.onlineInfo.push(h)}}catch(e){d.e(e)}finally{d.f()}n.push(o)}}catch(e){r.e(e)}finally{r.f()}var u={pageInfo:i,userInfo:n};se.trigger(F,W,u),this.cachedUserList=null}else se.trigger(F,B)}},{key:"invite",value:function(e){var t,i={business:"GS",id:14e3,seq_id:e.seqId,group_id:e.groupId,callee_info:[],extend_info:e.extendInfo},n=Ve(e.calleeInfo);try{for(n.s();!(t=n.n()).done;){var r=t.value;i.callee_info.push({user_id:r})}}catch(e){n.e(e)}finally{n.f()}i=this._dealMsg(i),y.websocket.send(JSON.stringify(i))}},{key:"replyInvite",value:function(e){var t={business:"GS",id:14003,seq_id:e.seqId,group_id:e.groupId,operate:e.operation,extend_info:e.extendInfo};t=this._dealMsg(t),y.websocket.send(JSON.stringify(t))}},{key:"cancelInvite",value:function(e){var t={business:"GS",id:14006,seq_id:e.seqId,group_id:e.groupId,callee_info:e.calleeInfo};t=this._dealMsg(t),y.websocket.send(JSON.stringify(t))}},{key:"onOnlineUsersNotify",value:function(e){e.result;var t={userId:e.user_id,mutexType:e.mutex_type,state:e.operation,customState:e.custom_state,extendInfo:e.extend_info};se.trigger("onOnlineUserState",t)}},{key:"onInviteRes",value:function(e){var t={seqId:e.seq_id,userId:e.user_id,result:e.result};se.trigger("onInviteReply",t)}},{key:"onNotifyInvite",value:function(e){var t={seqId:e.seq_id,groupId:e.group_id,userId:e.user_id,userName:e.user_name,extendInfo:e.extend_info};se.trigger("onCommingInvite",t)}},{key:"onNotifyIgnoreInvite",value:function(e){var t={groupId:e.group_id,userId:e.user_id,userName:e.user_name};se.trigger(J,t)}},{key:"onCancelInviteRes",value:function(e){var t=e.result,i={seqId:e.seq_id,userId:e.user_id};se.trigger(V,t,i)}},{key:"onNotifyCancelInvite",value:function(e){var t={seqId:e.seq_id,userId:e.user_id};se.trigger(z,t)}},{key:"_dealMsg",value:function(e,t){return t||(t=y.mainWebsocketChannelId),{id:102,channel_id:t,msg:JSON.stringify(e)}}}]),e}());var Xe,Ke,$e,Ze=new(function(){function e(){a()(this,e),y.msgDispatcher.addMsgHandler(11e3,this._onRecvUserMsg.bind(this)),y.msgDispatcher.addMsgHandler(11006,this._onRecvGroupMsg.bind(this)),y.msgDispatcher.addMsgHandler(11010,this._onRecvServerAck.bind(this))}return d()(e,[{key:"sendUserMsg",value:function(e){Fe.sendUserMsg(e)}},{key:"sendGroupMsgWithWhiteList",value:function(e){Fe.sendGroupMsgWithWhiteList(e)}},{key:"sendGroupMsgWithBlackList",value:function(e){Fe.sendGroupMsgWithBlackList(e)}},{key:"sendGroupMsg",value:function(e){Fe.sendGroupMsg(e)}},{key:"_onRecvUserMsg",value:function(e){se.trigger("onRecvUserMsg",{srcUserId:e.src_user_id,msg:e.msg,msgId:e.msg_id}),Fe.sendUserMsgAck(e)}},{key:"_onRecvGroupMsg",value:function(e){se.trigger("onRecvGroupMsg",{srcUserId:e.src_user_id,groupId:e.group_id,msg:e.msg,msgId:e.msg_id}),Fe.sendGroupMsgAck(e)}},{key:"_onRecvServerAck",value:function(e){}}]),e}());function Qe(){0}(Xe=Qe).prototype.subEvent=function(){console.log("Subscribe event: ",arguments[0]),se.on.apply(se,arguments)},Xe.prototype.unsubEvent=function(){console.log("Unsubscribe event: ",arguments[0]),se.off.apply(se,arguments)},(Ke=Qe).prototype.init=function(e){return Je.doInit(e),ae(A)},Ke.prototype.login=function(e){return Je.doLogin(e),ae(N)},Ke.prototype.joinGroup=function(e){return Je.doJoin(e),ae(U)},Ke.prototype.leaveGroup=function(){return Je.doLeave(),ae(L)},Ke.prototype.logout=function(){return Je.doLogout(),ae(j)},Ke.prototype.destroy=function(){Je.doDestroy()},($e=Qe).prototype.startPublishMedia=function(e,t,i){je.startPublishMedia(e,t,i)},$e.prototype.stopPublishMedia=function(e,t){je.stopPublishMedia(e,t)},$e.prototype.startReceiveMedia=function(e,t,i){return je.startReceiveMedia(e,t,i)},$e.prototype.stopReceiveMedia=function(e,t,i){return je.stopReceiveMedia(e,t,i)},$e.prototype.setMediaRender=function(e,t,i,n,r){je.setMediaRender(e,t,i,n,r)},$e.prototype.unsetMediaRender=function(e,t,i){je.unsetMediaRender(e,t,i)},$e.prototype.setSendMagicAudioValue=function(e){qe.setSendMagicAudioValue(e)},$e.prototype.setRecvMagicAudioMode=function(e){qe.setRecvMagicAudioMode(e)},$e.prototype.createWhiteBoard=function(e){return Be.createWhiteBoard(e)},$e.prototype.closeWhiteBoard=function(e){return Be.closeWhiteBoard(e)},$e.prototype.getWhiteBoard=function(e){return Be.getWhiteBoard(e)},$e.prototype.setWhiteBoardDisplayMode=function(e,t,i){return Be.setDisplayMode(e,t,i)},$e.prototype.rotateWhiteBoard=function(e,t){return Be.rotateWhiteBoard(e,t)},$e.prototype.switchWhiteBoard=function(e){return Be.switchWhiteBoard(e)},$e.prototype.switchWhiteBoardPage=function(e,t,i){return Be.switchWhiteBoardPage(e,t,i)},$e.prototype.startUpload=function(e){return Be.startUploadDoc(e)},function(e){e.prototype.getOnlineUsers=function(){return Ye.getOnlineUsers(),ae(F)},e.prototype.invite=function(e){return Ye.invite(e),ae(H)},e.prototype.replyInvite=function(e){Ye.replyInvite(e)},e.prototype.cancelInvite=function(e){return Ye.cancelInvite(e),ae(V)}}(Qe),function(e){e.prototype.MediaType={SCREEN_SHARE:0,AUDIO:1,VIDEO:2,TRANSPARENT_DATA:3,WHITE_BOARD:4},e.prototype.OnlineType={OFFLINE:0,ONLINE:1},e.prototype.DisplayMode={DBWZ:1,DBSY:2,DBSF:3}}(Qe),function(e){e.prototype.sendUserMsg=function(e){Ze.sendUserMsg(e)},e.prototype.sendGroupMsgWithWhiteList=function(e){Ze.sendGroupMsgWithWhiteList(e)},e.prototype.sendGroupMsgWithBlackList=function(e){Ze.sendGroupMsgWithBlackList(e)},e.prototype.sendGroupMsg=function(e){Ze.sendGroupMsg(e)}}(Qe);t.default=Qe}]).default;
//# sourceMappingURL=HstWxRtcEngine-2.1.0-private.js.map